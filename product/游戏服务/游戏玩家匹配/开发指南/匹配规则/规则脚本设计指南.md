本文为您介绍如何进行匹配规则脚本设计。

## 规则 JSON 结构
匹配规则脚本结构如下：
![](https://main.qcloudimg.com/raw/63e9f98b014b2973f8d45745dddebf38.png)

### 参数详解

#### version
版本说明，必填，当前版本仅支持"v1.0"。示例代码如下：
```json
"version": "v1.0"
```
#### playerAttributes

玩家属性数组，包含0 - 5组属性值，非必填。
- **参数说明**

| 参数    | 类型          | 必填 | 说明                                                         |
| ------- | ------------- | ---- | ------------------------------------------------------------ |
| name    | string        | 是   | 属性名称，与 [发起匹配](https://cloud.tencent.com/document/product/1294/49491) 接口中传入的属性名对应。数组内 name 不能重复，取值范围：a~z, A~Z, 0~9 |
| type    | string        | 是   | 属性类型。合法取值："number", "string"                       |
| default | number/string | 否   | 属性默认值，必须与type定义的类型保持一致。当玩家在发起匹配请求中没有传入该值时，将用默认值为玩家进行匹配运算。若没有定义默认值，则玩家必须在发起匹配时传入该属性的值 |

- **示例代码**
```json
"playerAttributes": [
		{
			"name": "skill",
			"type": "number",
			"default": 10
        },
        {
            "name": "gameMode",
			"type": "string",
			"default": "classic"
        }
	]
```

#### teams

一个完整匹配中的所有队伍类型，必填。当前版本中，所有队伍的玩家最大数量不超过40。
- **参数说明**

| 参数       | 类型        | 必填 | 说明                                                         |
| ---------- | ----------- | ---- | ------------------------------------------------------------ |
| name       | string      | 是   | 队伍类型名称。数组内 name 不能重复，取值范围：a~z, A~Z, 0~9  |
| maxPlayers | number      | 是   | 一个该类型队伍中的最大玩家数量                               |
| minPlayers | number      | 是   | 一个该类型队伍中的最小玩家数量                               |
| number     | number_list | 否   | <li>表示该类型的队伍数量 <li>number_list只能包含两个元素，合法格式为：[ MinTeamCount, MaxTeamCount ] <li>不填默认[1,1]，表示该类型队伍在一个完整的匹配中有且仅有1个 <li>当前版本中，MinTeamCount与MaxTeamCount必须相等，即暂不支持动态队伍数量 |

- **示例代码**
```json
"teams": [
		{
			"name": "soldier",
			"maxPlayers": 4,
			"minPlayers": 4,
			"number": [2,2]
		},
		{
			"name": "king",
			"maxPlayers": 4,
			"minPlayers": 4
		}
	]
```


#### rules

匹配规则数组，包含0-10条规则，非必填。当前版本匹配规则类型支持差值规则（distanceRule）、比较规则（comparisonRule）、延迟规则（latencyRule）。关于不同类型规则的详细介绍，请参考[规则类型说明]()。
- **参数说明**

| 参数              | 类型   | 必填 | 适用规则类型                 |
| ----------------- | ------ | ---- | ---------------------------- |
| name              | string | 是   | 所有类型                     |
| type              | string | 是   | 所有类型                     |
| description       | string | 否   | 所有类型                     |
| measurements      | -      | -    | distanceRule, comparisonRule |
| referenceValue    | -      | -    | distanceRule, comparisonRule |
| operation         | -      | -    | comparisonRule               |
| maxDistance       | -      | -    | distanceRule, latencyRule    |
| minDistance       | -      | -    | distanceRule                 |
| maxLatency        | -      | -    | latencyRule                  |
| distanceReference | -      | -    | latencyRule                  |
| partyAggregation  | string | 否   | 所有类型                     |

- **示例代码**
```json
 "rules": [{
        "name": "FairTeamSkill",
        "type": "distanceRule",
        "measurements": [ "avg(teams[*].players.playerAttributes[skill])" ],
        "referenceValue": "avg(flatten(teams[*].players.playerAttributes[skill]))",
        "maxDistance": 10
    }, {
        "name": "RedTeamSelection",
        "type": "comparisonRule",
        "operation": "=",
        "measurements": ["flatten(teams[red].players.playerAttributes[colour])"],
        "referenceValue": "red"
    }, {
        "name": "FastConnection",
        "type": "latencyRule",
        "maxLatency": 50
    }]
```

#### expansions

匹配规则扩展。可以配置按等待时间调整匹配规则中的限制。
包含0-5组扩展目标，每个目标下包含1-10组steps取值。
- **参数说明**
<table class="typical">
	<tbody>
	<tr>
		<th colspan="2">参数</th>
		<th>类型</th>
		<th>必填</th>
        <th>说明</th>
        <th>有效取值</th>
	</tr>
	<tr>
		<td colspan="2">target</td>
		<td>string</td>
		<td >是</td>
        <td >需要进行扩展的目标</td>
        <td ><li>队伍的minPlayers、maxPlayers<br> <li>distanceRule的minDistance、maxDistance <br> <li>latencyRule的maxLatency、maxDistance</td>
	</tr>
	<tr>
		<td rowspan="2" >steps</td>
		<td>waitTimeSeconds</td>
        <td>number</td>
        <td>是</td>
        <td>等待的时间跨度，单位秒</td>
        <td>number</td>
	</tr>
    	<tr>
		<td>value</td>
        <td>number</td>
        <td>是</td>
        <td>target等待waitTimeSeconds后的取值</td>
		<td>number</td>
	</tr>
</tbody></table>
- **示例代码**
```json
    "expansions": [{
        "target": "teams[soldier].minPlayers",
        "steps": [{
            "waitTimeSeconds": 5,
            "value": 6
        }, {
            "waitTimeSeconds": 15,
            "value": 4
        }]
    }, {
        "target": "rules[FastConnection].maxLatency",
        "steps": [{
            "waitTimeSeconds": 10,
            "value": 100
        }, {
            "waitTimeSeconds": 20,
            "value": 150
        }]
    }]
```

### 表达式说明

#### 运算符

| 运算符  | 输入                                   | 输出                    | 含义                                 |
| ------- | -------------------------------------- | ----------------------- | ------------------------------------ |
| avg     | List< number >、List< List<< number >> | number、 List< number > | 获取列表中数值的平均值               |
| flatten | List< List<< ? >>                      | List< ? >               | 将二维列表变成包含所有元素的一维列表 |



#### 表达式

| 表达式 | 含义 | 结果类型 | 表达式用法
|---------|---------|---------|---------|
| teams[soldier].maxPlayers | soldier类型队伍的最大玩家数参数 | number | <li> 用于配置expansions的target  | 
| teams[soldier].players.playerAttributes[xxx] | soldier类型队伍的玩家xxx属性列表 | List< List<< ? >>  |  <li> 用于配置rules的measurements <br> <li> 用于配置rules的referenceValue | 
| teams[*].players.playerAttributes[xxx] | 所有类型队伍的玩家xxx属性列表 |  List< List<< ? >> | <li> 用于配置rules的measurements <br> <li> 用于配置rules的referenceValue | 
| teams[soldier].players[playerId] | soldier类型队伍的玩家ID列表 | List< List<< string >>  | <li> 用于配置comparisonRule类型rules的measurements  | 
| rules[FairTeamSkill].maxDistance | FairTeamSkill规则的maxDistanc参数 | number  | <li> 用于配置expansions的target |
