分布式HTAP数据库 TBase（TencentDB for TBase，TBase）是腾讯自主研发的分布式数据库系统。TBase 集高扩展性、高 SQL 兼容度、完整的分布式事务支持、多级容灾能力及多维度资源隔离等能力于一身，采用无共享的集群架构，提供容灾、备份、恢复、监控、安全、审计等全套解决方案，适用于GB - PB级的海量 HTAP 场景。


## 数据安全保障能力
### 数据加密
TBase 提供两种数据加密方式：
- 业务侧加密：业务调用 TBase 内置的加密函数，将加密结果写入数据库，正常读取的也是加密后的数据，然后在应用里面执行解密。
- TBase 内置加密：加密过程对业务侧透明。优点如下：
 - 加密操作（函数调用）与业务侧解耦合，业务只负责写入原始数据到数据库内核，后续的加密计算在数据库内部完成，从而业务侧操作上无感知。
 - 加密算法由数据库维护，包括加密算法的选择、密钥管理，都由安全员独立操作完成。
  TBase 内核加密计算支持异步加密，保证系统在吞吐不变的情况下，达成数据加密。支持的加密算法有 AES128、AES192、AES256、国密SM4。
同时 TBase 提供透明数据脱敏功能，在用户无感知的情况下，对非授权用户返回被脱敏的数据。
从以上两个维度实现更细粒度的数据访问控制，增强对现有访问的控制，且对现有业务系统无感知。

### 全方位审计
TBase 从多个维度提供全方位的审计能力，审计采用旁路检测方式，对数据库运行影响极小。审计类型如下：
- 语句审计：针对某一种特定的语句进行审计。
- 对象审计：针对某个数据库对象的操作进行审计。
- 用户审计：针对某个数据库用户的操作进行审计。
- 细粒度审计（Fine-Grained Audit，FGA）：高级审计选项，使用表达式来作为审计条件，可设置审计被触发时的动作，例如发邮件打电话等。	

## 数据治理能力
数据治理包括数据倾斜的治理和冷热数据分级存储。数据倾斜的治理用以解决数据分布不均带来的存储及性能压力，冷热数据分级存储用以降低业务的存储成本、提升热数据的性能。

### 数据倾斜治理
该方案首先把系统的 DN 分为 group，每个 group 里面包含一个或者多个 DN；每个 group 有一个 shardmap；建 sharded 表时，可以指定存储的 group；CN 可以访问所有的 group，且 CN 上存储所有表的访问方式信息。

对于系统中数据量较大的用户进行特别识别，并为其创建白名单，使用不同的数据分布逻辑：
- 普通用户使用默认的数据分布逻辑，即 Shardid = Hash(merchantid) % #shardmap
- 大用户使用定制的数据分布逻辑，即 Shardid = Hash(merchantid) % #shardmap + fcreate_time dayoffset from 1970-01-01
通过在大用户 group 分布逻辑中加入日期偏移，来实现同一个用户的数据在 group 内部多个节点间均匀分布，从而有效解决数据分布不均匀问题。

### 冷热数据分离
内核原生态支持数据的冷热分离，业务无需感知底层存储介质的不同，对外提供统一的数据库视图。
- 冷热数据使用不同的节点 group 存储，节点组内部使用的物理机型配置不同，从而达到冷热分离节省成本的目的。
- 后台定时任务根据用户配置的冷热数据规则，自动进行数据迁移。通过上面的逻辑结构，系统即可实现自动的冷热分离，业务无需关心集群的冷热数据存储情况。
