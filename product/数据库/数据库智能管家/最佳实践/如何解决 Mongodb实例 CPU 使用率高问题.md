# 如何解决 mongodb实例 CPU 使用率高问题

## 问题描述

在日常运维中，mongodb数据库，如果 CPU 利用率过高，通常容易导致系统异常。例如：“读写速率变慢、链接耗光、超时增加等”，大量的访问超时还会触发客户端反复重连认证，最终可能会引起数据库“雪崩”。生产中的mongodb数据库，出现CPU 利用率过高场景，是很常见的，这种问题一般由SQL异常、流量过高、产生内存排序、语句无索引、或索引使用不当等情况导致。

当数据库执行查询、修改等操作时，CPU 会先从存储引擎cache中请求数据：

·    如果引擎cache中存在对应的数据，CPU 执行计算任务后会将结果返回给用户，与此同时，还可能涉及到排序类高消耗 CPU 的动作。

·    如果内存中不存在对应的数据，还会触发从磁盘获取数据的动作。

这两个数据获取过程分别称为逻辑读和物理读。因此，性能较低的 SQL，在执行时容易让数据库产生大量的逻辑读，从而导致 CPU 利用率过高，也可能让数据库产生大量的物理读，从而导致 IOPS 和 I/O 时延过高。

## 解决方案

使用数据库智能管家DBbrain，从异常诊断，可定位CPU过高的异常问题，可确定问题发生时间，确定造成问题的具体SQL，还能给您对应的处理措施；在解决问题的同事，结合慢SQL优化功能 ，通过语句优化分析建议，可帮您精准分析语句情况，避免类似问题再次产生。

·    异常诊断：7 * 24小时异常发现诊断，提供实时优化建议。

·    慢 SQL 分析：针对当前实例出现的慢 SQL 进行分析，并给出慢 SQL 的优化建议。

·    实时会话：查看当前生产库中正在执行中的操作，可针对异常操作做处理。

### 方式一：使用“异常诊断”功能排查数据库异常情况（推荐）

异常诊断功能提供故障主动定位和优化，不需要任何数据库运维经验，不仅能发现 CPU 利用率过高的异常情况，经过多年mongodb运维专家经验沉淀，结合机器学习、大数据与智能分析算法的运用，快速复制资深数据库专家经验，赋能您的数据库，智能运维mongodb数据库，几乎可以实时发现mongodb生产数据库中所有的异常与故障问题。

操作步骤及示例如下：

1. 登录[DBbrain 控制台](https://console.cloud.tencent.com/dbbrain/slow-sql)，在左侧导航选择【诊断优化】，在上方选择【异常诊断】页。

   ![](https://qcloudimg.tencent-cloud.cn/raw/0609d4a2aa8b2bc58ad2af28aaf7f130.png)

2. 在左上角选择实例 ID（可输入和搜索），切换至目标实例。

3. 在页面中选择“实时”或“历史”要查询的时间，若该时间段内存在故障，可在右侧的“诊断提示”中查看到概要信息。

4. 单击“实时/历史诊断”栏的【查看详情】或“诊断提示”栏的诊断项可进入诊断详情页。

- 事件概要：包括诊断项、起止时间、风险等级、持续时长、概要等信息。
- 现象描述：异常事件（或健康巡检事件）的外在表现现象的快照和性能趋势。
- 智能分析：分析导致性能异常的根本原因，定位具体操作。
- 优化建议：提供优化指导建议。

5. 选择【优化建议】页，即可查看 DBbrain 针对该故障给出的优化建议。

![](https://qcloudimg.tencent-cloud.cn/raw/829edf685818d0b8bef24fee0b4493bd.png)

### 方式二：使用“慢 SQL 分析”功能排查导致 CPU 利用率过高的库表信息

1. 登录[DBbrain 控制台](https://console.cloud.tencent.com/dbbrain/slow-sql)，在左侧导航选择【诊断优化】，在上方选择【慢 SQL 分析】页。

2. 在左上角选择实例 ID（可输入和搜索），切换至目标实例。

3. 在页面中选择要查询的时间，若此实例在该时间段中有慢 SQL，SQL 统计会以柱形图的方式展示慢 SQL 产生的时间点和个数。
    单击柱形图，下方的列表会显示对应的所有慢 SQL 信息（模板聚合之后的 SQL），右方会显示该时间段内 SQL 的耗时分布。

![](https://qcloudimg.tencent-cloud.cn/raw/bd0e90c785bbe5828937cd3f321b2dde.png)



4. 针对 SQL 列表中 SQL 执行的数据进行判断和筛选，下面简单介绍一种判断方式：

-  先按照平均耗时（或者最大耗时）降序，重点关注耗时较大的 SQL，不推荐使用总耗时，容易受到执行次数多而累加的干扰。
-  然后关注返回行数和扫描行数的值。

- §  若发现“返回行数”与“扫描行数”值相等的 SQL，大概率是全表查找并返回了。
- §  若发现几行 SQL 都有很多扫描行数，但返回行数都为0或特别小，说明系统产生了大量的逻辑读和物理读。当查找的数据量过大且内存不足时，该请求必然会产生大量的物理 I/O 请求，导致 I/O 资源大量消耗；大量的逻辑读便会占用大量的 CPU 资源，导致 CPU 利用率过高。

### 方式三：使用“实时会话”功能kill扫表慢查

Mongodb内核会记录当前正在执行得currentOp信息，DBbrain的”实时会话”功能，可以看到数据库正在执行中的所有操作，并且支持kill指定会话，可以把耗时SQL直接kill掉来释放CPU、磁盘IO等资源。另外还提供持续kill功能，可以根据条件或信息，持续Kill会话，再数据库产生堵塞的异常情况下，您可以使用持续Kill功能，紧急做异常处理。

-  获取会话信息，kill会话
  - 根据诊断优化-》实时会话-》活跃会话，选择需要kill的会话信息，然后执行kill操作

![](https://qcloudimg.tencent-cloud.cn/raw/6938bf7ff8ce9ce8648aca692cfce3c1.png)

- 持续 Kill 会话
  - “持续kill会话”功能可以针对DB、HOST、Type、TIME等维度进行配置，两个触发机制“超时自动退出”和“手动关闭”：
  
    ![](https://qcloudimg.tencent-cloud.cn/raw/a9dedb813578bf847548e311e1b824f1.png)
  
  - 如需停止持续kill会话，则点击方框”停止”按钮，即可提前关闭未到超时时间的定时任务，或终止手动触发的任务。

![](https://qcloudimg.tencent-cloud.cn/raw/485d87eff0f87ed27bef0c9178e1f46f.png)
