# Mongodb节点oplog 保存时间太短 

## 问题描述

Mongodb副本集结构中，从节点会保存从主节点同步过来的数据日志，这种方式和mysql数据库的bin-log主从复制的方式类似，mongodb采用的是根据oplog来从主节点同步数据到从节点。但是oplog不是无限大，超过其配置大小，oplog会被覆盖。再日常运维场景中，当从库发生故障时。主节点扔正常运行，还不会影响整个副本集运行状态，但如果我们重新启动从节点，那么从节点需要从主节点上恢复数据，这时，如果oplog被覆盖，从节点需要恢复的数据就会有遗漏，中间被覆盖的数据就丢了，这种情况下，从节点无法恢复正常。另外一些情况下，数据库重启、主从延迟高都可能会出现oplog不够用的情况。

## 解决方案

使用数据库智能管家DBbrain，可帮您7*24小时，实时观察生产所有节点oplog 保存问题相关的风险项。从而避免此类故障产生。

### 使用“异常诊断”功能排查数据库异常情况（推荐）

异常诊断功能提供故障主动定位和优化，不需要任何数据库运维经验，不仅能发现 CPU 利用率过高的异常情况，经过多年mongodb运维专家经验沉淀，结合机器学习、大数据与智能分析算法的运用，快速复制资深数据库专家经验，赋能您的数据库，智能运维mongodb数据库，几乎可以实时发现mongodb生产数据库中所有的异常与故障问题。

操作步骤及示例如下：

1. 登录[DBbrain 控制台](https://console.cloud.tencent.com/dbbrain/slow-sql)，在左侧导航选择【诊断优化】，在上方选择【异常诊断】页。

2. 概览卡片中，呈现黄色标记，告知此时间点发现异常风险项。

3. 右侧的“诊断详情”列表中，同时出现oplog 保存时间太短的风险项


![](https://qcloudimg.tencent-cloud.cn/raw/079dc70de159e578b9864b6cccc88ca6.png)

4.点击该风险项查看，可进一步获得更详细的异常信息。

   优化建议会根据当前情况给出合理的处理措施。

![](https://qcloudimg.tencent-cloud.cn/raw/53bb8aa992f0b7d653b9d7bf80f57418.png)
