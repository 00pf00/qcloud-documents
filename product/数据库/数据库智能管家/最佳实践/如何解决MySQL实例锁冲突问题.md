## 问题描述
锁冲突问题一直是 MySQL 数据库业务经常遇到的问题，锁冲突问题在不同场景下表现也大不相同，有的情况下可能会直接导致业务瘫痪，而有的情况下业务侧可能很难感知，事后可能会出现数据错乱等情况。
锁冲突场景的多样性、复杂性以及隐秘性决定了要解决这一类问题对数据库管理员的技术和能力要求极高，同时处理锁冲突故障的时效性也会大打折扣。

数据库智能管家 DBbrain 提供的异常诊断功能，包含了数十个锁相关诊断项，涵盖了死锁、等待行锁、出现表锁、只读锁、DDL/select/DML等待锁、SQL 等待 MDL 锁等多个锁冲突场景。其能够高效、便捷、专业化的帮助用户解决锁冲突的问题。
本文以常见的“死锁”和“等待行锁”为案例，介绍如何使用 DBbrain 解决锁冲突问题。

## 解决方案
### 场景一：解决数据库出现“等待行锁”的场景
操作步骤及示例如下：
1、可以通过以下两种方式查看实例存在的“锁冲突”事件
①登录 DBbrain 控制台，在左侧导航选择【实例管理】，选择【异常告警】选项卡页。
	选择需要查看的时间范围
	在诊断项列，按“等待行锁”进行过滤
	查看所有实例出现“等待行锁”的事件列表，可点击详情查看具体内容。
 
   ②登录 DBbrain 控制台，在左侧导航选择【诊断优化】，进入“异常诊断”页面
	在左上角的“实例ID”找中，选择需要查看的MySQL实例
	选择实时（默认动态更新）或历史（可自定义）时间段
	查看“诊断提示”中是否存在“等待行锁”的事件，点击查看详情
 

2、查看“现场描述”可直观了解出现“等待行锁”事件时，数据库中语句的运行情况
 
3、切换选项卡，查看“智能分析”页
   ①查看出现“等待行锁”事件的原因
   ②分析结果中，清晰显示被阻塞的事务/语句情况，比如下图中的delete语句，处于LOCK WAIT状态。
 

③根据持有锁事务结果，可快速定位目前持有行锁的事务id以及当前状态
 
④性能监控曲线可直观展示出等待行锁次数的趋势
 

4、查看“专家建议”页，可根据提示解决锁冲突问题。比如，通过使用kill命令，中止会话3965158来释放锁，解决本案例中的锁冲突问题。
 

### 场景二：解决数据库出现“死锁”的场景
说明：由于MySQL具有死锁监测和自动事务回滚的能力，故大多数“死锁”场景可自愈，业务无感知，但由于业务逻辑不够健壮或极端情况下也会导致系统雪崩以及数据不一致等后果，故对于出现死锁的情况也需足够重视。

操作步骤及示例如下：
1、可以通过以下两种方式查看实例存在的“锁冲突”事件
①登录 DBbrain 控制台，在左侧导航选择【实例管理】，选择【异常告警】选项卡页。
	选择需要查看的时间范围
	在诊断项列，按“死锁”进行过滤
	查看所有实例出现“死锁”的事件列表，可点击详情查看具体内容。
 
 ②登录 DBbrain 控制台，在左侧导航选择【诊断优化】，进入“异常诊断”页面
	在左上角的“实例ID”找中，选择需要查看的MySQL实例
	选择实时（默认动态更新）或历史（可自定义）时间段
	查看“诊断提示”中是否存在“死锁”的事件，点击查看详情
 

2、查看“现场描述”，可重点关注如下信息：
	发生时间以及来源Ip,便于溯源
	发生死锁的两条SQL语，比如下面的两条insert into 语句
	根据Status字段状态，判断哪条语句回滚(Rollback)，哪条正常执行（Normal）。
	（可选）根据LockRequest、LockHold信息分析具体锁的持有和类型

 

