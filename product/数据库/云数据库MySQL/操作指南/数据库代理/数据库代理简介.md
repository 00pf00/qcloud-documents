本文主要介绍云数据库 MySQL 数据库代理服务的特性、适用场景、自动读写分离、Hint 语法使用。

## 数据库代理简介
数据库代理是位于云数据库服务和应用服务之间的网络代理服务，用于代理应用服务访问数据库时的所有请求。
数据库代理访问地址独立于原有的数据库访问地址，通过数据库代理地址的请求全部通过代理集群中转访问数据库的主从节点，进行读写分离，将读请求转发至只读实例，降低主库的负载。

### 数据库代理特性
- **高稳定性**
采用集群架构部署，多节点保证故障评估转移。
- **强隔离性**
数据库代理使用独立资源为当前实例提供代理服务（各代理资源独立，不共享资源）。
- **超高性能**
每个代理每秒最高可以处理10万左右的请求。
- **扩容方便快捷**
支持1个 - 60个代理节点动态扩展（公测期间仅支持6个节点）。
- 完备的性能监控
提供了读/写请求数、CPU、内存等性能指标的秒级监控，可以根据 [监控数据](https://cloud.tencent.com/document/product/236/54656) 及业务规划调整代理个数。
- **热加载**
主实例发生切换、变配、只读实例增减等情况，数据库代理可动态热加载配置，不会出现网络中断或重启。
- **支持 [自动读写分离](https://cloud.tencent.com/document/product/236/54655)**
通过开启数据库代理的读写分离功能，可以有效降低主实例的读负载，通过添加只读实例来提供数据库集群的水平扩展能力，并且可以帮助用户实现自助读写分离，避免用户自行拆分业务读写请求的复杂度，尤其适合大量读负载的情况。
例如，开通数据库代理的读写分离功能后，应用程序中只需配置一个代理连接地址，该地址会自动实现读写分离，将读请求发送至只读实例，将写请求发送至主实例。即使增加或删除只读实例，也无需调整应用程序的设置。

### 适用场景
- 大量短连接为主的业务，性能不足。
- 业务使用多个只读实例，在应用程序侧手动读写分离，维护成本和风险较高。
- 连接数过多导致实例负载过高。

## 费用说明
数据库代理目前处于公测阶段，暂时免费使用。

## 注意事项
- 使用代理连接地址进行读写分离时，不保证非事务读的一致性，业务上有读一致性需求可以封装到事务中，或者使用 Hint 语法。
- 使用代理连接地址时，show processlist 会将所有节点的结果合并后返回。
- 对于 prepare 语句，数据库代理会先将 prepare 发送到所有节点，当后续的 execute 请求到来时，根据 prepare 的语句类型来决定 execute 的路由。如 prepare 了一个写语句，execute 时会发到主库，而如果 prepare 的是事务外的读语句，则会发送到只读实例。
- 业务连接到达数据库代理后，代理会连接到主实例和所有配置的只读实例，数据库代理本身并没有最大连接数的限制，连接数的限制主要由后端数据库实例的最大连接数决定（主实例和只读实例最大连接数的最小值会影响业务性能）。
- 开启数据库代理后，新增只读实例或只读实例重启，只有新的连接的请求才会路由到新的只读实例或重启的只读实例，可以通过概览或 [性能监控](https://cloud.tencent.com/document/product/236/54656) 查看各代理节点的性能指标，若发现各代理节点连接数不均衡的现象，可通过重新负载均衡打散连接。

## [自动读写分离](id:zddxfl)
目前大量现网用户业务场景中存在读多写少、业务负载无法预测等场景，但有大量读请求的应用场景下，单个实例可能无法承受读取压力，甚至对业务产生影响。为了实现读取能力的弹性扩展，分担数据库压力，可以创建一个或多个只读实例，利用只读实例满足大量的数据库读取需求。但此类解决方案需要需要业务侧支持读写分离改造，其代码的健壮性决定了业务读写分离的质量，对客户的技术要求较高，而且灵活性和可扩展性较差。

故创建只读实例后，可以通过购买数据库代理开启读写分离功能，在应用程序中配置数据库代理地址，就可以使写请求自动转发到主实例，读请求自动转发到各个只读实例。除此之外也能为其他其他业务痛点提供天然的解决方案，具体如下：
- **具有无法预测的工作负载的应用程序**
支持高度可变工作负载的应用程序可能会尝试打开新的数据库连接突发。数据库专属代理的连接管理使客户可以通过有效地重用数据库连接，来适当地扩展处理不可预测的工作负载的应用程序。
首先，使多个应用程序连接可以共享数据库连接，以有效利用数据库资源。其次，允许客户通过调节打开的数据库连接数来保持可预测的数据库性能。第三，可删除无法使用的应用程序请求，以保留应用程序的整体性能和可用性。

- **经常打开和关闭数据库连接的应用程序**
基于无服务器、PHP 或 Ruby on Rails 等技术构建的应用程序，可能会频繁打开和关闭数据库连接来满足应用程序请求。
数据库专属代理可以帮助客户维护数据库连接池，以避免对数据库计算和用于建立新连接的内存造成不必要的压力。

- **使连接保持打开状态但处于空闲状态的应用程序**
SaaS 或电子商务行业中的传统应用程序可能会使数据库连接保持空闲状态，以最大程度地减少客户重新参与时的响应时间。客户可以使用数据库专属代理代理来保留空闲连接，而仅根据需要建立数据库连接服务于活动请求，而不是为支持大多数空闲连接而过度提调大阈值或提供更高配的数据库。

- **构建高度平滑故障转移的应用程序**
使用数据库专属代理，用户可以构建可透明容忍数据库故障转移（主动/被动）的应用程序，而无需编写复杂的故障处理代码。数据库专属代理自动将读流量路由到新的数据库实例，同时保留应用程序连接。

![](https://main.qcloudimg.com/raw/a5f23e2235bc918b1a7e816c8f2c947b.png)

### 功能优势
- 自助读写分离，统一访问地址。
- 原生链路支持，提升性能，减少维护成本。
- 可设权重和阈值，可供用户灵活选择。
- 具备故障转移能力，即使数据库代理故障请求也能正常访问主库。
- 主实例发生切换、变配、只读实例增减等情况，数据库代理可动态热加载配置，不会出现网络中断或重启。

### 读写分离路由规则
#### 发送到主实例
- CREATE、ALTER、DROP、RENAME 等 DDL 语句。
- INSERT、UPDATE、DELETE 等 DML 语句。
- SELECT FOR UPDATE 语句。
- 临时表相关语句。
- 部分系统函数调用（如 last_insert_id()）以及所有自定义函数调用。
- LOCK 相关语句。
- 开启事务后的语句（包括 set autocommit=0）。
- 存储过程。
- 用“;”连接的多语句。
- KILL（SQL 语句中的 KILL，非命令 KILL）。
- 所有对用户变量的查询和更改。

#### 发送到只读实例
- 事务外的读（SELECT）语句。

#### 发送到到所有实例
- show processlist 语句。
- 所有系统变量的更改（SET 命令）。
- USE 命令。

## Hint 语法使用
使用 Hint 语法可以强制 SQL 请求在指定的实例上执行，Hint 的路由优先级最高，例如，Hint 不受一致性、事务的约束，使用前请合理评估业务场景是否需要。
>!使用 MySQL 命令行进行连接并使用 Hint 语句时，需要在命令中增加 -c 选项，否则 Hint 会被 MySQL 命令行工具过滤。
>
目前支持三种 Hint：
- 指定到主实例执行：
```
/* to master */
/*FORCE_MASTER*/   
```  
- 指定到到只读实例执行：
```
/* to slave */
/*FORCE_SLAVE*/  
```  
- 指定某个具体实例执行：
```
/* to server server_name*/
```
server_name 可以为短 id，如 `/* to server test_ro_1 */`。

