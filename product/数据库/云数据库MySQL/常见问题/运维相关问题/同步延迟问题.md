## 延迟介绍
云数据库 MySQL 对应的默认备库、灾备实例、只读实例均采用 MySQL 原生 binlog 复制技术，当数据复制方式为异步复制或半同步复制时，都有可能发生延迟。当出现数据延迟时，会导致默认备库、灾备实例、只读实例与主实例的数据不一致，进而影响业务的连续性、可靠性及数据一致性。

### 灾备实例
- 默认备库
[高可用版 MySQL](https://cloud.tencent.com/document/product/236/17136#.E9.AB.98.E5.8F.AF.E7.94.A8.E7.89.88) 默认为一主一从架构，提供宕机自动检测和故障自动转移，而主备切换策略默认为可靠性优先，当主实例出现故障时，而备库因延迟导致主备无法在短时间内完成切换，进而影响业务无法在短时间内恢复正常。
- 灾备实例
针对业务连续服务和数据可靠性有强需求或是监管需要的场景，云数据库 MySQL 提供 [跨地域灾备实例](https://cloud.tencent.com/document/product/236/7272)，帮助用户以较低成本提升业务连续服务能力，同时提升数据可靠性。当主实例及对应备库均不可用时，可以将灾备实例提升为主并对外提供使用，可有效的保障业务的连续性。若灾备实例存在延迟，在堆积的 binlog 未应用完之前，灾备实例将无法顺利提升为主实例，在此期间业务的连续性会因此受到影响。

### 只读实例
[只读实例](https://cloud.tencent.com/document/product/236/7270) 常用于分担主实例的查询压力或者用于分析类的应用场景，避免复杂、统计类查询影响主实例的整体性能。
只读实例为单节点架构，若需要更高的可用性，[只读组](https://cloud.tencent.com/document/product/236/7270) 提供负载均衡、故障自动转移的能力，可为只读组添加2个及以上的只读实例，若其中一个只读实例故障，读流量会自动转移到可用的只读实例。若读业务对数据一致性有较高要求，只读组可以设置延迟剔除策略，当只读实例与主实例延迟时间超过阈值，对应的只读实例会自动被剔除，避免只读实例因延迟策略被剔除导致读流量无法正常访问数据库，建议做好实例延迟监控并及时处理导致主从延迟的相关问题。

## 查看同步延迟
### 默认备库
1. 登录 [云数据库 MySQL 控制台](https://console.cloud.tencent.com/cdb)，选择所需实例，在实例管理页中选择【实例监控】>【部署监控】页。
2. 查看**备机**的【主从延迟时间】监控，如默认备库与主实例存在同步延迟，监控数据会大于0。
>?默认备库，主要用于故障切换，提升数据库的高可用性，不对外提供使用。
>
![](https://main.qcloudimg.com/raw/4105191c0523cd4ebd194298f91e7a3f.png)

### 灾备实例和只读实例
1. 在实例列表选择主实例对应的灾备实例或只读实例，在实例管理页中选择【实例监控】>【部署监控】页。
2. 查看**主机**的【主从延迟时间】监控，如与主实例存在同步延迟，监控数据会大于0。
>?
>- 灾备实例对应主机的主从延迟时间表示与主实例之间的数据延迟，备机的主从延迟时间表示灾备实例与其默认备库之间的数据延迟。
>- 只读实例对应主机的主从延迟时间表示与主实例之间的数据延迟。
>
![](https://main.qcloudimg.com/raw/a262e988085c1a4818be410cd4d60caa.png)


## 延迟原因及解决方案
避免出现同步延迟，建议对数据库所有表创建主键或二级索引、将大事务拆分为多个小事务、业务低峰期执行 DDL 操作、根据只读实例、灾备实例的业务负载配置合理的规格（至少大于主实例规格）。

### 无主键或二级索引
**原因**
若 binlog 为 row 格式且表无主键或二级索引，当对大表进行 DML 操作（例如 delete、update、insert）时，在从库进行 binlog 日志应用时，会根据主键或者二级索引来检索需要更改的行，如对应表未创建主键或者二级索引，会产生大量的全表扫描进而降低了日志应用速度，从而产生了数据延迟。

**解决方案**
- 为所有表创建主键，若表无法创建主键，建议选择基数高的列创建二级索引。
- 建议采用 truncate 命令删除表所有记录。

### 大事务
**原因**
在主实例执行大数据量的 DML 操作，大量的 binlog 日志传送到从库时，从库需要花费与主实例相同的时间来完成相应事务，进而导致了从库出现数据延迟。

**解决方案**
建议将大事务拆分为小事务，通过 where 条件限制每次要处理的数据量，有助于从库迅速完成事务的执行，进而避免出现从库数据的延迟。

### DDL 操作
**原因**
与大事务原理类似，若 DDL 操作在主实例的执行时间很长，在从库也会花费同样甚至更长时间来执行该操作，进而阻塞了 DDL 操作。

**解决方案**
建议在业务低峰期执行 DDL 操作。若因灾备实例、只读实例的查询业务而阻塞了 DDL 操作，建议直接 KILL 掉引起阻塞的会话来恢复主从数据的同步。

### 实例规格过小
**原因**
只读实例、灾备实例的规格小于主实例且负载较高，会导致只读实例、灾备实例的数据延迟。

**解决方案**
建议只读实例、灾备实例的规格大于等于主实例，如果只读实例、灾备实例承载了大量的分析类业务导致其实例负载过高，需将其实例规格升级至合适的配置或者对其性能低效的 SQL 进行优化。
