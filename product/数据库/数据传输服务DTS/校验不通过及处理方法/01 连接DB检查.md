# 连接DB检查

## 检查详情

源数据库和目标数据库需要能正常连通，如果未连通，会报”连接源实例失败“。

## 问题原因

-   源数据库所在网络或服务器设置了安全组或防火墙
-   数据库账号或密码不正确
-   源数据库对来源IP地址进行了限制

## 源数据库所在网络或服务器设置了安全组或者防火墙

**检测方法**

安全组功能与防火墙功能类似，安全组是针对云上数据库的网络安全设置。

请根据现场情况，进行以下检查步骤：

- 查看源数据库所在的服务器是否配置了防火墙策略：
  
  - Windows系统，打开控制面板找到Windows防火墙，查看是否配置了防火墙策略。
  - Linux系统，请执行`iptables -L`命令，检查服务器是否配置了防火墙策略。
- 查看数据库配置的安全组是否限制了DTS的IP地址段。

  1. 登录对应的数据库，在实例列表中，单击实例ID，进入实例管理页面。

  2. 在实例管理页面，选择【安全组】页，查看是否存在禁止DTS的SNAT IP地址段的策略。
     ![](https://main.qcloudimg.com/raw/9ca243d120eba0f8014e8019ffc31fba.png)

**修复方法**

请根据现场情况，选择以下对应的步骤：

-   服务器开启了防火墙

  1. 关闭服务器的防火墙，然后登录重新执行校验任务。

  ​     *说明：该方法Windows和Linux系统都适用。*

  2. 将DTS的IP地址段【策略】配置为【允许】。

-   安全组的配置限制了DTS的SNAT IP地址段。 
    
    1. 在【安全组】页面，点击对应的安全组ID。
        ![](https://main.qcloudimg.com/raw/07bb026fca51a1356df8138349e3c7c9.png)
    2. 修改DTS的IP地址段的策略，配置为【允许】。
        ![](https://main.qcloudimg.com/raw/55c84b84e8eea7b8a116ecc2ff1754ea.png)

## 数据库账号或密码不正确

**检测方法**

可以选择如下任一方式进行检测。

- 登录源数据库，验证账号和密码是否正确。
- 选择一台可以连接源数据库的设备，使用源数据库的账号和密码连接源数据库，验证账号和密码是否正确。

**修复方法**

在[DTS控制台](https://console.cloud.tencent.com/dts/migration?rid=8&page=1&pagesize=20)修改数据迁移任务，输入正确的数据库账号和密码后重新执行校验任务。

## 源数据库对来源IP地址进行了限制 
**检测方法**

-   在源数据库部署的服务器上，使用数据迁移任务中填入的数据库账号和数据库密码连接源数据库。如果连接正常，说明源数据库可能限制了来源IP地址。
    
-   如果是自建数据库，需要在数据库上确认bind-address的配置，如果不是0.0.0.0，则IP受限。

-   如果源数据库为MySQL，您可以使用MySQL客户端连接源数据库，执行以下SQL语句进行检查，检查输出结果中的授权IP地址列表中是否包含DTS的SNAT IP地址。

    在给用户进行数据库的授权时，授权的IP中需要包含SNAT IP，否则会发生IP受限问题。举例如下：
    
    ```
    root@10.0.0.0/8  //授权用户通过指定10.0.0.0/8访问，其他IP会受限（错误配置）。
    root@%           //授权用户访问所有的IP吗，其中需要包含SNAT IP（正确配置）。
    ```
    
    您可以通过如下方法验证。
    
    ```
    select host,user,authentication_string,password_expired,account_locked from
    mysql.user WHERE user='[\$Username]';   //[\$Username]为数据迁移任务中填写的数据库账号。
    ```
    
- 如果源数据库为SQL Server，检查源数据库中是否有Endpoint或Trigger限制了访问来源IP地址。


**修复方法**

1. 根据数据库类型的不同，选择以下对应的修复方法进行修复： 

   - 源数据库为MySQL，请在源数据库中执行以下SQL语句，重新给数据迁移使用的用户授权。

     ```
     mysql> grant all privileges on . to '[\$UserName]'@'%';  //[\$Username]为数据迁移任务中填写的数据库账号。
     mysql> flush privileges;
     ```

   -   源数据库为SQL Server，关闭防火墙或禁用trigger。

2. 对于自建数据库，如果bind-address配置异常，请参考如下指导修改。

   2.1. 在`/etc/my.cnf`文件中增加如下内容。

    *注：`my.cnf`配置文件的默认路径为`/etc/my.cnf`，现场以实际情况为准。*

      ```
   bind-address=0.0.0.0 #全部地址或者指定的IP地址
      ```

   2.2. 重启数据库。
   
      ```
   service mysqld restart
      ```
   2.3. 验证配置是否生效。
      ```
   netstat -tln
      ```
3. 重新执行校验任务。