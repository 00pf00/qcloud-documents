## 一、小直播是什么？
小直播 App 是一套开源的、完整的在线直播解决方案，它基于云直播服务、即时通信（IM）构建，并使用云函数（Serverless）提供标准的后台服务，可以实现登录、注册、开播、房间列表、连麦互动、文字互动和弹幕消息等功能。
<img src="https://qcloudimg.tencent-cloud.cn/raw/f7caa1834fb98f02f72da3721fe0102f.png" width="1080">

## 二、前后端架构说明
<img src="https://qcloudimg.tencent-cloud.cn/raw/639d7dd2121d4c606ea23128bbd462e8.png" width="960">

## 三、快速搭建自己的“小直播”

### 3.1 开通云直播相关服务
[](id:step_3.1.1)
#### step 3.1.1  开通云直播服务
登录腾讯云官网，进入 [云直播管理控制台](https://console.cloud.tencent.com/live)，如果服务还没有开通，单击【申请开通】。

[](id:step_3.1.2)
#### step 3.1.2  获取 SDK 的测试 License
<img src="https://qcloudimg.tencent-cloud.cn/raw/de170495796448068856b59f34a5ef8f.png" width="800">

单击进入 [云直播管理控制台 - License管理页](https://console.cloud.tencent.com/live/license) 页面，创建应用所需要的鉴权License，创建成功后请**记录 Key 和 LicenseUrl**，便于在 运行小直播App时使用。
<img src="https://qcloudimg.tencent-cloud.cn/raw/68830e21df91deee5cdbb55471eb647b.png" width="800">
>? **Package Name** 为 Android 的包名，**Bundle Id** 为 iOS 的 Bundle Id。


[](id:step_3.1.3)
#### step 3.1.3  创建TRTC应用
 登录[实时音视频控制台](https://console.cloud.tencent.com/trtc)，选择【[应用管理](https://console.cloud.tencent.com/trtc/app)】，单击【新建应用】输入应用名称，例如 `XiaoZhiBo`；点击`应用信息`后：
 - 开启旁路推流，并选择全局自动旁路；
 <img src="https://qcloudimg.tencent-cloud.cn/raw/d8fbd1c42c14d78175db966a42563b00.png" width="500">
 - 进入应用信息和快速上手，**分别记录 SDKAppID 和 SECRETKEY**
  <img src="https://qcloudimg.tencent-cloud.cn/raw/b0be7e20ff856580e0f7c3927b7c21ef.png" width="500">  
	<img src="https://qcloudimg.tencent-cloud.cn/raw/1005dde69d935e900a31bc43df5b60f5.png" width="500
	">
 

[](id:step_3.1.4)
#### step 3.1.4  配置直播域名
按照相关政策要求，您需要在  [云直播管理控制台](https://console.cloud.tencent.com/live/domainmanage) 中添加自有的**已备案域名**，这样才能使用腾讯云直播的播放功能，请参见 [域名管理](https://cloud.tencent.com/document/product/267/20381) 和 [CNAME 配置](https://cloud.tencent.com/document/product/267/30560) 进行配置。

>? 最后总结一下，当这些步骤执行完成后，您需要记录如下信息为后续工程的配置做好准备：
> - License URL、License Key；
> - SDKAppID、UserSig；
> - PlayDomain；

### 3.2 搭建后台服务
基于[腾讯云云函数](https://cloud.tencent.com/product/scf)环境，小直播提供了一套部署简单、定制性更加灵活的**开源服务**，只需要四步即刻快速跑通“小直播”后台程序：
#### 3.2.1 下载源码
```
git clone https://github.com/reklesswang/live-room.git
```

#### 3.2.2 部署准备

* [开通API网关](https://console.cloud.tencent.com/apigateway/service?rid=1)，通过API网关访问云函数，提供HTTP API。
* [开通COS存储](https://console.cloud.tencent.com/cos5)，保存云函数代码用的。
* [开通SLS日志服务](https://console.cloud.tencent.com/cls/overview?region=ap-guangzhou)，云函数保存日志用的。
* [云函数授权](https://console.cloud.tencent.com/scf/list?rid=1&ns=default)，云函数访问其他云资源用的。

接着 安装云函数工具[serverless/sls](https://cloud.tencent.com/document/product/583/44753)，安装依赖库：

```bash
npm install -g serverless@2.63.0
npm install
```

> ? 
> - 若安装sls有问题，请看官方说明文档[sls](https://cloud.tencent.com/document/product/583/44753)，有详细解决办法。
> - 关于Node安装，请参考[nodejs](https://nodejs.org/zh-cn/download/)，在Windows下请使用Administrator权限启动`Node.js command prompt`，不支持PowerShell。

#### 3.2.3  开始部署服务
在`live-room`目录下，创建环境变量文件`.env`，并输入如下内容：

```bash
TRTC_TIM_APPID=xxxxxxxxxxxxxxxx  // 此处即上一章节中的记录的SDKAppID；
TRTC_TIM_SECRET=xxxxxxxxxxxxxxxx // 此处即上一章节中的记录的SecretKey
```

创建成功后，启动发布，需要扫码授权或配置[本地密钥授权](https://cloud.tencent.com/document/product/583/44786#.E6.9C.AC.E5.9C.B0.E5.AF.86.E9.92.A5.E6.8E.88.E6.9D.83)：

```bash
npm install
sls deploy
```

>? Windows用户，请使用Administrator权限启动`Node.js command prompt`，否则扫码认证会失败。

#### 3.2.4 检查服务是否部署成功
从发布日志中获取API网关地址，例如：`https://service-xxxyyzzz-1001234567.gz.apigw.tencentcs.com`，在浏览器中直接打开你的网关地址，如下图所示，即恭喜您，后台服务部署成功！

![image](https://user-images.githubusercontent.com/2777660/138798904-1435d703-db61-47cb-9044-c6d50424bfac.png)

> ? 特别提示：需要记录下此URL，在小直播App的运行中配置到`GenerateGlobalConfig`文件下。

### 3.3 运行“小直播”App

#### 3.3.1 下载代码

```
    git clone https://github.com/tencentyun/XiaoZhiBo
```

####  3.3.2 Android 工程配置&运行
1. 使用 Android Studio（3.5及以上的版本）打开源码工程`XiaoZhiBo/Android`。
2. 找到并打开`XiaoZhiBo/Android/debug/src/main/java/com/tencent/liteav/debug/GenerateGlobalConfig.java`文件，按照上述步骤中记录的关键信息，设置此文件中的相关参数：
  - `SERVERLESSURL`：默认为 PLACEHOLDER , 请设置为后台服务部署成功后记录下的URL，例如：`https://service-xxxyyzzz-1001234567.gz.apigw.tencentcs.com`
  - `LICENSEURL`：默认为 PLACEHOLDER ，请设置为实际的License Url信息；
  - `LICENSEURLKEY`：默认为 PLACEHOLDER ，请设置为实际的License Key信息；
  - `PLAY_DOMAIN`：默认为 PLACEHOLDER ，请设置为实际的拉流域名；
3. 修改 app模块下的 `build.gradle` 文件中 `applicationId` 字段为License 信息所对应的包名；
4. 连上Android设备，编译并运行即可！

####  3.3.3 iOS 工程配置&运行
1. 使用`终端`，cd到工程文件`XiaoZhiBoApp.xcodeproj`的目录，执行命令 "pod install"
2. 使用 Xcode（11.0及以上的版本）打开源码工程`XiaoZhiBoApp.xcworkspace`，找到并打开`XiaoZhiBo/iOS/APP/Debug/GenerateGlobalConfig.swift`文件，按照上述步骤中记录的关键信息，设置此文件中的相关参数：
  - `SERVERLESSURL`：默认为 "PLACEHOLDER" , 请设置为后台服务部署成功后记录下的URL，例如：`https://service-xxxyyzzz-1001234567.gz.apigw.tencentcs.com`
  - `LICENSEURL`：默认为 PLACEHOLDER ，请设置为实际的License Url信息；
  - `LICENSEURLKEY`：默认为 PLACEHOLDER ，请设置为实际的License Key信息；
	- `PLAY_DOMAIN`：默认为 PLACEHOLDER ，请设置为实际的拉流域名；
3. 修改工程的 `Bundle identifier` 字段为License 信息所对应的包名；
4.  连上iOS设备，编译并运行即可！


