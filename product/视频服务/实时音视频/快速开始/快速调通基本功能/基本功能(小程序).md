本文主要介绍腾讯云 TRTC SDK 的几个最基本功能的使用方法，阅读此文档有助于您对 TRTC 的基本使用流程有一个简单的认识。

## 准备工作
在使用基本功能前，请确保您已完成以下骤，详见[跑通Demo(小程序)](https://cloud.tencent.com/document/product/647/32399)，[快速集成(小程序)](https://cloud.tencent.com/document/product/647/32183)。
- 创建了腾讯云实时音视频应用，购买了相应的套餐，并获取到SDKAppid。
- 获取私钥文件。
- 开通小程序类目与推拉流标签权限。
- 小程序服务器域名配置。
- 在您的小程序项目中集成 &lt;webrtc-room&gt; 组件。


## 部署签名服务
在初始化组件时需要签名服务进行签发 userSig 和 privateMapKey（如果没有在【控制台】-【实时音视频 】-【您的应用名称】-【帐号信息】中启用权限密钥，可以忽略 privateMapKey）。

通过 [签名算法源码](https://github.com/TencentVideoCloudMLVBDev/usersig_server_source) 可以获得服务端签发 userSig 和 privateMapKey 的计算代码，（生成 userSig 和 privateMapKey 的签名算法是 **ECDSA-SHA256**）。[如何计算UserSig](https://cloud.tencent.com/document/product/647/17275)。

## 初始化 SDK
在需要实现实时音视频的小程序页面添加初始化代码，例如在 YourPage 页面下：
```
// YourPage.json 文件
{
  "navigationBarTitleText": "视频通话",
  "usingComponents": {
    "webrtc-room": "/pages/components/webrtc-room/webrtc-room"
  }
}
```
```
// YourPage.wxml 文件
<webrtc-room id="webrtcroom"
    roomID="{{roomID}}"
    userID="{{userID}}"
    userSig="{{userSig}}"
    sdkAppID="{{sdkAppID}}"
    privateMapKey="{{privateMapKey}}"
    template="{{template}}"
    beauty="{{beauty}}"
    muted="{{muted}}"
    debug="{{debug}}"
    bindRoomEvent="onRoomEvent"
    enableIM="{{enableIM}}"
    bindIMEvent="onIMEvent">
</webrtc-room>
```
```
// YourPage.js 文件
Page({
    data: {
        //...
        roomID: '', // [必选]房间号，可以由您的服务指定
        userID: '', // [必选]用户 ID，可以由您的服务指定，或者使用小程序的openid
        userSig: '', // [必选]身份签名，需要从自行搭建的签名服务获取
        sdkAppID: '', // [必选]开通实时音视频服务创建应用后分配的 sdkAppID
        template: 'float', // [必选]标识组件使用的界面模版，组件内置了 bigsmall，float，grid 三种布局
        privateMapKey: '', // 房间权限 key，需要从自行搭建的签名服务获取，如果没有在【控制台】-【实时音视频 】- 【您的应用名称】-【帐号信息】中启用权限密钥，可以忽略 privateMapKey
        beauty: 3, // 美颜指数，取值 0 - 9，数值越大效果越明显
        muted: false, // true 静音 false 不静音
        debug: false, // true 打印推流 debug 信息 fales 不打印推流 debug 信息
        enableIM: false // 是否启用IM
        // 其他配置参数可查看 API 文档
    },
    // 标签通过 onRoomEvent 返回内部事件
    onRoomEvent: function(e){
        switch(e.detail.tag){
            case 'error': {
                //发生错误
                var code = e.detail.code;
                var detail = e.detail.detail;
                break;
            }
        }
    },
    // 通过 onIMEvent 返回 IM 消息事件，如果 enableIM 关闭了，则可以忽略 onIMEvent
    onIMEvent: function(e){
        switch(e.detail.tag){
            case 'big_group_msg_notify': 
                //收到群组消息
                console.debug( e.detail.detail )
                break;
            case 'login_event': 
                //登录事件通知
                console.debug( e.detail.detail )
                break;
            case 'connection_event': 
                //连接状态事件
                console.debug( e.detail.detail )
                break;
            case 'join_group_event': 
                //进群事件通知
                console.debug( e.detail.detail )
                break;
        }
    },

    onLoad: function (options) {
        // 这里需要调用签名服务获取 userSig 等签名信息
        let self = this;
        wx.request({
            url: '', // 您的签名服务地址
            data: {}, // 签名服务需要的参数
            method: 'POST',
            success: function (res) {
                // 初始化 webrtc-room 配置信息，并且在回调中调用 webrtc-room 对象实例的 start 方法以启动 webrtc-room 的初始化流程
                self.setData({
                    userID: res.data.userID,
                    sdkAppID: res.data.sdkAppID,
                    roomID: res.data.roomID,
                    userSig: res.data.userSig, // 需要从自行搭建的签名服务获取
                    privateMapKey: res.data.privateMapKey // 需要从自行搭建的签名服务获取，如果没有在【控制台】-【实时音视频 】- 【您的应用名称】-【帐号信息】中启用权限密钥，可以忽略 privateMapKey
                }, function() {
                    var webrtcroomCom = self.selectComponent('#webrtcroom');
                    if (webrtcroomCom) {
                        webrtcroomCom.start();
                    }
                    self.webrtcroomCom = webrtcroomCom;
                })
            },
            fail: function (res) {
                console.error('请求失败');
            }
        });     
    }
})
```

## 组装参数
使用 &lt;webrtc-room&gt; 组件必须的参数有:

- **sdkAppID**
进入腾讯云实时音视频 [控制台](https://console.cloud.tencent.com/rav)，如果您还没有应用，请创建一个，即可看到 SDKAppid。
![](https://main.qcloudimg.com/raw/79bfa75cea7faec26d91226a5fb23f10.png)

- **userID**
您可以随意指定，由于是字符串类型，可以直接跟您现有的账号体系保持一致，或者直接使用小程序的openid，但请注意，**同一个音视频房间里不应该有两个同名的 userID**。

- **userSig**
基于 sdkAppID 和 userID 可以计算出 userSig，计算方法请参考 [如何计算UserSig](https://cloud.tencent.com/document/product/647/17275)。

- **roomID**
房间号是数字类型，您可以随意指定，但请注意，**同一个应用里的两个音视频房间不能分配同一个 roomID**。

- **template**
标识组件使用的界面模版，组件内置了 bigsmall，float，grid 三种布局，默认值为float。

- **bindRoomEvent**
监听 &lt;webrtc-room&gt; 组件返回的事件，便于定位问题。

## 进入(或创建)房间
设置 &lt;webrtc-room&gt; 组件的属性后，获取 &lt;webrtc-room&gt; 组件的对象实例，并调用对象实例的 `start()` 方法即可完成初始化和进入房间。

```
Page({
    // ...
    joinRoom: function (res) {
        this.setData({
            userID: res.data.userID, // [必选]用户 ID，可以由您的服务指定，或者使用小程序的openid
            sdkAppID: res.data.sdkAppID, // [必选]开通实时音视频服务创建应用后分配的 sdkAppID
            roomID: res.data.roomID, // [必选]房间号，可以由您的服务指定
            userSig: res.data.userSig, // [必选]身份签名，需要从自行搭建的签名服务获取
            privateMapKey: res.data.privateMapKey // 需要从自行搭建的签名服务获取，如果没有在【控制台】-【实时音视频 】- 【您的应用名称】-【帐号信息】中启用权限密钥，可以忽略 privateMapKey
        }, function() {
            var webrtcroomCom = this.selectComponent('#webrtcroom');
            if (webrtcroomCom) {
                webrtcroomCom.start();
            }
            
        })
    },
    // ...
})
```

## 开启（或关闭）本地声音采集
修改组件属性 `muted` 即可控制开启（或关闭）本地声音采集。
```
Page({
    // ...
    changeMute: function (isMuteMute) {
        this.data.muted = isMuteMute; // true or false
        this.setData({
            muted: this.data.muted
        });
    },
    // ...
})
```

## 开启（或关闭）本地视频采集
修改组件属性 `enableCamera` 即可控制开启（或关闭）本地视频采集。
```
Page({
    // ...
    enableCamera: function (isEnableCamera) {
        this.data.enableCamera = isEnableCamera; // true or false
        this.setData({
            enableCamera: this.data.enableCamera
        });
    },
    // ...
})
```

## 切换摄像头
调用组件实例方法 `switchCamera()` 即可切换摄像头。
```
Page({
    // ...
    changeCamera: function () {
        this.data.webrtcroomComponent.switchCamera();
    },
    // ...
})
```

## 界面定制
- setp1: 新建 /pages/templates/mytemplate 文件夹，并创建 mytemplate.wxml 和 mytemplate.wxss 文件。
  
- setp2: 编写 mytemplate.wxml 和 mytemplate.wxss 文件。

```
//mytemplate.wxml
<template name='mytemplate'>
    <view class='videoview'>
        <view class="pusher-box">
            <live-pusher
                id="rtcpusher"
                autopush
                mode="RTC"
                url="{{pushURL}}"
                aspect="{{aspect}}"
                min-bitrate="{{minBitrate}}"
                max-bitrate="{{maxBitrate}}"
                audio-quality="high"
                beauty="{{beauty}}"
                muted="{{muted}}"
                waiting-image="https://mc.qcloudimg.com/static/img/daeed8616ac5df256c0591c22a65c4d3/pause_publish.jpg"
                background-mute="{{true}}"
                debug="{{debug}}"
                bindstatechange="onPush"
                binderror="onError">
                <cover-image  class='character' src="/pages/Resources/mask.png"></cover-image>
                <cover-view class='character' style='padding: 0 5px;'>我</cover-view>
            </live-pusher>
        </view>
        <view class="player-box" wx:for="{{members}}" wx:key="userID">
            <view class='poster'>
                <cover-image class='set' src="https://miniprogram-1252463788.file.myqcloud.com/roomset_{{index + 2}}.png">
                </cover-image>
            </view>
            <live-player
                id="{{item.userID}}"
                autoplay
                mode="RTC"
                wx:if="{{item.accelerateURL}}"
                object-fit="fillCrop"
                min-cache="0.1"
                max-cache="0.3"
                src="{{item.accelerateURL}}"
                debug="{{debug}}"
                background-mute="{{true}}"
                bindstatechange="onPlay">
                <cover-view class='loading' wx:if="{{item.loading}}">
                    <cover-image src="/pages/Resources/loading_image0.png"></cover-image>
                </cover-view>
                <cover-image  class='character' src="/pages/Resources/mask.png"></cover-image>
                <cover-view class='character' style='padding: 0 5px;'>{{item.userName}}</cover-view>
            </live-player>
        </view>
    </view>
</template>
```  

```
//mytemplate.wxss
.videoview {
    background-repeat:no-repeat;
    background-size: cover;
    width: 100%;
    height: 100%;
}
```

- setp3: 在 &lt;webrtc-room&gt; 组件里引入模版。

```
//为 <webrtc-room> 组件中的 webrtcroom.wxml 文件添加自定义模版
<import src='/pages/templates/mytemplate/mytemplate.wxml'/>
<view class='conponent-box'>
    <view styles="width:100%;height=100%;" wx:if="{{template=='1v3'}}">
        <template is='mytemplate' data="{{pushURL, aspect,
                      minBitrate, maxBitrate, beauty, muted, debug, members}}"/>
    </view>
</view>

//为 <webrtc-room> 组件中的 webrtcroom.wxss 文件添加自定义样式
@import "../templates/mytemplate/mytemplate.wxss";
```
## 退出房间
调用组件实例方法 `stop()` 即可退出房间。
```
Page({
    // ...
    exitRoom: function () {
        this.data.webrtcroomComponent.stop();
    },
    // ...
})
```
