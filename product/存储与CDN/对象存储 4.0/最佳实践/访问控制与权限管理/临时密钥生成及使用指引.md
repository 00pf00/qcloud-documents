## 临时密钥
临时密钥是通过 CAM 云 API 提供的接口，获取到权限受限的密钥.<br>
 COS API 可以使用临时密钥计算签名，用于发起 COS API 请求.<br>
 COS API 请求使用临时密钥计算签名时，需要用到获取临时密钥接口返回的信息中三个字段，分别如下：
- `tmpSecretId` 
- `tmpSecretKey` 
- `sessionToken` 

## 使用临时密钥的优势
Web、iOS、Android 使用 COS 的场景时，通过固定密钥计算签名方式不能有效地控制权限，同时把永久密钥放到客户端代码中有极大的泄露风险。如若通过临时密钥方式，则可以方便、有效地解决权限控制问题。
例如，在申请临时密钥过程中，您可以通过传入权限策略 [policy](https://github.com/tencentyun/qcloud-documents/blob/master/product/%E5%AD%98%E5%82%A8%E4%B8%8ECDN/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%204.0/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/COS%20API%20%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5%E4%BD%BF%E7%94%A8%E6%8C%87%E5%BC%95.md) 字段，限制操作和资源，将权限限制在指定的范围内。

## 获取临时密钥
获取临时密钥，可以参考本文中的 [COS STS SDK](#AccessCOS)，也可以参考 [临时密钥接口文档](https://cloud.tencent.com/document/product/598/13896).

<span id="AccessCOS"></span>
### COS STS SDK 
COS 针对 STS 提供了 SDK 和样例，目前已有 Java、Nodejs、PHP、Python 等多种语言的样例。
具体内容请参考 [COS STS SDK](https://github.com/tencentyun/qcloud-cos-sts-sdk)。每个 SDK 的使用说明请参考 Github 上的 ReadMe 和 样例。

以 COS STS SDK 提供的 [Java SDK](https://github.com/QcloudApi/qcloudapi-sdk-java "java sdk") 为例，获取临时密钥示例如下：

```
import com.qcloud.Utilities.Json.JSONObject;

public class Demo {
    public static void main(String[] args) {
        /* 如果是循环调用下面举例的接口，需要从此处开始您的循环语句。切记！ */
        TreeMap<String, Object> config = new TreeMap<String, Object>();
        config.put("SecretId", "AKIDxxxxxx");
        config.put("SecretKey", "xxxxxx");
        
        /* 请求方法类型 POST、GET */
        config.put("RequestMethod", "GET");
        
        /* 区域参数，可选: gz: 广州; sh: 上海; hk: 香港; ca: 北美; 等。 */
        config.put("DefaultRegion", "gz");

        QcloudApiModuleCenter module = new QcloudApiModuleCenter(new Sts(),
                config);

        TreeMap<String, Object> params = new TreeMap<String, Object>();
        /* 将需要输入的参数都放入 params 里面，必选参数是必填的。 */
        /* DescribeInstances 接口的部分可选参数如下 */
        params.put("name", "sevenyou");
        String policy = "{\"statement\": [{\"action\": [\"name/cos:GetObject\",\"name/cos:PutObject\"],\"effect\": \"allow\",\"resource\":[\"qcs::cos:ap-beijing:uid/1250000000:prefix//1250000000/sevenyou/*\"]}],\"version\": \"2.0\"}";
        params.put("policy", policy);
        
        /* 在这里指定所要用的签名算法，不指定默认为 HmacSHA1*/
        //params.put("SignatureMethod", "HmacSHA256");
        
        /* generateUrl 方法生成请求串, 可用于调试使用 */
        System.out.println(module.generateUrl("GetFederationToken", params));
        String result = null;
        try {
            /* call 方法正式向指定的接口名发送请求，并把请求参数 params 传入，返回即是接口的请求结果。 */
            result = module.call("GetFederationToken", params);
            JSONObject json_result = new JSONObject(result);
            System.out.println(json_result);
        } catch (Exception e) {
            System.out.println("error..." + e.getMessage());
        }
    }
}
```

> 获取临时密钥时，需要指定授权策略([Policy](https://github.com/tencentyun/qcloud-documents/blob/master/product/%E5%AD%98%E5%82%A8%E4%B8%8ECDN/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%204.0/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/COS%20API%20%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5%E4%BD%BF%E7%94%A8%E6%8C%87%E5%BC%95.md)).


### 使用临时密钥访问 COS

 COS API 使用临时密钥访问 COS 服务时，通过 `x-cos-security-token` 字段来传递临时 `sessionToken` ，临时 `SecretId` 和 `SecretKey` 则用来生成密钥对。以 Java SDK 为例，使用临时密钥访问 COS 示例如下：
> 单击 [此处](https://github.com/tencentyun/cos-java-sdk-v5) ，从 Github 下载 Java SDK 安装包.

>?下列代码，需要加入`x-cos-security-token`字段，表明使用 STS 的临时密钥。

```
public class Demo {
    public static void main(String[] args) throws Exception {

        // 用户基本信息
        String tmpSecretId = "AKIDxxxxxx";
        String tmpSecretKey = "xxxxxx";
        String sessionToken = "xxxxxx";

        // 1 初始化用户身份信息(secretId, secretKey)
        COSCredentials cred = new BasicCOSCredentials(tmpSecretId, tmpSecretKey);
        // 2 设置bucket的区域, COS地域的简称请参照 https://cloud.tencent.com/document/product/436/6224
        ClientConfig clientConfig = new ClientConfig(new Region("ap-beijing-1"));
        // 3 生成cos客户端
        COSClient cosclient = new COSClient(cred, clientConfig);
        // bucket名需包含appid
        String bucketName = "mybucket-1251668577";

        String key = "aaa/bbb.txt";
        // 上传 object, 建议 20M 以下的文件使用该接口
        File localFile = new File("src/test/resources/test.txt");
        PutObjectRequest putObjectRequest = new PutObjectRequest(bucketName, key, localFile);

        // 设置 x-cos-security-token header 字段
        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setSecurityToken(sessionToken);
        putObjectRequest.setMetadata(objectMetadata);

        try {
            PutObjectResult putObjectResult = cosclient.putObject(putObjectRequest);
            // putobjectResult会返回文件的etag
            String etag = putObjectResult.getETag();
        } catch (CosServiceException e) {
            e.printStackTrace();
        } catch (CosClientException e) {
            e.printStackTrace();
        }

        // 关闭客户端
        cosclient.shutdown();

    }
}
```

### STS 云 API 接口

#### 接口地址：

```
https://sts.api.qcloud.com/v2/index.php
```

#### 请求方法：

云 API 的参数支持 GET 参数和 POST 参数两种格式，以下介绍 GET 参数的格式。

#### 参数说明：

>? 以下请求参数列表中，临时密钥接口特有的参数有：name、policy、durationSeconds 。其他字段则是云 API 的 [公共请求参数](https://cloud.tencent.com/document/api/213/6976)。

| 字段 |  描述  |是否必选 | 类型  |
| ------------ | ------------ | ------------ | ------------ |
| name | 联合身份用户昵称。<br>备注字段，可以填写用户 uin 作为身份备注。 | 是 | String |
| policy | 策略语法，是一个 json 字符串 url encode 结果，真正发送请求在 url 里会是如下文例子的两次 url encode 的字符串 | 是 | String |
| durationSeconds |  指定临时证书的有效期，单位：秒。<br>默认值为1800秒，最长有效期：2小时（7200 秒）。 | 否 | Int |
| Action | 云 API的 Action 参数。需要指定 GetFederationToken。 | 是 | String |
| Timestamp | 当前 UNIX 时间戳。 | 是 | Int |
| Nonce | 随机正整数。与 Timestamp 联合起来，用于防止重放攻击。 | 是 | Int |
| Region | 云 API 地域参数，可填写空字符串，默认就近地域。可填写的地域请参见 [公共请求参数](https://cloud.tencent.com/document/api/213/6976)。 | 是 | String |
| SecretId | 在云 API 密钥上申请的标识身份的 SecretId。一个 SecretId 对应唯一的 SecretKey，SecretKey 会用来生成请求签名 Signature。 | 是 | String |
| Signature | 请求签名。用来验证此次请求的合法性，需要用户根据实际的输入参数计算得出。<br>计算方法可参考 [签名方法](https://cloud.tencent.com/document/api/213/6984#.E7.94.9F.E6.88.90.E7.AD.BE.E5.90.8D.E4.B8.B2 "签名方法") 章节。|是 | String |

#### 返回结果

| 字段 | 类型  | 描述  |
| ------------ | ------------ | ------------ |
| expiredTime | Int | 临时密钥失效的时间戳。 |
| credentials | Object | 对象中包含 Token，tmpSecretId，tmpSecretKey 三元组。 |
| --tmpSecretId | String| tmpSecretId 计算签名时使用。 |
| --tmpSecretKey |String| tmpSecretKey 计算签名时使用。 |
| --sessionToken | String | sessionToken 请求鉴权时使用，COS 接口放在 Header 的 x-cos-security-token 字段里。 |

#### 访问请求示例

```
GET https://sts.api.qcloud.com/v2/index.php?Action=GetFederationToken&Nonce=13958&Region=gz&SecretId=AKIDwqaGoCIWIG4hDWdJUTL5e3hn04xiD5kI&Signature=%2FRhJ3BcWBfSxOjO5nZavyv4nyuA%3D&Timestamp=1542812655&durationSeconds=7200&name=cos&policy=%257B%2522version%2522%253A%25222.0%2522%252C%2522statement%2522%253A%255B%257B%2522action%2522%253A%255B%2522name%252Fcos%253A%252A%2522%255D%252C%2522effect%2522%253A%2522allow%2522%252C%2522principal%2522%253A%257B%2522qcs%2522%253A%255B%2522%252A%2522%255D%257D%252C%2522resource%2522%253A%255B%2522qcs%253A%253Acos%253Aap-guangzhou%253Auid%252F1251902136%253Aprefix%252F%252F1251902136%252Ftest%252F%2522%252C%2522qcs%253A%253Acos%253Aap-guangzhou%253Auid%252F1251902136%253Aprefix%252F%252F1251902136%252Ftest%252F%2528%2521%2527%252A%2529%2B%255C%2522%2523%2524%2525%2526%252B%252C-.%252F0123456789%253A%253B%253C%253D%253E%2540ABCDEFGHIJKLMNOPQRSTUVWXYZ%255B%255C%255C%255D%255E_%2560abcdefghijklmnopqrstuvwxyz%257B%257C%257D%257E%2522%255D%257D%255D%257D
```

#### 返回内容示例

```
{
    "codeDesc": "Success",
    "message": "",
    "data": {
        "expiredTime": 1494563462,
        "credentials": {
            "tmpSecretId": "AKIDxxxxxx",
            "tmpSecretKey": "xxxxxx",
            "sessionToken": "xxxxxx"
        }
    },
    "code": 0
}
```


下面列出一些常见场景下是如何设置 Policy 的：

#### 1. 完全的读写权限
```
{
  "version": "2.0",
  "statement": [
    {
      "action": [
        "*"
      ],
      "effect": "allow",
      "resource": [
        "*"
      ]
    }
  ]
}
```

#### 2. 拥有所有 COS 资源的读权限

```
{
  "version": "2.0",
  "statement": [
    {
      "action": [
        "name/cos:Head*",
        "name/cos:Get*",
        "name/cos:List*",
        "name/cos:OptionsObject"
      ],
      "effect": "allow",
      "resource": [
        "*"
      ]
    }
  ]
}
```

#### 3. 用户文件私有读写

这个场景在移动应用中非常常见，用户的数据只允许他自己访问，其他用户无法访问。例如，一个相册应用允许用户管理自己上传的图片，而其他用户没有访问权限。您可以通过以下设置，达到用户级别的数据安全。

第一步，将数据设置为私有写。

第二步，数据按照用户存储。文件在上传时，将用户唯一 ID 作为文件路径前缀的一部分。例如，用户 A 唯一标识是 userID123456，那么 A 用户上传的文件 file1 存放在 `pictures/userID123456/file1`。

第三步，按照用户 ID 来设置 policy 的资源路径前缀。

例如，腾讯云 APPID 为 1253653367，存储桶地域为 ap-shanghai，存储桶为 example-1253653367 ，用户 A 文件路径前缀为 userID123456 。当 A 用户使用临时密钥访问时，授权策略 Policy 设置如下：
```
 {
  "version": "2.0",
  "statement": [
    {
      "action": [
        "*"
      ],
      "effect": "allow",
      "resource": [
        "qcs::cos:ap-shanghai:uid/1253653367:prefix//1253653367/example/userID123456/*"
      ]
    }
  ]
}
```
这样返回的临时密钥，只能访问存储桶 example-1253653367 中路径前缀为 userID123456 下的文件，无法访问其他用户上传的文件。
