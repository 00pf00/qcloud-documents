## 简介

本文档提供关于对象存储图片处理相关 API 概览以及 SDK 示例代码。

| API                                                          | 操作名             | 操作描述                           |
| ------------------------------------------------------------ | ------------------ | ---------------------------------- |
| [PUT Service](https://cloud.tencent.com/document/product/460/37513) | 上传时识别二维码 |上传图片对象时识别图片二维码并返回二维码信息|
| [GET Service](https://cloud.tencent.com/document/product/460/37513) | 云上识别二维码 | 云上识别图片二维码并返回二维码信息         |


## 功能描述

数据万象二维码识别功能可识别图片中有效二维码的位置及内容，输出图像中二维码包含的文本信息（每个二维码对应的 URL 或文本），并可对识别出的二维码添加马赛克。

### <h1> 上传时识别 </h1>

图片上传时识别二维码的请求包与 COS 简单上传文件接口一致，只需在请求包头部增加图片处理参数 Pic-Operations。

#### 请求语法

```shell
   put_ci_object_from_local_file_and_get_qrcode(Bucket, LocalFilePath, Key, EnableMD5=False, **kwargs) # 按文件名上传
   put_ci_object(Bucket, Body, Key, EnableMD5=False, **kwargs) # 文件已打开，传入Body(file|string)指定上传的文件内容，类型为文件流或字节流.
```

>- COS 简单上传文件接口，详细请参见 [PUT Object 文档](https://cloud.tencent.com/document/product/436/7749)

#### 参数说明

| 参数名称   | 参数描述   |类型 | 必填 | 
| -------------- | -------------- |---------- | ----------- |
| Bucket |存储桶名称，由 BucketName-APPID 构成|String| 是|
| LocalFilePath |本地文件路径名|String| 是|
| Key |对象键（Key）是对象在存储桶中的唯一标识。|String|是|
| EnableMD5 |是否需要 SDK 计算 Content-MD5，默认关闭，打开后将增加上传耗时|Bool|否|
| PicOperations |在本接口中，可变参数kwargs固定为'PicOperations'，具体参考下面说明 |String|是|

#### 请求内容

Pic-Operations 为 json 格式的字符串，具体参数如下：

| 参数名称    | 类型  | 是否必选 | 描述                                                         |
| ----------- | ----- | -------- | ------------------------------------------------------------ |
| is_pic_info | Int   | 否       | 是否返回原图信息，0不返回原图信息，1返回原图信息，默认为0    |
| rules       | Array | 否       | 处理规则，一条规则对应一个处理结果（目前最多支持五条规则），不填则不进行图片处理 |


rules（json 数组）中每一项具体参数如下：

| 参数名称 | 类型   | 是否必选 | 描述                                                         |
| -------- | ------ | -------- | ------------------------------------------------------------ |
| bucket   | String | 否       | 存储结果的目标存储桶，格式为 BucketName-APPID，如果不指定的话默认保存到当前存储桶 |
| fileid   | String | 否       | 处理结果的文件路径名称，例如以`/`开头，则存入指定文件夹中，否则存入与原图文件相同的目录位置 |
| rule     | String | 是       | 处理参数，参见数据万象图片处理 API。若按指定样式处理，则以`style/`开头，后加样式名，<br>例如样式名为`test`，则 rule 字段为`style/test` |


使用二维码识别功能需在 rule 中添加二维码识别参数（QRcode），相关内容如下：
```shell
QRcode/cover/<mode>
```

| 参数  | 类型 | 是否必选 | 描述                                                         |
| ----- | ---- | -------- | ------------------------------------------------------------ |
| cover | Int  | 否       |二维码覆盖功能。可为0或1。0表示不开启二维码覆盖，1表示开启二维码覆盖<br>功能开启后，将对识别出的二维码覆盖上马赛克 |

#### 返回内容

响应包体具体数据内容如下： 

| 参数名称     | 类型      | 描述     |
| ------------ | --------- | -------- |
| UploadResult | Container | 原图信息 |


UploadResult 节点内容： 

| 参数名称       | 类型      | 描述         |
| -------------- | --------- | ------------ |
| OriginalInfo   | Container | 原图信息     |
| ProcessResults | Container | 图片处理结果 |


OriginalInfo 节点内容： 

| 节点名称  | 类型      | 描述         |
| --------- | --------- | ------------ |
| Key       | String    | 原图文件名   |
| Location  | String    | 图片路径     |
| ImageInfo | Container | 原图图片信息 |


ImageInfo 节点内容： 

| 节点名称    | 类型   | 描述         |
| ----------- | ------ | ------------ |
| Format      | String | 格式         |
| Width       | Int    | 图片宽度     |
| Height      | Int    | 图片高度     |
| Quality     | Int    | 图片质量     |
| Ave         | String | 图片主色调   |
| Orientation | Int    | 图片旋转角度 |

ProcessResults 节点内容： 

| 节点名称 | 类型      | 描述               |
| -------- | --------- | ------------------ |
| Object   | Container | 每一个图片处理结果 |


Object 节点内容： 

| 节点名称   | 类型      | 描述                                                   |
| ---------- | --------- | ------------------------------------------------------ |
| Key        | String    | 文件名                                                 |
| Location   | String    | 图片路径                                               |
| Format     | String    | 图片格式                                               |
| Width      | Int       | 图片宽度                                               |
| Height     | Int       | 图片高度                                               |
| Size       | Int       | 图片大小                                               |
| Quality    | Int       | 图片质量                                               |
| codeStatus | int       | 二维码识别结果。0表示未识别到二维码，1表示识别到二维码 |
| QRcodeInfo | container | 二维码识别结果，可能有多个                             |


QRcodeInfo 节点内容： 

| 节点名称     | 类型      | 描述                       |
| ------------ | --------- | -------------------------- |
| codeUrl      | string    | 二维码的内容。可能识别不出 |
| codelocation | container | 图中识别到的二维码位置坐标 |


codelocation 节点内容：

| 节点名称 | 类型 | 描述         |
| -------- | ---- | ------------ |
| point    | int  | 二维码坐标点 |

#### 示例

##### 请求

```shell
    # 先创建 cos client
    qrcode_file_name = 'example_qrcode.jpg'
    with open(qrcode_file_name, 'rb') as fp:
        opts = '{"is_pic_info":1,"rules":[{"fileid":"format.jpg","rule":"QRcode/cover/0"}]}'
        response = client.put_ci_object_from_local_file_and_get_qrcode(
            Bucket='example-bucket-123456789',
            LocalFilePath=qrcode_file_name,
            Key=qrcode_file_name,
            EnableMD5=False,
            PicOperations=opts
        )
        # 查看响应信息，可根据需要只读指定数据
        print(response)
```

### <h1> 云上识别图片二维码 </h1>

#### 请求语法

```shell
    get_ci_object_qrcode(Bucket, Key, Cover, **kwargs)
```

#### 参数说明

| 参数名称   | 参数描述   |类型 | 必填 | 
| -------------- | -------------- |---------- | ----------- |
| Bucket |存储桶名称，由 BucketName-APPID 构成|String| 是|
| Key |对象键（Key）是对象在存储桶中的唯一标识。|String|是|
| Cover |二维码覆盖功能，将对识别出的二维码覆盖上马赛克。取值为0或1。0表示不开启二维码覆盖，1表示开启二维码覆盖|int|是|


#### 响应体

该响应体返回为 **application/xml** 数据，包含完整节点数据的内容展示如下：

```shell
<Response>
     <CodeStatus>1</CodeStatus>
     <QRcodeInfo>
       <CodeUrl>xxxx</CodeUrl>
	      <CodeLocation>
	         <Point>xxx,xxx</Point>
	         <Point>xxx,xxx</Point>
	         <Point>xxx,xxx</Point>
	         <Point>xxx,xxx</Point>
	      </CodeLocation>
     </QRcodeInfo>
     <ResultImage>
        base64编码的图片
     </ResultImage>
</Response>
```

具体的数据内容如下：

| 节点名称（关键字） | 父节点 | 描述           | 类型      |
| :----------------- | :----- | :------------- | :-------- |
| Response           | 无     | 保存结果的容器 | Container |

Response 的内容：

| 节点名称（关键字） | 父节点   | 描述                                                   | 类型      |
| :----------------- | :------- | :----------------------------------------------------- | :-------- |
| CodeStatus         | Response | 二维码识别结果。0表示未识别到二维码，1表示识别到二维码 | Int       |
| QRcodeInfo         | Response | 二维码识别结果，可能有多个                             | Container |
| ResultImage        | Response | 处理后的图片 base64数据，请求参数 cover 为1时返回         | String    |

QRcodeInfo 节点内容：

| 节点名称（关键字） | 父节点     | 描述                       | 类型      |
| :----------------- | :--------- | :------------------------- | :-------- |
| CodeUrl            | QRcodeInfo | 二维码的内容。可能识别不到内容 | String    |
| CodeLocation       | QRcodeInfo | 图中识别到的二维码位置坐标 | Container |

CodeLocation 节点内容：

| 节点名称（关键字） | 父节点       | 描述                        | 类型   |
| :----------------- | :----------- | :-------------------------- | :----- |
| Point              | CodeLocation | 二维码坐标点（X坐标,Y坐标） | String |

#### 错误码

该请求操作无特殊错误信息，常见的错误信息请参见 [错误码](https://cloud.tencent.com/document/product/460/42867) 文档。

#### 示例

##### 请求

```shell
    response = client.get_ci_object_qrcode(
        Bucket='example_bucket',
        Key='example_object',
        Cover=0
    )
    print(response)
```
