## 下载与安装

### 相关资源
小程序 SDK 资源下载地址：[GitHub 下载](https://github.com/tencentyun/cos-wx-sdk-v5)。

### 环境依赖

适用于微信小程序环境

### 安装 SDK

#### 手动安装

复制源码里的 [demo](https://github.com/tencentyun/cos-wx-sdk-v5/blob/master/demo/lib/cos-wx-sdk-v5.js) 到自己小程序代码目录里，代码可以通过如下代码引用。

#### npm 安装

如果小程序代码使用了 webpack 打包，可以通过 npm 安装依赖：

```
npm install cos-wx-sdk-v5
```

### 前期准备

1. 登陆 [对象存储控制台](https://console.cloud.tencent.com/cos4) 创建存储桶，获取 Bucket（存储桶名称） 和 Region（地域名称）
2. 然后到访问管理控制台的 [密钥管理](https://console.cloud.tencent.com/capi) 获取您的项目 SecretId 和 SecretKey。

#### 计算签名

由于签名计算放在前端会暴露 SecretId 和 SecretKey，我们把签名计算过程放在后端实现，前段通过 ajax 向后端获取临时密钥，正式部署时请在后端加一层自己网站本身的权限检验。

这里提供 [PHP 和 NodeJS 的签名示例](https://github.com/tencentyun/cos-js-sdk-v5/blob/master/server/)，其他语言使用临时密钥，详情请查阅 [临时密钥生成及使用指引](https://cloud.tencent.com/document/product/436/14048)。

## 快速入门
### 初始化

```js
var cos = new COS({
    // ForcePathStyle: true, // 如果使用了很多存储桶，可以通过打开后缀式，减少配置白名单域名数量，请求时会用地域域名
    getAuthorization: function (options, callback) {
        // 异步获取签名
        wx.request({
            url: 'https://example.com/sts.php',
            data: {
                Method: options.Method,
                Key: options.Key
            },
            dataType: 'text',
            success: function (result) {
                var data = result.data;
                var credentials = data.credentials;
                callback({
                    TmpSecretId: credentials.tmpSecretId,
                    TmpSecretKey: credentials.tmpSecretKey,
                    XCosSecurityToken: credentials.sessionToken,
                    ExpiredTime: data.expiredTime,
                });
            }
        });
    }
});
```

### 创建存储桶

```js
cos.putBucket({
    Bucket: 'examplebucket-1250000000',
    Region: 'ap-beijing',
    Key: filename,
}, function (err, data) {
    console.log(err || data);
});
```

注：如果需要在小程序创建存储桶，通常是存储桶名称未知，也就没办法配置存储桶名称作为域名白名单，这个查看下文的 *常见问题* 1解决方法

### 查询存储桶列表

```js
cos.getService(function (err, data) {
    console.log(err || data);
});
```

### 上传对象

由于小程序上传接口 wx.uploadFile 只支持 POST 请求，SDK 上传文件需要使用 postObject 接口

如果小程序里只需要用到上传文件接口，建议不引用 SDK，直接参考简单例子 [demo](https://github.com/tencentyun/cos-wx-sdk-v5/blob/master/demo/demo-no-sdk.js)。

```js
// 先选择文件，得到临时路径
wx.chooseImage({
    count: 1, // 默认9
    sizeType: ['original'], // 可以指定是原图还是压缩图，默认用原图
    sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
    success: function (res) {
        var filePath = res.tempFiles[0].path;
        var filename = filePath.substr(filePath.lastIndexOf('/') + 1);
        cos.postObject({
            Bucket: 'examplebucket-1250000000',
            Region: 'ap-beijing',
            Key: filename,
            FilePath: filePath,
            onProgress: function (info) {
                console.log(JSON.stringify(info));
            }
        }, function (err, data) {
            console.log(err || data);
        });
    }
});
```

### 查询对象列表

```js
cos.getBucket({
    Bucket: 'examplebucket-1250000000',
    Region: 'ap-beijing',
    Prefix: 'exampledir/',
}, function (err, data) {
    console.log(err || data);
});
```


### 获取对象 Url

```js
cos.getObjectUrl({
    Bucket: 'examplebucket-1250000000',
    Region: 'ap-beijing',
    Key: '1.png',
}, function (err, data) {
    console.log(err || data.Url);
});
```

### 上传文本内容到对象

上传文本内容可以通过 putObject 接口完成，实际调用的是 wx.request 接口

```js
cos.putObject({
    Bucket: 'examplebucket-1250000000',
    Region: 'ap-beijing',
    Key: '1.txt',
    Body: 'hello',
    onProgress: function (info) {
        console.log(JSON.stringify(info));
    }
}, function (err, data) {
    console.log(err || data);
});
```

### 读取对象的文本内容

```js
cos.getObject({
    Bucket: 'examplebucket-1250000000',
    Region: 'ap-beijing',
    Key: '1.txt',
}, function (err, data) {
    console.log(err || data.Body);
});
```

### 删除对象

```js
cos.deleteObject({
    Bucket: 'examplebucket-1250000000',
    Region: 'ap-beijing',
    Key: '1.png',
}, function (err, data) {
    console.log(err || data.Body);
});
```

## 常见问题

1. 小程序里请求很多个域名，或者存储桶名称不确定，怎么解决白名单配置和限制问题？
SDK 实例化时，使用 `ForcePathStyle: true` 可以打开后缀式，只需要
真正请求 url 格式如下 `https://cos-ap-beijing.myqcloud.com/<BucketName-APPID>/<Key>`
后缀式请求，在签名时会存储桶名称  `/<BucketName-APPID>` 也会加入签名计算

2. 如何保存图片到本地？
先预先通过 `cos.getObjectUrl` 获取图片 url，调用 `wx.downloadFile` 下载图片得到临时路径，
界面显示保存保存图片按钮，用户点击按钮后，调用 `wx.saveImageToPhotosAlbum` 保存到相册。

## 相关文档

完整文档待完善中，不支持分片相关接口，上传、下载相关方法请查看源码和 [使用 demo](demo/demo-sdk.js)。其他接口文档请参考 JavaScript SDK 的 [接口文档](https://cloud.tencent.com/document/product/436/12260)。
