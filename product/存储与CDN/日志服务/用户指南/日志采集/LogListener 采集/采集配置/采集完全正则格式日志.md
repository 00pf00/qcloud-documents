## 概述

完全正则模式指将一条完整日志按正则方式提取多个 key-value 的日志解析模式，若不需要提取 key-value，请参阅 [单行全文](https://cloud.tencent.com/document/product/614/17421) 或 [多行全文](https://cloud.tencent.com/document/product/614/17422) 进行配置。完全正则模式配置过程中，用户需先输入日志样例，然后自定义正则表达式，系统根据正则表达式里的捕获组提取对应的 key-value。下面将为您详细介绍如何采集完全正则格式日志。

## 示例

假设您的一条日志原始数据为：

```shell
10.135.46.111 - - [22/Jan/2019:19:19:36 +0800] "GET /online/sample HTTP/1.1" 127.0.0.1 200 728 35 "http://127.0.0.1/course/explore?filter%5Btype%5D=all&filter%5Bprice%5D=all&filter%5BcurrentLevelId%5D=all&orderBy=studentNum" "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:64.0) Gecko/20100101 Firefox/64.0"  0.176 0.176
```

配置的自定义正则表达式为：

```shell
(\S+)[^\[]+(\[[^:]+:\d+:\d+:\d+\s\S+)\s(\S+\s\S+\s\S+)\s(\S+)(\s\d+)\s(\d+)\s(\d+\s)(\S+)\s(\S+\s\S+\s\w+\s\S+\s\S+\s\w+:\S+\s\S+\s\S+)\s+(\S+)\s(\S+).*
```

则日志服务会根据 "()" 捕获组提取对应的 key-value 对如下所示，用户可以自定义每组的 key 名称：

```shell
body_bytes_sent: 35
http_host: 127.0.0.1
http_referer: "http://127.0.0.1/course/explore?filter%5Btype%5D=all&filter%5Bprice%5D=all&filter%5BcurrentLevelId%5D=all&orderBy=studentNum"
http_user_agent: "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:64.0) Gecko/20100101 Firefox/64.0"
remote_addr: 10.135.46.111
remote_user: [22/Jan/2019:19:19:36 +0800]
request_length: 728
request_time: 0.176
status: 200
time_local: "GET /online/sample HTTP/1.1"
upstream_response_time: 0.176
```

> !完全正则目前只支持单行日志提取 key-value ，多行日志暂不支持提取，如需采集多行日志请参阅 [采集多行全文日志](https://cloud.tencent.com/document/product/614/17422) 文档。

## 采集配置

#### 1. 登录控制台

登录[日志服务控制台](https://console.cloud.tencent.com/cls)，左侧选择日志集管理。

#### 2. 新增日志主题

选择目标日志集，单击【新增日志主题】，输入日志主题名称：test-total ，单击【确定】，即可新增日志主题。 
![](https://main.qcloudimg.com/raw/102d3f6e08598b5bdc677ff40cd54901.png) 

#### 3. 配置 LogListener 采集

单击 LogListener 采集的日志主题，在采集配置界面中单击右上角【编辑】，进入编辑模式，开启**采集状态**和**使用 LogListener**。
![](https://main.qcloudimg.com/raw/277b43f1db32451b340522f10d442c16.png)

#### 4. 配置日志文件采集路径

日志采集路径需分别指定日志前缀目录和文件名，支持通配符`*`和`？`两种方式。路径匹配规则支持多层目录匹配，即指定目录前缀后，会监听到所有子层目录中符合采集文件名规则的日志文件，参数说明如下：

| 字段     | 说明                                      |
| -------- | ----------------------------------------- |
| 目录前缀 | 日志文件前缀目录结构，支持通配符`*`和`？` |
| 文件名   | 日志文件名，支持通配符`*`和`？`           |

例如，目录前缀是`/var/logs/app_*`，文件名是`*.log`，则 agent 会监听`/var/log`下所有`app_*` 模式的以`.log`为后缀名的日志文件。

> !
> 1. 多层目录和通配符配置方式依赖 loglistener 版本2.2.2及以上，为兼容低版本 loglistener 路径配置修改方式，用户可切换旧配置进行历史修改，旧采集路径方式不支持多目录采集。
> 2. 一个日志文件只能被一个日志主题采集。

#### 5.关联机器组

从机器组列表中选择目标机器组，将其与当前日志主题进行关联，关联的机器组与日志主题所在的地域需保持一致。了解更多请参阅 [如何创建机器组](https://github.com/tencentyun/qcloud-documents/blob/master/document/product/614/17412)。
![](https://main.qcloudimg.com/raw/8ee36a4acdbb5301c41634b88a51c075.png)

#### 6.选择完全正则模式

【键值提取模式】选择**完全正则**，如下图所示：
![](https://main.qcloudimg.com/raw/79786db542d1171f3d66fb972d104d28.png)

#### 6.1 定义正则表达式

完全正则模式下将根据定义好的正则表达式提取 key-value，用户可以点击【自动生成】完成正则提取模式。如果无法自动生成，可以切换成手动方式进行正则模式验证。

- 自动模式
 1. 输入日志样例
 2. 根据检索分析需要，将一部分日志内容选中，然后点击旁边的【分组】按钮，成功分组后会特殊显示，表示该部分会作 为一个 key-value 分组提取。
 3. 重复步骤2，直到分组完所有需提取的 key-value。
 4. 点击【自动生成】按钮，系统将日志分组生成正则提取模式。
![](https://main.qcloudimg.com/raw/a005676af7a0bba4412ea224037969e8.png)

- 手动模式
 1. 输入日志样例。
 2. 手动输入正则提取表达式。
 3. 点击【验证】，系统将判断日志样例与正则表达式是否匹配。

>?无论是自动模式还是手动模式，一旦正则提取模式定义好并验证通过，提取结果将会展示在下方，用户需要对每一组 key-value 对定义好一个 key 名称，该名称会用于日志检索分析。

#### 7. 配置采集时间

日志时间单位为：秒。
日志的时间属性有两种方式来定义：采集时间和原始时间戳。
采集时间：日志的时间属性由日志服务 CLS 采集该条日志的时间决定。
原始时间戳：日志的时间属性由原始日志中时间戳决定。

#### 7.1 采集时间作为日志的时间属性

保持采集时间状态为开启状态即可，如下图所示：
![](https://i.imgur.com/t673Jlj.png)

#### 7.2 日志的原始时间戳作为日志时间属性

关闭采集时间状态，填写原始时间戳的时间键以及对应的时间解析格式，转换格式支持 strftime 的所有函数。
![](https://i.imgur.com/xgEroee.png)

下面举例说明时间格式解析规则填写：  
例1：日志样例原始时间戳：`10/Dec/2017:08:00:00`，解析格式为：`%d/%b/%Y:%H:%M:%S`。
例2：日志样例原始时间戳：`2017-12-10 08:00:00`，解析格式为：`%Y-%m-%d %H:%M:%S` 。
例3：日志样例原始时间戳：`12/10/2017, 08:00:00`，解析格式为：`%m/%d/%Y, %H:%M:%S`。

>!日志时间支持以秒为单位，若时间格式填写错误日志时间将以采集时间为准。

#### 8. 设定过滤器条件

过滤器旨在您根据业务需要添加日志采集过滤规则，帮助您方便筛选出有价值的日志数据。对于分隔符格式日志，可以根据所解析成的键值对配置过滤规则，过滤规则为正则表达式。所创建的过滤规则为命中规则，即匹配上正则表达式的日志才会被采集上报。

例如：采集 errorcode = 400或500的日志数据，则将 key 配置为 errorcode，过滤规则配置为(400|500)。

#### 9. 检索日志

登录 [日志服务控制台](https://console.cloud.tencent.com/cls)，左侧选择日志检索，输入日志集与日志主题，单击【搜索】，即可开始按照设定的查询条件检索日志。
![](https://main.qcloudimg.com/raw/21444bc8d8428706f9899d904d83f31d.png)

> !检索必须开启索引配置，不然会无法检索。
