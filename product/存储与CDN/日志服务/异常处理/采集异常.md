## 常见异常现象
1. Agent 安装成功，但未上报数据
2. Agent 上报数据出错

## 排查步骤

### 1. 修改 Agent 日志级别
编辑配置文件 etc/loglistener.conf，将 `level` 改为 DEBUG，然后重启 agent，如下图所示：
![](https://main.qcloudimg.com/raw/05bc0bec901147c2b9e6550a85fa7d82.png)
>**注意：**
>重启 Agent 不会丢失日志。

### 2. 确认日志上报成功
执行以下命令，查看是否成上报日志：
```
tail -f loglistener.log | grep "ClsFileProc::readFile" | grep send
```
若日志成功上报到服务后台，则会出现以下图示的日志：
![](https://main.qcloudimg.com/raw/4def8be9bed570b63c6894f9168e5446.png)   
>**注意：**
>日志通过 HTTP 上报，通过抓包查看 80 端口，也能够确认日志通过网络是否上报成功。

若日志没有成功上报到后台，可能由以下原因导致，请按以下步骤逐步排查：
a）检查 Agent 采集配置是否正确。系统每隔一段时间，会自动根据控制台配置项更新采集端配置，查看命令如下：
```
tail -f log/loglistener.log | grep "ClsServerConf::load"
```
若有配置下发，则日志如下所示：
![](https://main.qcloudimg.com/raw/13ab0acd5ab09c41da466d07cc6deaa6.png)
对于下发配置，需检查其中的 log_type、path 信息是否正确。其中：
- log_type 表示配置的日志解析类型（单行全文：minimalist_log，分隔符：delimiter_log，json日志：json_log，多行全文：regex_log）。
- path 表示日志采集目录。

b）检查文件是否被正常监听。检查命令如下：
```
grep [要上报的日志文件的具体文件名] loglistener.log
```
- 如果文件被成功监听，执行检查命令后，会出现以下日志：
 ![](https://main.qcloudimg.com/raw/1c073b7ff908ab125a45be5849f2e9fe.png)
- 如果 grep 失败，搜索 regex_match，检查控制台的正则表达式是否配置合理，若文件名匹配正则失败，则会如下图所示，此时需要到控制台更改表达式。
 ![](https://main.qcloudimg.com/raw/3a56567e6b3111cf165eb5fbb1b48c24.png)
- 如果文件没有监听成功，检查日志所在挂载点是否是 NAS、CIFS、NFS 类型的共享目录。由于 Agent 采集机制，目前不支持采集此类目录文件。

c）检查日志正则解析是否正确
对于完全正则和多行全文提取模式，需要指定正则表达式。特别是多行全文，需特别注意是首行正则表达式是匹配整个首行的内容，而非首行开头的部分内容。
例如下面的日志样例，如果认为 INFO、ERROR、WARN 开头的是日志首行，那么正确的配置方法是，除了匹配 (INFO|ERROR|WARN) 外，后面的字符也需要匹配，故后面要添加`.\*`。
![](https://main.qcloudimg.com/raw/5ef5f29aa2a7a2283b8da2d1f698fe58.png)
错误配置方法：`^(INFO|ERROR|WARN)`
正确配置方法：`^(INFO|ERROR|WARN).*`