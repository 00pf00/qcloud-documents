## 配置场景
腾讯云 CDN 在缓存资源时，为提高存储效率会将文件进行切片存储，并且支持 Range 请求，若请求时携带 HTTP 头部`Range: bytes = 0-999`，则返回文件的前1000个字节给用户。

开启分片回源配置，若用户请求的部分文件已过期，CDN 会根据用户请求进行分片回源，仅拉取用户需要的部分文件进行缓存，同时返回给用户；关闭分片回源配置，即便用户请求的是部分文件，CDN 在回源时仍会拉取整个文件，而后进行缓存，并响应给用户其要求的部分文件。

开启分片回源配置能够有效提高大文件分发效率，提升响应速度，降低源站压力。

> ?
> - 开启分片回源配置后，资源在节点上分片缓存，但所有分片的缓存过期时间保持一致，按照用户指定的缓存过期规则。
> - 开启分片回源配置时，需要确认源站已经支持 Range 请求，否则可能会导致回源失败。

## 配置指南

### 添加域名

登录 [CDN 控制台](https://console.cloud.tencent.com/cdn)，在左侧菜单栏选择**域名管理**，添加域名时，会根据所选加速类型和源站类型，默认配置针对全部文件的分片回源，您可按需自主开启/关闭配置：
- 内容分发网络 CDN - 静态加速类型下，默认关闭分片回源。
- 内容分发网络 CDN - 下载加速和流媒体点播加速 类型下，默认开启分片回源。
- 若源站类型为 COS 源，所有加速类型下，均默认开启分片回源。


![](https://main.qcloudimg.com/raw/a1f2dcb7c34df4db7a8c66f9217763dc.png)



### 管理域名
域名添加后，单击域名操作列的**管理**，进入域名配置页面，切换 Tab 至**回源配置**，即可找到**分片回源配置**。
![](https://main.qcloudimg.com/raw/57126fb0be1b941813f9e4661ca549bf.png)

**配置约束**
1. 全部文件规则 - 默认最低优先级，不可调整优先级，不可删除。
2. 支持添加按文件后缀/文件目录/全路径文件配置的规则，最多可添加20条规则，可调整优先级。


## 配置示例
若域名`cloud.tencent.com`的分片回源配置如下：
![](https://main.qcloudimg.com/raw/724500ca5aa62e924bd96e1251945ecb.png)
用户 A 请求资源：`http://cloud.tencent.com/test.apk`，节点收到请求后，发现缓存的`test.apk`文件已过期，此时发起回源请求，节点回源使用 Range 请求，分片获取资源并缓存。若此时用户 B 发起的也为 Range 请求，当节点上存储的分片已满足 Range 中指定的字节段，则会直接返回给用户，无需等所有分片获取完毕。

