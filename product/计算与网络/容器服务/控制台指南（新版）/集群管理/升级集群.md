## 操作场景

腾讯云容器服务提供升级 Kubernetes 版本的功能，您可通过此功能对运行中的 Kubernetes 集群进行升级。升级的过程为升级的前置检查、升级 Master 、升级 Node。



## 升级须知<span ID="UpgradeNotice"></sapn>
- **升级属于不可逆操作、请谨慎进行。**
- 目前集群升级功能处于内测阶段， 如有需要请[ 提交工单 ](https://console.qcloud.com/workorder/category?level1_id=6&level2_id=350&source=0&data_title=%E5%AE%B9%E5%99%A8%E6%9C%8D%E5%8A%A1TKE&step=1) 申请。
- 请在升级集群前，查看集群下状态是否均为健康状态。若集群不正常，您可以自行修复，也可以通过[ 提交工单 ](https://console.qcloud.com/workorder/category?level1_id=6&level2_id=350&source=0&data_title=%E5%AE%B9%E5%99%A8%E6%9C%8D%E5%8A%A1TKE&step=1)联系我们协助您进行修复。
- 升级集群时，需要先升级 Master 再升级 Node ，且升级过程中不建议对集群进行任何操作。
- 仅支持向上升级TKE 提供的最近 Kubernetes 版本，不支持跨多个版本升级（例如 1.8 升级至 1.10 ，1.10 升级至 1.12）。仅当集群内 Master 版本和 Node 版本一致时才可继续升级下一个版本。
- 升级 Master 版本后， 请尽快升级 Node 版本。

## 操作步骤

升级集群分为升级集群的 Master kubernetes 版本和升级 Node Kubernetes 版本两个步骤。具体信息如下图所示：
![](https://main.qcloudimg.com/raw/1b4a4b4e25c9d9a66eb4f0c6d609bf49.png)

### 升级 Master Kubernetes 版本
**目前仅支持托管集群 Master 版本升级**，且升级需要花费5 - 10分钟，在此期间您将无法操作您的集群。


#### 注意事项
- **升级 Master 版本属于不可逆操作，请您谨慎执行。**
- 升级 Master 版本后，请尽快升级 Node 节点的 Kubernetes 版本。
- 1.7.8 版本 TKE 集群，网络模式为 bridge ，集群升级不会自动切换网络模式为 cni。
- 集群升级不会切换 kube-dns 为 core-dns。
- 创建集群时设置的部分特性，例如支持 ipvs。集群 Master 版本升级到 1.10 和 1.12 后，将不支持开通。
- 存量的集群升级若 Master 版本是 1.10 以上版本，Node 节点版本在 1.8 版本以下， PVC 功能将不可用。
- 升级完成 Master 后，您需先升级 Node 节点版本才可继续向上升级。

#### 升级 Master Kubernetes 版本操作步骤

1. 登录 TKE 控制台，选择左侧导航栏中的【[集群](https://console.cloud.tencent.com/tke2/cluster)】，进入 “集群管理” 页面。
2. 选择需进行 Master Kubernetes 版本升级的集群 ID，进入该集群的 “Deployment” 页面。
3. 选择左侧导航栏中的【基本信息】，进入集群“基础信息”页面。
4. 在集群“基础信息”页面的集群信息模块，单击 Master 版本右侧的【升级】。如下图所示：
![](https://main.qcloudimg.com/raw/3ba70cdb57fa729d647e3fb2a3aa4a73.png)
5. 在弹出窗口中单击【确定】，等待升级完成。
该示例集群 Kubernetes 版本升级前 Master 版本为1.10.5，升级完成后为 Master 1.12.4。如下图所示：
![](https://main.qcloudimg.com/raw/099ce1d116ac2ecdb995680b154fd23f.png)


### 升级 Node Kubernetes 版本

集群 Master Kubernetes 版本升级完成后，集群列表页将显示该集群节点有可用升级。如下图所示：
![](https://main.qcloudimg.com/raw/05d3f2b65d31d309ad16c33970186dcd.png)
您可通过以下步骤进行升级：


#### 注意事项
 - **升级前，请详细阅读 [升级须知](#UpgradeNotice)。**
 - 升级 Node Kubernetes 版本需先升级 Master Kubernetes 版本。
 - 仅当以下条件生效时可升级 Node 节点版本：
  - Master Kubernetes 版本高于 Node Kubernetes 版本。
  - Node 节点处于运行中。

#### 选择升级方式
升级 Node Kubernetes 版本支持 **重装滚动升级**和**原地滚动升级**两种升级方式。您可按需选择：
- **重装滚动升级**：采用重装节点的方式升级节点版本。支持大版本、小版本升级，例如 1.10 可升级至 1.12，1.14.3 可升级至 1.14.8。
- **原地滚动升级**：原地不重装，仅替换 Kubelet、kube-proxy 等组件。目前仅支持小版本升级，例如 1.14.3 可升级至 1.14.8。




#### 重装滚动升级
基于重装的节点升级采用滚动升级的方式，同一时间只会对一个节点进行升级，只有当前节点升级成功才会进行下个节点的升级。如下图所示：
![](https://main.qcloudimg.com/raw/9a2b7caa360e40aa8a1b919c7917217a.png)
步骤描述如下：
- **升级前检查**：对节点上的 Pod 进行驱逐前的检查。具体的升级前检查项如下：
   - 统计该节点所有工作负载的 Pod 个数，若驱逐节点后，任何工作负载的 Pod 数目变为0 ，则检查不通过，不能进行升级。
   -   以下系统控制面工作负载将被忽略：
		- l7-lb-controller
		- cbs-provisioner
		- hpa-metrics-server
		- service-controller
		- cluster-autoscaler
- **驱逐 Pod**：首先将节点标记为不可调度，随后驱逐或者删除节点上所有 Pod。
- **移出节点**：将节点从集群中移除。该步骤只进行基本的清理工作，不会删除节点在集群中的 Node 实例，所以节点的 label、taint 等属性都可保留。
- **重装节点**：重装节点的操作系统，并重新安装新版本 kubelet。
- **升级后检查**：检查节点是否 ready，是否为可调度的。






##### 重装滚动升级 Node Kubernetes 版本操作步骤
1. 登录 TKE 控制台，选择左侧导航栏中的【[集群](https://console.cloud.tencent.com/tke2/cluster)】，进入 “集群管理” 页面。
2. 选择需进行 Node  Kubernetes 升级的集群 ID，进入该集群的 “Deployment” 页面。
3. 选择左侧导航栏中的【基本信息】，并单击 Node Kubernetes 版本右侧的【升级】。如下图所示：
![](https://main.qcloudimg.com/raw/68c53549dd487d18b202c9dfd09e5aa0.png)
4. 在“升级须知”步骤中，选择升级方式为**重装滚动升级**，仔细阅读升级须知。勾选【我已阅读并同意上述技术条款】，并单击【下一步】。
>! 该升级方式将重装系统，请注意提前备份数据。
>
6. 在“节点选择”步骤中，选择本批次需要升级的节点，并单击【下一步】。
6. 在“升级设置”步骤中，请参考以下信息并按需填写节点信息，并单击【下一步】。
其中【数据盘挂载】与【容器目录】默认不勾选。如果需要将容器和镜像存储在数据盘，则勾选【数据盘挂载】。如下图所示：
![](https://main.qcloudimg.com/raw/e83eb7e851910e9436a1fd2a599f4e4c.png)
>!选择数据盘挂载时，已格式化的 ext3、ext4、xfs 文件系统的系统盘将直接挂载，其他文件系统或未格式化的数据盘将自动格式化为 ext4 并挂载。若您需保留数据盘数据并挂载，可参考 [数据盘挂载](#data)。
>
7. 在“确认”步骤中，确认信息并单击【完成】即可开始升级。
8. 查看节点升级进度， 直至所有节点升级完成。


#### 原地滚动升级
节点原地升级采用滚动升级的方式，同一时间只会对一个节点进行升级，只有当前节点升级成功才会进行下个节点的升级。原地升级目前仅支持同一个大版本的不同小版本升级。如下图所示：
![](https://main.qcloudimg.com/raw/9bfc2ff8fb0af26ba30214a715fe633d.png)
步骤描述如下：
- **组件更新**：替换和重启节点上的 kubelet 和 kube-proxy 组件，参数将被初始化为默认值。
- **升级后检查**：检查节点是否 ready，是否为可调度的。



##### 原地滚动升级 Node Kubernetes 版本操作步骤
1. 登录容器服务控制台，选择左侧导航栏中的【[集群](https://console.cloud.tencent.com/tke2/cluster)】，进入 “集群管理” 页面。
2. 选择需进行 Node  Kubernetes 升级的集群 ID，进入该集群的 “Deployment” 页面。
3. 选择左侧导航栏中的【基本信息】，并单击 Node Kubernetes 版本右侧的【升级】。如下图所示：
![](https://main.qcloudimg.com/raw/68c53549dd487d18b202c9dfd09e5aa0.png)
4. 在“升级须知”步骤中，选择升级方式为**原地滚动升级**，仔细阅读升级须知。勾选【我已阅读并同意上述技术条款】，并单击【下一步】。
5. 在“节点选择”步骤中，选择本批次需要升级的节点，单击【下一步】。
6. 在“确认”步骤中，确认信息并单击【完成】即可开始升级。
7. 查看节点升级进度， 直至所有节点升级完成。

## 相关操作
### 数据盘挂载<span id="data"></span>
>?通过此步骤完成数据盘挂载，可保留数据，避免数据盘被格式化。
>
1. 在“云服务器配置”页面，不勾选【数据盘挂载】。
2. 打开“高级设置”，在“自定义数据”输入以下节点初始化脚本，并勾选【开启封锁】。如下图所示：
```
systemctl stop kubelet  
docker stop $(docker ps -a | awk '{ print $1}' | tail -n +2)
systemctl stop dockerd  
echo '/dev/vdb   /data    ext4   noatime,acl,user_xattr 1 1' >> /etc/fstab
mount -a
sed -i 's#"graph": "/var/lib/docker",#"data-root": "/data/docker",#g' /etc/docker/daemon.json
systemctl start dockerd  
systemctl start kubelet 
```
![](https://main.qcloudimg.com/raw/2998c7dcebca9bcff89fcf0d38586fc9.png)
3. 请根据实际情况进行登录密码及安全组设置，并单击【完成】，等待节点添加成功。

