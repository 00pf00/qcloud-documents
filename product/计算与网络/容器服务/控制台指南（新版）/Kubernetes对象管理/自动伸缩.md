## 操作场景
### 简介
Pod 自动扩缩容功能（Horizontal Pod Autoscaler,HPA）可以根据目标实例（Pod）CPU 利用率的平均值等指标自动扩展、缩减服务的实例数量。本文档将指导您进行 Pod 自动扩缩容。

### 工作原理

HPA 后台组件会定期（30s）向腾讯云云监控拉取容器和 Pod 的监控指标，然后根据当前指标数据、当前副本数和该指标目标值进行计算，计算所得结果作为服务的期望副本数。当期望副本数与当前副本数不一致时，HPA 会触发 Deployment 进行pod副本数量调整，从而达到自动伸缩的目的。 以 CPU 利用率为例，假如当前有 2 个实例， 平均 CPU 利用率（当前指标数据）为 90%，自动伸缩设置的目标 CPU 为 60%， 则自动调整实例数量为：90% * 2 / 60% = 3 个。
>!
>如果用户设置了多个弹性伸缩指标，HPA 会依据各个指标，分别计算出目标副本数，然后取最大值进行扩缩容操作。

## 前提条件
- 已[注册腾讯云账户](https://cloud.tencent.com/register)。
- 已登录 [腾讯云容器服务控制台](https://console.cloud.tencent.com/tke2) 。
- 已创建集群。关于创建集群，详情请参见[创建集群](https://cloud.tencent.com/document/product/457/32189)。

## 操作步骤

### 开启服务自动扩缩容

可以通过以下两种方式开启服务自动扩缩容。

#### 通过设置实例数量调节方式。
1. 单击左侧导航栏中【[集群](https://console.cloud.tencent.com/tke2/cluster)】，进入“集群管理”页面。
2. 单击需要创建服务的集群 ID，进入工作负载 Deployment 详情页，选择【新建】。如下图所示：
![](https://main.qcloudimg.com/raw/7dc7fc44f0142467bbfe5d4256bb6817.png)
3. 在“新建Workload”页面，设置实例数量为**自动调节**。如下图所示：
	- **触发策略**：自动伸缩功能依赖的策略指标。详情请参见[指标类型](#IndicatorType)。
	- **实例范围**：在设定的实例范围内自动调节，不会超出该设定范围。请根据实际需求进行选择。
![](https://main.qcloudimg.com/raw/e95f4a77e444a94fa5132a31d4dc955b.png)

#### 通过新建自动伸缩组
1. 单击左侧导航栏中【[集群](https://console.cloud.tencent.com/tke2/cluster)】，进入“集群管理”页面。
2. 单击需要创建服务的集群 ID，选择【自动伸缩】，单击新建。如下图所示：
![](https://main.qcloudimg.com/raw/1a54a09e60b9adedb44fe717262cac72.png)
3. 在【新建 Hpa 】页面，根据以下提示，设置 HPA 基本信息。如下图所示：
- **名称**：要创建的自动伸缩组的名称。
- **命名空间**：请根据实际需求进行选择。
- **关联 Deployment **：关联 deployment 不能为空，请根据实际需求进行选择。
- **触发策略**：自动伸缩功能依赖的策略指标。详情请参见[指标类型](#IndicatorType)。
- **实例范围**：在设定的实例范围内自动调节，不会超出该设定范围。请根据实际需求进行选择。
![](https://main.qcloudimg.com/raw/58e4cb26913bd125b67c4084b28ecc98.png)
4. 单击【新建】，完成 HPA 的创建。

### 更新服务自动扩缩容规则

可以通过以下两种方式更新服务自动扩缩容规则。

#### 通过更新实例数量
1. 单击左侧导航栏中【[集群](https://console.cloud.tencent.com/tke2/cluster)】，进入“集群管理”页面。
2. 单击需要创建服务的集群 ID，进入工作负载 Deployment 详情页，选择【更新实例数量】。如下图所示：
![](https://main.qcloudimg.com/raw/dd03755048ceb53ec16031e94421035e.png)
3. 在“更新实例数量”页面，据实际需求进行设置。如下图所示：
![](https://main.qcloudimg.com/raw/7ebd8e6d34caa7c7b693a0ef7ab53679.png)

#### 通过修改 Hpa 配置
1. 单击左侧导航栏中【[集群](https://console.cloud.tencent.com/tke2/cluster)】，进入“集群管理”页面。
2. 单击需要创建服务的集群 ID，选择【自动伸缩】，选择需要更新配置的 HPA 所在行右侧的【修改配置】。如下图所示：
![](https://main.qcloudimg.com/raw/913889256e0e7bb918dfec6212bb488b.png)
也可以根据 deployment 筛选目标 HPA，如下图所示：
![](https://main.qcloudimg.com/raw/3892d55e08f7179752a0e9c726601fa1.png)
3. 在“更新Hpa配置”页面，据实际需求进行设置。如下图所示：
![](https://main.qcloudimg.com/raw/0c389ef83f6ee1124771ea54e956fbe4.png)


<span id="Indicatortype"></span>
## 指标类型

### CPU指标
| 指标名 | 单位 | 描述 |
|----------------|---------|------------------------------------------------------|
| CPU 使用量 |  核 | Pod 的 CPU 使用量 |
|CPU 利用率（占节点） |  %  | Pod 的 CPU 使用量占节点总量之比 |
|CPU 利用率（占 Request）| % | Pod 的 CPU 使用量和设置的 Request 值之比 |
|CPU 利用率（占 Limit）|  %  | Pod 的 CPU 使用量和设置的 Limit 值之比 |

### 内存
| 指标名 | 单位 | 描述 |
|----------------|---------|------------------------------------------------------|
| 内存使用量 |  B | Pod 的内存使用量，含缓存 |
| 内存使用量（不包含 Cache） | B | Pod 内所有 Container 的真实内存使用量（不含缓存）|
| 内存利用率（占节点）| %  | Pod 的内存使用量占节点总量之比 |
| 内存利用率（占节点，不包含 Cache）| % |Pod 内所有 Container 的真实内存使用量（不含缓存）占节点总量之比|
| 内存利用率（占 Request） | %  | Pod 的内存使用量和设置的 Request 值之比 |
| 内存利用率（占 Request，不包含Cache）| % | Pod 内所有 Container 的真实内存使用量（不含缓存）和设置的 Request 值之比 |
| 内存利用率（占 Limit） | % | Pod 的内存使用量和设置的 Limit 值之比 |
| 内存利用率（占 Limit，不包含 Cache）| % | Pod 内所有 Container 的真实内存使用量（不含缓存）和设置的 Limit 值之比 |

### 硬盘
| 指标名 | 单位 | 描述 |
|----------------|---------|------------------------------------------------------|
| 硬盘写流量 | KB/s | Pod 的硬盘写速率 |
| 硬盘读流量 | KB/s | Pod 的硬盘读速率 |
| 硬盘读 IOPS | 次/s | Pod 从硬盘读取数据的 IO 次数 |
| 硬盘写 IOPS | 次/s | Pod 把数据写入硬盘的 IO 次数 |

### 网络
| 指标名 | 单位 | 描述 |
|----------------|---------|------------------------------------------------------|
| 网络入带宽 | Mbps | Pod 的入方向带宽之和 |
| 网络出带宽 | Mbps | Pod 的出方向带宽之和 |
| 网络入流量 | KB/s | Pod 的入方向流量之和 |
| 网络出流量 | KB/s | Pod 的出方向流量之和 |
| 网络入包量 | 个/s | Pod 的入方向包数之和 |
| 网络出包量 | 个/s | Pod 的出方向包数之和 |

## 注意事项

- 当指标类型选择为**CPU 利用率（占 Request）**时，必须要为容器设置 CPU Request；
- 策略指标目标设置合理，如设置 70% 给容器和应用，预留 30% 的余量；
- 保持 Pod 和 Node 健康（避免 Pod 频繁重建）；
- 保证用户请求的负载均衡稳定运行；
- HPA 在计算目标副本数时会有一个 10% 的波动因子，如果在波动范围内，HPA 并不会调整副本数目；
- 如果服务对应的 deployment.spec.replicas 值为0，弹性伸缩将不起作用。
- 如果对单个 deployment 同时绑定多个 HPA ，则创建的 HPA 同时生效。请注意绑定多个 HPA 会造成的集群反复扩缩容。
