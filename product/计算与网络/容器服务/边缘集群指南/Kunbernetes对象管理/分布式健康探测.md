# 分布式健康探测 官网文档

## 操作场景

边缘集群由于节点和控制端一般不在一个机房，网络连接不如常规的k8s集群稳定，很可能出现边缘部分节点和apiserver断联的情况；在这种情况下，由于apiserver无法连接该边缘端节点kubelet，造成云端无法准确获取该节点和节点上pod的运行情况。

这种长时间的断联，按照原生kubernetes的默认情况，节点状态会变为Unknown，同时节点会被打上NoSchedule和NoExecute的taints，继而造成节点上的pod被驱逐和重建，同时pod会从service的endpoint中被删除，但是实际上节点也许运行状态正常，因此pod的驱逐和重建是完全不必要的。

另外这种情况会造成节点pod的大规模重建，继而造成重建过程中服务的访问波动甚至不可用，对服务质量造成严重影响。

同时pod的重建有可能造成重建过程中节点的网络和IO带宽过高，一方面可能造成节点短时间内的负载过高，另一方面可能会增加用户的网络费用；除此之外，很多应用强依赖pod的IP，重建会造成pod的ip变动，造成服务需要重新部署；

## 功能介绍

边缘计算场景仅仅依赖边缘端和apiserver的连接是不足以判断节点是否异常的，会因为网络连接问题造成误判。

相较于云端和边缘端的连接，显然边缘端节点之间的连接更为稳定，具有一定的参考价值，因此边缘健康检查功能除了apiserver外，还引入了节点的评估因素，进而对节点进行更为全面的状态判断。

通过这个功能，能够避免由于云边网络不稳定造成的大量的pod迁移和重建，保证了服务的稳定。

此外，边缘健康检查多地域功能还支持多地域内的节点健康检查，可以方便地将节点依据地域或者其他方式进行分组，实现组内检查。在边缘计算场景下，同一个集群内的节点很可能分布在不同地域，不同地域之间的节点通常不可互通。在这种场景下，不同地域的节点之间相互探测是没有意义的，也会影响健康探测机制效果

## 前提条件

该功能需要打开节点的51005端口，以便节点之间进行分布式智能健康探测

## 操作步骤

- 边缘检查功能默认关闭，开启方式如下:
       在集群的基本信息页面将 开启Edge Health的开关打开即可
       ![img](file:///C:/Users/V_XIXI~1/AppData/Local/Temp/msohtmlclip1/01/clip_image002.png)

- 多地域检查功能 

- - 按地域划分节点：节点地域是根据节点上的 tencent.tkeedgehealth/topology-zone 标签区分，如tencent.tkeedgehealth/topology-zone: zone0 表明将节点划分到地域 zone0; 标签取值相同的节点视为同一个地域。开启多地域功能时，同一个地域内的节点会相互探测和投票。可通过下图方式给节点加上地域标签
          ![img](file:///C:/Users/V_XIXI~1/AppData/Local/Temp/msohtmlclip1/01/clip_image004.png)
  - 在保证开启边缘检查功能的前提下，打开多地域检查开关
          ![img](file:///C:/Users/V_XIXI~1/AppData/Local/Temp/msohtmlclip1/01/clip_image006.png)
  - 需要注意的是如果开启此功能但是没有给节点打上tencent.tkeedgehealth/topology-zone的标签，则该节点只会检查自己的健康状态；如果没有开启此功能，则一个集群内的所有节点会进行相互检查，即使节点上有tencent.tkeedgehealth/topology-zone标签

边缘检查和多地域检查功能都需要一定的部署和配置时间，需要稍等一段时间生效。
