安全组是一种虚拟防火墙，具备有状态的数据包过滤功能，用于设置云服务器、负载均衡、云数据库等实例级别的流量访问控制，是重要的网络安全隔离手段。

为满足业务需要，日常运维中可能会有安全组的变更的诉求，而变更安全组往往会对关联实例产生一定影响，为保证变更顺利进行，并将业务影响降至最低，本文提供安全组变更时的流程建议，及最佳实践案例供您参考。


## 安全组变更流程
通过安全组变更流程规范，不仅能够在变更过程中及时发现问题，更能在变更过程中最大限度地降低业务影响。
>?实际操作时建议您按照流程规范操作，保证变更顺利进行；如您明确无业务影响，也可根据实际情况适当简化操作。
>
![](https://qcloudimg.tencent-cloud.cn/raw/e376c0d2ec65bff48d1123b01d760d57.svg)

## 安全组变更示例

### 场景描述
+ 部门A的VPC A和部门B的VPC B已经通过云联网或对等连接打通，VPC B的云服务器可以访问VPC A中云服务器上的80服务。
+ 部门A安全部门在巡检中发现，IP地址为172.21.10.13和172.21.10.17的云服务器持续扫描vpcA中的非开放端口，造成了攻击式影响。
+ 部门A业务运维人员接安全部门通知后，决定在安全组规则中对来源IP为172.21.10.13和172.21.10.17的流量进行封禁。
![](https://qcloudimg.tencent-cloud.cn/raw/b1b027995109970bb81bbcc83ab5d813.png)

### 操作步骤
>! 建议在业务停服或业务低峰时进行操作。
>
#### 步骤一：克隆安全组
1. 登录 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=71)，在左侧导航中选择“安全 > 安全组”。
2. 找到部门A受访问攻击实例关联的安全组，例如sg-4ul4hbrh，单击**更多** > **克隆**。
 ![](https://qcloudimg.tencent-cloud.cn/raw/cbb82322a9ce001a67af53286f997276.png)
3. 输入克隆安全组的新名称，并单击**确定**。

#### 步骤二：修改克隆后的安全组
>?本例中，假设安全组关联2个实例，经评估，可将web1实例灰度作为测试实例。
>
1. 单击**克隆安全组 ID**，进入安全组规则详情页。
2. 在入站规则页签，单击**添加规则**。
3. 在弹出的“添加入站规则”对话框中，添加攻击方来源IP（例如172.21.10.13和172.21.10.17）的“拒绝”策略，单击**完成**。
>!此处经常出现的错误如下：
>+ **策略填写错误**：例如本例是要禁用攻击方IP的流量，那么策略应该是“拒绝”，如果手误填为“允许”，将导致无法按照预期禁用流量。
>+ **填写网段范围太大**：例如本例中只需要禁用VPC B中业务1和业务2两台云服务器，而业务3仍需要与VPC A通信，如果将入站规则中“来源”填为“172.21.10.0/24”网段，将导致VPC B中业务3也无法访问VPC A中的云服务器，不符合预期，因此，如果涉及实例不多，请尽量填写具体IP地址，如涉及较多，请尽可能精确填写网段范围，减少不必要的影响。
>
![](https://qcloudimg.tencent-cloud.cn/raw/8625188b04e703c2403b047a1d401f6e.png)

#### 步骤三：将修改年后的克隆安全组绑定到测试实例上
>?当实例绑定多个安全组时，安全组将由上至下顺序匹配，本例请将克隆安全组移至测试实例原有安全组的最上面，确保克隆安全组优先匹配生效。
>
1. 单击克隆安全组右侧操作列的**管理实例**，进入关联示例界面。
2. 单击**新增关联**，选择需要关联的实例，例如测试实例。
3. 单击**确定**。

#### 步骤四：解绑测试实例上的安全组 
>? 
>+ 经观测本例中测试实例上的业务持续正常。
>+ 如果实例只关联了一个安全组，则无法解绑安全组。

1. 单击克隆安全组右侧操作列的**管理实例**，进入关联示例界面。
2. 找到需要解绑安全组的实例，单击**移出安全组**，本例移出测试实例上关联的克隆安全组。


#### <span id="step5">步骤五：修改原安全组
1. 单击**原安全组 ID**，本例中为VPC A中web1和web2绑定的原安全组ID，进入安全组规则详情页。
2. 在入站规则页签，单击**添加规则**。
3. 在弹出的“添加入站规则”对话框中，添加攻击方来源IP（例如172.21.10.13和172.21.10.17）的“拒绝”策略，请确保规则中来源、策略等填写无误后，单击**完成**。

#### 步骤六：2分钟后无条件变更回退
1. 修改完原安全组规则后，等待约2分钟，进行无条件回退，即删除 [步骤五](#step5) 中对安全组的修改。
2. 观察相关业务是否均持续正常，至少观测30分钟。
   + 如所有业务正常，则执行下一步。
 + 如有部分业务反馈异常，建议终止本次变更，待问题回溯并评估业务影响后，再重新发起变更。

  本例中业务观测30分钟后，业务均正常。
	
#### 步骤七：再次修改原安全组
1. 重复步骤五的修改。
2. 观察相关业务是否均持续正常，至少观测30分钟。
   + 如所有业务均正常，则变更成功，结束。
 + 如有部分业务反馈异常，建议终止本次变更，待问题回溯并评估业务影响后，再重新发起变更。
	
