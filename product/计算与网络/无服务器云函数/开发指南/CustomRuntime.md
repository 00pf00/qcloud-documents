# Custom Runtime
在云函数SCF已支持的开发语言及版本的标准运行环境外，为了满足更多个性化开发语言及版本的函数实现，云函数SCF提供了Custom Runtime即可定制化运行环境，通过将函数的运行时开放自定义实现，开发者可以根据需求使用任意开发语言的任意版本来编写函数，云函数SCF与Custom Runtime通过http协议通信完成事件的响应处理。

## Custom Runtime部署文件构成
Custom Runtime部署相关文件说明：
**bootstrap**：Custom Runtime固定的可执行引导程序文件，由开发者创建同名可执行程序文件，通过自定义语言及版本实现，直接处理或者通过启动其他可执行文件来处理，函数运行时的初始化和调用
**函数文件**：开发者通过自定义语言及版本开发实现的函数程序文件
**运行时依赖的库文件或可执行文件**：根据自定义语言及版本运行时需要，添加相关依赖的库文件或可执行文件

通过部署包方式发布，文件构成如下：
* bootstrap（必须）
* 函数文件（必须）
* 运行时依赖的库文件或可执行文件（可选）

由于部署包体积限制，运行时依赖的库文件或者可执行文件体积较大时，建议通过部署包绑定层的组合方式发布，文件构成如下：
1. 部署包：
* 函数文件（必须）
2. 层：
* bootstrap（必须）
* 运行时依赖的库文件或可执行文件（可选）

注意：以上部署文件中的可执行文件上传云函数SCF前请务必设置好文件的可执行权限，并将部署文件打包后通过zip包方式直接上传或通过cos上传，由于”文件夹上传“会更改文件的可执行权限，导致bootstrap及其他可执行文件无法运行，所以针对Custom Runtime，控制台上传部署包屏蔽了文件夹方式选项。

## Custom Runtime运行机制
Custom Runtime将函数的运行时周期分为初始化阶段和调用阶段，初始化阶段只在实例冷启动过程中一次性执行，调用阶段是实例启动之后每次响应事件调用的执行过程。
不同开发语言及版本的启动时间和执行时间会有差异，云函数SCF针对Custom Runtime增加了**初始化超时时间**配置，与**执行超时时间**配置一起管理Custom Runtime的运行时生命周期。

### 函数引导加载
云函数SCF首先检索部署包中的可执行引导文件boostrap，如果文件不存在或不可执行，且函数绑定层，接下来会检索函数绑定层的指定系统路径/opt/bootstrap是否存在且可执行。
检索到bootstrap文件且可执行，执行boostrap程序，进入函数初始化阶段
未检索到bootstrap文件或文件不可执行，启动失败，返回bootstrap文件不存在
### 函数初始化
开始于执行bootstrap引导程序文件，开发者可以根据需要在bootstrap中自定义实现个性化操作，直接处理或调用其他可执行程序文件来完成初始化操作。
以下为建议在初始化阶段完成的基础操作：
* 读取系统内置环境变量（如_HANDLER、SCF_RUNTIME_API等）及用户自定义配置的环境变量，并根据需要设定运行时的环境变量
* 加载自定义语言及版本依赖的库文件及扩展程序等，如仍有依赖文件需要实时拉取，可下载至/tmp目录
* 解析函数文件，并执行函数调用前所需的全局操作或初始化程序（如开发工具包客户端http client等初始化、数据库连接池创建等），便于后续调用阶段复用
* 初始化阶段完成后，需要主动调用运行时API，访问初始化就绪接口（/runtime/init/ready）通知云函数SCF，Custom Runtime运行时已完成初始化，进入就绪状态，否则云函数SCF会持续等待，直到达到配置的初始化超时时间后，结束Custom Runtime并返回初始化超时错误；重复通知，会以首次访问时间作为就绪状态时间结点。
#### 日志及异常
云函数SCF将会收集初始化阶段所有标准输出上报至日志，函数初始化在超时限制内正常执行完成，初始化阶段的日志会与首次调用日志合并返回；如果在初始化超时限制内由于错误异常未能完成执行，则执行结果返回初始化超时错误，写入标准输出的程序错误及异常日志会上报给云函数SCF，在控制台日志及日志查询中展示

### 函数调用
函数调用阶段需要开发者自定义实现事件获取、调用函数及结果的返回，并循环处理这个过程

* 长轮询获取事件，开发者通过自定义语言及版本实现http client访问运行时API的事件获取接口（/runtime/invocation/next），响应正文包含事件数据，在一次调用内重复访问此接口均返回相同事件数据，http client请不要设置get方法的超时。
* 根据环境变量、响应头中所需信息及事件信息构建函数调用的参数
* 推送事件信息等参数数据，调用函数处理程序
* 访问运行时API响应结果接口（/runtime/invocation/response）推送函数处理结果，首次调用成功为事件终态，云函数SCF将进行状态锁定，推送后结果不可变更
* 如果函数调用阶段出现错误，通过访问运行时API调用错误接口（/runtime/invocation/error）推送错误信息，同时本次调用结束，首次调用视为事件终态，云函数SCF将进行状态锁定，继续推送结果不可变更
* 清理释放本次调用结束后不再需要的资源
#### 日志及异常
云函数SCF将会收集调用阶段所有标准输出上报至日志。
云函数SCF下发事件后，Custom Runtime较长事件未获取事件，超过函数执行超时限制，云函数SCF将结束实例并返回等待获取事件超时错误。
云函数SCF下发事件后，Custom Runtime获取到事件但未在函数执行超时限制内返回执行结果，云函数SCF将结束实例并返回执行超时错误。




## 运行时API
由于Custom Runtime由开发者使用自定义语言及版本实现，与云函数SCF之间的事件下发、处理结果反馈等需要通过标准协议来进行通信，这里云函数SCF提供了运行时API，来满足Custom Runtime生命期中与云函数SCF的交互需要

云函数SCF内置有以下环境变量：
SCF_RUNTIME_API:运行时API地址
SCF_RUNTIME_API_PORT:运行时API端口

Custom Runtime可以通过SCF_RUNTIME_API：SCF_RUNTIME_API_PORT来访问运行时API

* 路径：/runtime/init/ready

方法：post
运行时初始化完成后，调用接口标识进入就绪状态

* 路径 ：/runtime/invocation/next

方法：get
获取调用事件
响应体包含事件数据event_data
响应头包含以下信息：
Scf_Runtime_Request_Id 请求 ID，用于标识触发了函数调用的请求
Scf_Runtime_Memory_Limit_In_Mb函数内存限制，单位MB
Scf_Runtime_Time_Limit_In_Ms函数超时时间，单位毫秒

* 路径：/runtime/invocation/response

方法：post
函数处理结果
在运行时调用函数处理程序后，将来自函数的响应推送到调用响应接口

* 路径：/runtime/invocation/error

方法：post
函数返回错误推送到调用错误接口，标识本次调用失败
