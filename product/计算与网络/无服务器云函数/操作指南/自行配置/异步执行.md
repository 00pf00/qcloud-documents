# 异步执行

在音视频转码、ETL大体量数据处理、AI推理等单任务重计算的场景下，函数的单实例运行时需要更多算力更长时间的稳定运行；另一方面，函数的调用端如果长时间阻塞等待执行结果，会持续占用调用方资源，并且对整个调用链路的稳定性有极高的要求。
目前云函数无论是在执行超时时间上限方面，还是在运行机制方面都面临着极大的挑战。为了解决以上问题，SCF云函数提供了函数的异步执行模式，一种全新的函数运行机制

## 运行机制

### 基础原理

![eba9d308fc5ea99988ade14d2f57775b](异步执行.resources/5B06FEE0-EDBC-454C-AFAF-371305EC1C04.png)
函数高级配置启用异步执行后，通过同步（api网关）或者异步（COS、CKafka、Timer等）等调用端做事件调用，函数将以异步执行模式响应事件，即完成事件调度后立即返回事件的调用标识RequestId，调用操作结束，调用端无需阻塞等待；返回RequestId的同时，调用引擎将并行下发事件到函数运行时，开启函数逻辑执行，进入异步执行状态后，执行日志将实时上报至日志服务，提供对异步执行事件运行情况的实时反馈

### 注意事项

* 由于运行机制差异，暂不支持同步/异步执行模式切换，只有在创建函数时可以选择是否开启"异步执行"，函数创建后该配置将锁定，不提供修改更新操作
* 事件调用成功，返回信息只包含RequestId，事件执行结果，需要在函数代码逻辑中自行实现callback特定的api或者发送通知消息
* 实时日志，强依赖日志服务，默认开启CLS，并需要在高级配置中选定已有日志桶及主题，如果没有日志桶或日志主题，需要新创建；如不开启CLS，将无法获取到实时日志
* 异步执行，目前支持最长24小时执行时长（如需更长运行时长，可通过工单方式提交申请），如果通过函数运行角色来获取对其他云服务组件的访问权限，角色秘钥有效期最长为12小时，需要考虑延长有效期策略或使用长期有效秘钥

## 状态追踪

### 基础原理

![22311ce39d0ed01b938ae0c563c9ad3f](异步执行.resources/9B112472-B99F-4D50-B70C-204FDBA0B763.png)

函数高级配置启用状态追踪后，针对异步执行的事件，将开始记录并上报事件响应的实时状态，并提供事件状态的统计、查询及终止等事件管理相关服务。

### API

事件管理相关服务Api通过云api的方式提供：

#### GetAsyncEventOverview

异步执行函数，事件运行状态数据汇总概况，包含以下事件状态

* 运行中：事件异步执行中
* 调用成功：事件异步执行成功，正常返回
* 调用失败：事异步执行件失败，异常返回
* 调用终止：用户主动对运行中的事件发起终止，异步执行停止并返回

详细参数及返回结构体，请参见[获取函数异步事件概览](https://cloud.tencent.com/document/product/583/17235)

#### ListAsyncEvents

异步执行函数，事件信息数据列表，提供根据事件RequestId、函数名、函数版本、事件状态、事件调用/结束时间等条件对异步执行事件信息进行查询

详细参数及返回结构体，请参见[拉取函数异步事件列表](https://cloud.tencent.com/document/product/583/17235)

注意：可以查询数据范围为开启事件追踪后3天内数据

#### TerminateAsyncEvent

异步执行函数，通过调用返回的事件RequestId，对运行中异步执行事件下发终止指令，终止完成后返回

详细参数及返回结构体，请参见[终止正在运行中的函数异步事件](https://cloud.tencent.com/document/product/583/17235)

### 注意事项

* 产生的事件状态数据将为您保留3天，将以3天为时间窗口滑动清理，如需保留全部记录，需要定期拉取并保存至自有存储。
* 关闭状态追踪后，异步执行事件相关记录、统计、查询、终止等事件管理相关服务将停止提供，已产生的事件状态数据将在3天内清空
* 异步运行函数，事件调用的QPS限制为并发数量的十分之一，超出部分将被限制，响应失败
* 由于请求QPS超限、账户欠费等原因，事件调用将由调度引擎直接返回对应异常，不会生成事件状态记录
