
SCF 支持开发者将容器镜像部署为函数的功能。本文介绍镜像部署函数的背景信息、工作原理、函数开发、函数日志打印、冷启动优化、计费说明及使用限制。

## 简介

SCF 云函数从设计开始即是基于云原生架构的 FaaS 产品。在 Runtime 层支持容器镜像部署为函数后，产品形态整体向容器化生态迈进。一方面，解决函数运行时的环境依赖问题，给予用户更大的自由发挥空间。另一方面，产品形态层面的呈现使得用户无需受困于 Kubernetes 集群管理、安全维护、故障诊断等技术门槛，将弹性伸缩、可用性等需求下沉至计算平台，进一步释放云计算能力。

## 工作原理
您在开发函数具体的逻辑之前，首先需要确认函数为事件函数还是 Web 函数。

云函数在函数实例初始化阶段，获得镜像仓库的临时用户名和密码做为访问凭证来拉取镜像。
镜像拉取成功后，根据指定您所定义的启动命令 `Command`、参数 `Args`及 端口（固定为9000）启动您定义的 HTTP Server。
而后，HTTP Server 将接收云函数的所有入口请求，包括来自您的事件函数调用及 Web 函数调用。

开发函数原理如下图所示：
![](https://main.qcloudimg.com/raw/f282ea394c70d8d897cecaf8fc785c3a.png)

## 基于镜像部署的函数开发

### HTTP Server 搭建

通过上述的工作原理，您已经认识到 HTTP Server 在整个函数运行形态中所在的位置。所以，基于镜像部署的函数，您必须监听9000端口。否则可能会导致请求超时，出现以下错误：“`请求超时，请确认您已开启9000端口的监听`”。

### 函数入参

**envet**：POST请求体（HTTP Body），请求体体包含事件数据，结构参见[触发器事件消息结构汇总](https://cloud.tencent.com/document/product/583/31927)；

**context**：请求头（HTTP Header）
- 公共参数，用于标识用户和接口签名的参数，每次请求中均需携带；
- 通过X-Scf-Request-Id获取当前请求ID。

详细列表如下表所示。

>? 
> - 事件函数和 Web 函数均包含Common Headers；
> - 公共请求头由云函数生成，主要包含权限、函数基本信息等。
>

|Header 字段|描述|
| -------------------------------- |---------------|
| X-Scf-Request-Id | 当前请求ID |
| X-Scf-Memory | 函数实例运行时可使用的最大内存 |
| X-Scf-Timeout | 函数执行的超时时间 |
| X-Scf-Version | 函数版本 |
| X-Scf-Name | 函数名称 |
| X-Scf-Namespace | 函数所在命名空间 |
| X-Scf-Region | 函数所在地域 |
| X-Scf-Appid | 函数所有者的Appid |
| X-Scf-Uin | 函数所有者的Uin |
| X-Scf-Session-Token | 临时 SESSION TOKEN |
| X-Scf-Secret-Id | 临时 SECRET ID |
| X-Scf-Secret-Key | 临时 SECRET KEY |
| X-Scf-Trigger-Src | Timer（使用定时触发器时） |

### 内置环境变量

自定义镜像场景相较于基于代码包部署，在容器内置的环境变量做了变更，您可以根据实际需要进行引用。

|环境变量 Key|具体值或值来源|
| -------------------------------- |---------------|
| TENCENTCLOUD_RUNENV | SCF |
| USER_CODE_ROOT | /var/user/ |
| USER | qcloud |
| SCF_FUNCTIONNAME | 函数名 |
| X-Scf-Name | 函数名称 |
| SCF_FUNCTIONVERSION | 函数版本 |
| TENCENTCLOUD_REGION | 区域 |
| TENCENTCLOUD_APPID | 账号APPID |
| TENCENTCLOUD_UIN | 账号UIN |

## 函数调用

事件函数，用户需要监听固定路径“/event-invoke”来接受函数调用请求；

Web 函数，用户无需监听指定路径，API网关会以7层反向代理的方式透传请求路径。

## 函数日志打印

SCF 将以无侵入的方式，收集在容器内所产生的stdout、stderr等标准输出日志，并上报至日志模块。您在调用函数后，可以在控制台看到日志聚合展示效果。

## 冷启动优化

镜像由于增加了基础环境、系统依赖等文件层，相较于基于代码包部署的完全内置，无疑带来了额外的文件下载和镜像解压的时间。为了进一步降低冷启动时间，推荐您使用以下策略：

 - 在同一地域创建镜像仓库与函数，这样在函数触发镜像拉取时会使用VPC网络进行拉取，以此获得更快更稳定的镜像拉取效率；
 - 镜像制作秉承最小化原则，即仅包含必要基础环境、运行依赖，去除不必要的文件等；
 - 镜像部署搭配预置并发功能，预先启动函数实例，达到最优降低冷启动的体验，详情请参见[预置并发](https://cloud.tencent.com/document/product/583/46743)。

## 计费说明

使用镜像部署函数的计费项与使用代码包部署的计费项完全一致。更多信息，请参见[计费方式](https://cloud.tencent.com/document/product/583/12284)。


## 使用限制

 - 镜像大小
   - 暂仅支持镜像（解压前）大小最大为1Gi，并建议您根据镜像的大小来选择适合的函数实例执行内存。

|镜像大小（X）|执行内存（Y）|
| -------------------------------- |---------------|
| X<256MB | 256MB<Y<512MB |
| 256MB<X<512MB | 512MB<Y<1Gi |
| 512MB<X<1Gi | Y>1Gi |

 - 镜像仓库访问
   - 仅支持腾讯云的 TCR 产品，个人版及企业版，更多请参见[镜像仓库](https://cloud.tencent.com/product/tcr)
   - 仅支持同地域同地域（Region）下私有镜像仓库的镜像读取。

 - 容器内文件读写权限
   - 默认 /tmp 可读可写，建议如果要输出文件请输出到 /tmp 下，其它目录的读写权限由镜像文件系统控制；
   - 避免使用到其它用户存在限制访问或执行的文件；
   - 容器内文件可写层存储空间限制，512M。

 - 构建镜像的客户端限制，满足其中之一即可
   - Docker image manifest V2, schema 2 (使用 Docker version 1.10 或者更新版本)
   - Open Container Initiative (OCI) Specifications (v1.0.0 及以上)
