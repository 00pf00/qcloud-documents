

本文分享了腾讯在线教育使用云函数的真实案例。腾讯在线教育团队是：
- IMWeb 团队隶属腾讯公司，是国内最专业的前端团队之一。
- 专注前端领域多年，负责过 QQ 资料、QQ 注册、QQ 群等亿级业务。
- 目前聚焦于在线教育领域，精心打磨腾讯课堂、腾讯企鹅辅导及 ABCmouse 三大产品。

## 技术方案
腾讯在线教育团队在传统的 Web 应用方向其实有众多技术方面的尝试，包括传统离线包、PWA 离线应用等，但是每个技术栈都有其优点与缺点，目前团队的技术方案对比如下图所示：
![](https://img.serverlesscloud.cn/2020522/1590144485915-02%E5%89%AF%E6%9C%AC.jpg)
从上述表格可以看到，SSR 在首屏渲染以及 SEO 等方面都有不错的表现，这也是团队想在 SSR 技术方面深挖的初衷。SSR 方案选择上主要考虑 SSR 应用的性能及运维成本两方面。

### SSR 应用的性能
类 React 的应用的 SSR 的本质为：在服务端调用 React 的 renderToString 方法将 React 组件渲染成 HTML 字符串。那么对于复杂的 SSR 应用来说，可能存在大量的 CPU 密集型计算，这并不是 Node 所擅长的领域，如何优化这方面的性能也是我们所关注的重点。同时由于离线包的环境依赖性（依赖 App），那么在传统的 Web 环境内是否可以有一套完整的解决方案来缓存相关的页面，从而提高首屏的性能，也是关注点之一。

### SSR 的运维成本

对于大多数前端工程师来说，在服务的运维方面可能有时并不那么得心应手。那么服务的可用性方面，也成为了做技术选型时所考虑的重点方向之一。



根据以上两个方面，可将考虑因素总结为如下图所示的两点：
![](https://img.serverlesscloud.cn/2020522/1590142914249-03%E5%89%AF%E6%9C%AC.jpg)

## 腾讯在线教育团队 SSR 架构方案介绍

团队使用的 SSR 技术架构图如下所示：
![](https://img.serverlesscloud.cn/2020522/1590142988895-04%E5%89%AF%E6%9C%AC.jpg)
接下来我们从代码组织、性能优化、运行上下文三个方面来详细讲解团队现有方案。

### 代码组织

在 PC/H5 项目中均采用了同构的模式来构建 SSR 应用。如下图所示：
![](https://main.qcloudimg.com/raw/e013745ed1c2fbb6c985ac4514ec0dce.jpg)

在同构的模式下，业务开发者更关注业务的功能本身，而不用太过关心运行时的问题，但同时也要注意以下几点：

- 传统浏览器中的常量使用，例如 window、document 等。
- HTTP 数据请求库必须同时支持服务端和客户端。
- 合理使用 React 应用的生命周期。
- 通过注入环境变量来区分当前运行时环境。

### 性能优化

#### 接口动静分离
页面的渲染通常依赖后端的相关数据，而数据可以拆分为动态数据与静态数据两个部分：
- 静态数据：页面中不经常变更的数据。例如，企鹅辅导产品产品的课程标题、课程描述等。
- 动态数据：页面中与用户登录态相关的数据。例如，课程是否已经购买、当前课程的折扣等。

对接口做动静分离的意义在于，我们可以利用静态数据的时延性敏感度低的特性做缓存，在服务端利用静态数据渲染页面，之后在服务端利用动态数据做二次渲染。主要逻辑如下图所示：
![](https://main.qcloudimg.com/raw/5672f36742f10b4382507cbc6ad54ca9.jpg)
我们利用 Redis 对静态数据渲染出来的页面做缓存，这样不仅可以加快 SSR 的渲染时间，同时可以提高单机的 QPS（`renderToString` 在一定意义上为 CPU 密集型操作）。

#### 浏览器中利用 PWA 做离线缓存
同时在客户端中，我们可以利用 PWA 来做离线缓存，缓存静态数据直出的 HTML 页面，从而进一步的提高了直出页面的首屏性能。主要逻辑如下图所示：
![](https://main.qcloudimg.com/raw/30da0e7fe04dd722c9b0d0a42602e065.jpg)


### 运行上下文
由于后端应用的运维复杂性、维护成本较高等问题，这里我们使用了 Serverless（腾讯云云函数 SCF） 来做直出应用的部署。得益于 Serverless 架构模式的天然优势，我们不用再关心服务的运维、服务的扩容等问题。
![](https://main.qcloudimg.com/raw/5c4bc1dae97574309cd0c610aec8c908.jpg)
如上图所示，SSR 应用本质为一个 Node 应用，但是 SCF 的调用本质为一个 Event 事件。针对此问题我们采用了如下方法兼容这两种模式：
对自研 Node 框架（imserver）做了一层 Serverless 的封装，得益于腾讯云 Serverless Framework 提供了很多标准化的接口，封装自研 Node 框架（imserver） 的过程十分便捷。同时还在入口做了 Event 到 Koa Request Context 的兼容。如下图所示：
![](https://main.qcloudimg.com/raw/aedaec2397e8ea4d59eb58c4ff2baba2.png)


## SSR 的技术方案落地过程中的问题

### 问题1：云函数拆分

业务中有多个页面是通过 SSR 实现的，采用了腾讯云云函数来实现 SSR 之后，就会遇到一个问题：是合并到一个云函数中（业务级），还是拆分为多个云函数（页面级）。
答案肯定是页面级会比较好，主要的优点如下：
- 云函数互相独立。假设页面 A 云函数调用失败，并不会影响到业务 B 的云函数。
- 云函数包的大小会降低。由于云函数的冷启动过程，代码的包的大小对函数的冷启动时间也有一定的影响。


这里我们基于当前的项目做了云函数的自动化构建，通过 `.scfssr.json` 的配置文件自动生成相应的云函数，对现有的开发无任何影响，只是在构建的时候生成多个云函数，降低了应用的维护成本及开发成本。
同时得益于云函数的构建过程，我们可以对单个云函数的代码做瘦身，通过对 `package.json` 中的依赖分析，剔除一些云函数容器中已经内置的工具包，以及对云函数所依赖的第三方包做相应的引入分析，去除冗余。如下图所示：
![](https://img.serverlesscloud.cn/2020522/1590143237084-15%E5%89%AF%E6%9C%AC.jpg)



### 问题2：云函数发布优化
下图为我们设计的基于腾讯云云函数的多云函数直出方案逻辑：
![](https://main.qcloudimg.com/raw/14a6d5a3d757bce73d4e33dfdcf1a415.jpg)
可查看当我们有版本更新时，发布流程是比较复杂的，步骤也相当繁琐：


#### 配置过程：初始化进行一次
1. 在函数中创建 release、prohub 别名，可预先指向 $LATEST 版本。
-  API 网关中创建服务 A，配置 API 网关指向函数 B release 别名，并发布到 API 服务的 release stage 中。
- 修改 API 网关，指向函数 B prehub 别名，并发布到 API 网关服务的 prehub stage 中。
- 修改 API 网关，指向函数 B 的默认流量，并发布到 API 网关服务的 dev stage 中。
至此 API 网关的配置完成，后续无需在 API 网关上再次修改及发布配置。

#### 开发测试发布过程：持续开发测试发布上线

1. 在函数上持续开发，一次发布版本 1、2、3。
- 需开发测试最近版本时候，配置 `$DEFAULT` 别名指向 $LATEST 版本，可基于此版本持续开发修改，修改完成后发布版本。
- 版本3可进入预发布环境时，配置 prehub 别名指向版本3，在预发布环境可进行测试和体验。
- 版本2已经在预发布体验完成，可上线，将 release 别名灰度从版本1切换至版本2。
- 通过监控及日志查看灰度过程，版本2的流量是否正常上涨，版本1的流量是否正常下降，及发布过程中的各版本错误情况以及总体错误情况。


为优化云函数的发布流程，我们基于腾讯云 Serverless 所提供的 Node SDK 做了一键发布 SCF 的工具。如下图所示：
![](https://main.qcloudimg.com/raw/603eb09fd46455c11b608e7c3a0ad6e5.jpg)


一个完整的 SCF SSR 应用生命周期如下图所示：
![](https://main.qcloudimg.com/raw/9e8cfdea8d1e951c19637a1777cb5b45.jpg)

## 腾讯云 Serverless SSR 方案的优点及后续规划

使用基于腾讯云云函数的 SSR 方案，节省了众多的服务运维成本，得益于腾讯云 Serverless 的日志系统，所有的单个 SSR 应用请求在日志平台都有完整的链路，定位问题与处理问题的速度都有了质的提升。

因为 Serverless 的架构模式会存在冷启动时间较长的问题，虽然腾讯云云函数在这方面已经做了很多技术优化，例如预启动容器等，但是我们在业务方面也可以尝试优化，例如在接入层做了服务的降级优化。如下图所示：
![](https://main.qcloudimg.com/raw/1be62a79c157c343328e33f65daffb80.jpg)
后续的优化方案还可以从灰度、多维降级等方面来做改进。

## 使用 SSR 技术的建议

- 如果想追求更好的用户体验，建议针对核心业务做 SSR 优化，搭配 Serverless 来做服务的部署与运维。有了 Serverless 的支持，我们可以不用像以前一样关心机器的运维和扩容，可提高团队生产力。
- 在有了 SSR 之后，建议可进一步完善自己业务的 devops 流程，将整个研发链路打通，从开发到测试再到部署都可高效进行。
- 推荐使用业务接入层来做服务降级，提高 SSR 应用的可用性。





