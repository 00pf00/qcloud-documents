# 函数部署

### 步骤一 环境准备

在开始部署云函数前，您需要：
1. 确保已经在您自身的电脑上安装好 Python2.7 环境和 Pip 工具。
> **您也可以直接通过下载示例代码的压缩包，而略去环境搭建和本机代码编写工作，**[**点我下载**](https://main.qcloudimg.com/raw/fa1c5bf83a30e7d8dd4c631fee075583.zip)。

2. 获取您自身账号的 Secret ID 和 Secret Key,在云函数中调用 AI 和 COS 的 SDK 接口时需要用到。您可以在 [**云 API 密钥控制台**](https://console.cloud.tencent.com/cam/capi) 中查看对应信息。如下图所示：
![](https://main.qcloudimg.com/raw/78242580d3d1949cd15ac6be83e84d01.png)

3. 前往[**对象存储 COS 的控制台**](https://console.cloud.tencent.com/cos5/bucket)，创建一个 bucket，一方面用于永久存放前端上传过来的图片（可选），另外还需要用做 AI 接口做图片识别的临时存储空间。

4. 前往 [**智能图像控制台**](https://console.cloud.tencent.com/ai/ocr/general) 开通通用印刷体识别功能，单击【开通服务】即可。

### 步骤二 创建云函数 Word_Recognition
1. 首先在本地创建需要放置函数代码的文件夹，并通过命令行进入该目录下，直接执行 Pip 命令安装文字识别 SDK：
```
pip install qcloud_image -t .
```
2. 在函数代码文件夹的根目录下，使用下面的示例代码创建 Python 文件，可以命名为：Word_Recognition.py。
```
# -*- coding: utf-8 -*-
import os
import datetime
import base64
from qcloud_cos_v5 import CosConfig
from qcloud_cos_v5 import CosS3Client
from qcloud_image import Client
from qcloud_image import CIUrl, CIFile, CIBuffer, CIUrls, CIFiles, CIBuffers
import sys
import logging

print('Loading function')

logging.basicConfig(level=logging.INFO, stream=sys.stdout)

appid = 'xxxxxxxx'  # 请替换为您的 APPID
secret_id = u'*****************'  # 请替换为您的 SecretId
secret_key = u'****************'  # 请替换为您的 SecretKey
region = u'ap-shanghai'           # 请替换为您 COS Bucket 所在的地域
bucket_upload = 'test-ai-mason-1256608914'  # 请替换为您所要使用的 COS Bucket 名
token = ''

# 调用 COS Bucket 的 SDK 前需要完成鉴权
config = CosConfig(Secret_id=secret_id, Secret_key=secret_key, Region=region, Token=token)
client_cos = CosS3Client(config)
logger = logging.getLogger()

# 删除云函数本地存储的图片文件
def delete_local_file(src):
    logger.info("delete files and folders")
    if os.path.isfile(src):
        try:
            os.remove(src)
        except:
            pass
    elif os.path.isdir(src):
        for item in os.listdir(src):
            itemsrc = os.path.join(src, item)
            delete_file_folder(itemsrc)
        try:
            os.rmdir(src)
        except:
            pass

# 云函数的入口
def main_handler(event, context):
    logger.info("start main handler")

    # save api gateway file to local temp file
    logger.info("Start to download image from API GW")
    time = datetime.datetime.now()
    file_name = '{}'.format(time) + "-test.jpg"
    logger.info("file_name is : %s" % file_name)
    local_path = u'/tmp/{}'.format(file_name)
    logger.info("local_path is : %s" % local_path)
    with open(local_path, 'w') as wfile:
        wfile.write(base64.b64decode(event['body']))

    # start to upload to cos
    logger.info("Start to upload image to COS")
    res_cos = client_cos.put_object_from_local_file(
        Bucket=bucket_upload,
        LocalFilePath=local_path,
        Key='{}'.format(file_name))
    logger.info("upload to cos result is : %s" % res_cos)

    # start to detection
    logger.info("Start to detection")
    client_ai = Client(appid, secret_id, secret_key,bucket_upload)
    client_ai.use_http()
    client_ai.set_timeout(30)
    res_ai = client_ai.word_detect(CIFile(local_path))
    res_text = "  "
    print len(res_ai["data"]["items"])
    for i in range(len(res_ai["data"]["items"])):
        res_text = res_text + str(res_ai["data"]["items"][i]["itemstring"].encode('utf-8'))

    # delete local image
    delete_local_file(local_path)

    # return detection result
    response = {
        "isBase64": False,
        "statusCode": 200,
        "headers": {"Content-Type": "text", "Access-Control-Allow-Origin": "*"},
        "body": res_text
    }
    return response
```
3. Python 文件保存后，回到根目录下，对所有文件进行打包（**请注意，不是对外层的文件夹打包**）；另外还需要保证: **Word_Recognition.py 存在于根目录下，压缩包需要为 zip 格式**。
> **注意：**
您可以直接使用步骤一中下载好的 zip 包，而略去步骤 1 和步骤 2。

4. 前往[无服务器云函数 SCF 的控制台](https://console.cloud.tencent.com/scf/list?rid=4)，选择地域“上海”，单击新建函数，选择空白函数模板，命名函数为 Word_Recognition，运行环境默认为 Python2.7，单击“完成”。
然后在【函数代码】的编辑框中，选择本地上传zip包，选中打好的zip包后，**修改“执行方法”为：Word_Recognition.main_handler**，再单击保存。如下图所示：
![](https://main.qcloudimg.com/raw/534a6bf94d2947f4ca2662d10cd978c5.png)
> **注意：**
保存完代码包后，需要在【函数代码】框中，把 appid、secret_id、secret_key 和 bucket_upload 替换为您自己的 APPID、SecretId、SecretKey 和 bucket 名方能使用。修改完后，记得单击“保存”。如下图所示：
![](https://main.qcloudimg.com/raw/b77ad59889a3484436052d97ed9e0b85.png)


### 步骤三 配置 API 网关 触发器

单击【触发方式】功能栏，选择“添加触发方式”，然后选中“API 网关触发器”，可以修改 API 服务名为“SCF_API_SERVICE_Word_Recognition”，单击“保存”后，即完成所有创建流程。此时，即可获得该函数的 http 触发域名。
![](https://main.qcloudimg.com/raw/86d112ede041b70db237cbb2ad0aeed7.png)