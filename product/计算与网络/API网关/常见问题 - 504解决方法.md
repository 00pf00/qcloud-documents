**504 Gateway Time-out 常见排查手段**

当用户在调用 API网关的服务时，日志中出现 “504 Gateway Time-out”时，可以从以下几个角度排查问题

1. 首先考虑直接访问 API网关后端服务是否正常。

   当用户后端服务是http时，直接通过外网访问看是否超时；当用户后端服务是 VPC 内的负载均衡资源时，需要使用相同 VPC内的另一台 CVM 访问负载均衡的内网 IP，检查是否超时；当用户后端服务是 TSF 时，可以通过 TSF 下同一个命名空间的服务实例对超时实例进行访问，检查是否超时。在以上情况中，如果测试依然超时，考虑是后端服务存在问题，建议检查后端服务是否正常。

2. 检查 API网关 以及后端服务设置的超时时间。

   用户在配置 API网关的 API 时，需要在后端配置中添加超时时间，如果后端服务没有在超时时间内返回结果，网关会返回 504 错误。

3. 检查安全组是否正确设置。

   - 用户后端地址是 VPC 内的 CLB 时，查看关联的CLB绑定的 rs 安全组是否放通了 api网关 的 ip访问。如果没有设置安全组，请查看后端地址是否还存在其他的端口网络限制。

     放通安全组方法： CLB 绑定的后端 CVM 安全组，需要放通 API网关的内网 IP 网段，不同地域内网 IP网段列表如下。端口需要放通 部署在CVM 上的服务的端口。安全组的设置方式请参考 [安全组使用](https://cloud.tencent.com/document/product/213/18197)。

   - 当用户的API是微服务API，且服务部署在虚拟机上时，需要在 CVM 上的安全组上放通 API 网关的内网 IP 网段。端口放通服务端口。

   - 当用户的 API是微服务 API ，且服务部署在容器中时，由于容器的 pod 不一定固定在某个 CVM 上，建议将集群中的机器都放通相同的安全组，放通网关的内网网段，端口添加微服务的服务端口，而不是nodeport端口。

   - 当用户的后端地址是一般的外网可访问 http 地址时，也需要检查是否有设置防火墙、安全组等，需要放通网关的外网 vip 。

   说明：由于 API 网关不能保证外网 VIP 以及内网网段不变，建议用户使用密钥对鉴权来保证请求的安全。


API网关各地域内网网段以及外网 VIP

| 地域     | 内网网段                           | 外网 VIP                                                     |
| -------- | ---------------------------------- | ------------------------------------------------------------ |
| 广州     | 9.0.0.0/8,10.0.0.0/8,100.64.0.0/10 | 111.230.189.251 ,111.230.86.251 ,111.230.86.254 ,193.112.148.249 ,193.112.148.243 ,193.112.148.212 |
| 北京     | 9.0.0.0/8,10.0.0.0/8,100.64.0.0/10 | 140.143.115.153 ,140.143.179.251 ,140.143.117.164 ,140.143.179.252 |
| 上海     | 9.0.0.0/8,10.0.0.0/8,100.64.0.0/10 | 111.231.97.251, 111.231.179.251                              |
| 香港     | 9.0.0.0/8,10.0.0.0/8,100.64.0.0/10 | 119.28.183.103 ,119.28.183.104                               |
| 上海金融 | 9.0.0.0/8,10.0.0.0/8,100.64.0.0/10 | 118.25.202.11 ,118.25.202.12 ,139.199.51.139                 |

































































































































































































































