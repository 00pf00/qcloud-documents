#API网关日志管理

用户可以开启日志管理，将自身的调用日志存放在日志集中。具体使用方法如下：

 

##创建日志规则

在API网关的控制台左侧导航栏中，您可以看到日志管理标签页。（目前需要开通白名单，可联系您的客户经理或提工单申请开启）

![](https://main.qcloudimg.com/raw/f9b00e703957a8603077bdc3d6ed5fc1.png)

当您第一次使用的时候，需要先对API网关采集日志服务进行授权，如下：

![](https://main.qcloudimg.com/raw/4a066a98e21c061a267e37ac74464155.png)

点击前往访问管理，并点击同意授权：

![](https://main.qcloudimg.com/raw/12b6d67de9fcdff60f013c35002b28db.png)

授权后点击新建，即可新建日志收集规则，API网关的日志管理能力使用了腾讯云平台的日志服务，在新建日志规则时，可对日志规则进行命名。并选择所需收集的通账户下的日志服务及服务中的具体环境。通过选择日志集而确定将这些信息投递到日志服务的哪个日志集中。若您还没有创建日志集。则需要在日志服务页面先进行创建。

![](https://main.qcloudimg.com/raw/850c9a7961718194695050d9a2c97fc9.png)

创建成功后，可看到日志规则列表

![](https://main.qcloudimg.com/raw/2809d49edc7ed73d50be0685f2614a92.png)

可以对日志规则进行编辑，修改需要投递的内容和日志集

![](https://main.qcloudimg.com/raw/6ddcd04f8eca2d862ad54d2e2e7dcf30.png)

##查看日志

API网关的日志收集到日志服务中后，可到日志服务页面对应的日志集下进行查看

![](https://main.qcloudimg.com/raw/65648a9aa5eed1f3cc1700a2d03f0d1f.png)

可根据关键字进行日志检索

![](https://main.qcloudimg.com/raw/461f2573e5d87ecb890ecbab7ba5d67d.png)

其他具体日志服务的使用，请参考：https://cloud.tencent.com/document/product/614/16981

 

##日志格式说明

API网关日志格式如下

    log_format  
    '[$app_id][$env_name][$service_id][$http_host][$api_id][$uri][$scheme][rsp_st:$status][ups_st:$upstream_status]'
    '[cip:$remote_addr][uip:$upstream_addr][vip:$server_addr][rsp_len:$bytes_sent][req_len:$request_length]' 
    '[req_t:$request_time][ups_rsp_t:$upstream_response_time][ups_conn_t:$upstream_connect_time][ups_head_t:$upstream_header_time]'
    '[err_msg:$err_msg][tcp_rtt:$tcpinfo_rtt][$pid][$time_local]';

 app_id ： 用户ID
 env_name: 环境名称
 service_id： 服务ID
 http_host： 域名
 api_id： API的ID 
 uri：    请求的路径
 scheme：  HTTP/HTTPS协议
 rsp_st： 请求响应状态码 
 ups_st： 后端业务服务器的响应状态码(说明：如果请求透传到后端，改变量不为空。如果请求在APIGW就被拦截了，那么该变量显示为-)
 cip：    客户端 IP
 uip:     后端业务服务(upstream)的IP
 vip：    请求访问的VIP
 rsp_len： 响应长度 
 req_len： 请求长度 
 req_t： 请求响应的总时间
 ups_rsp_t： 后端响应的总时间(apigw建立连接到接收到后端响应的时间)
 ups_conn_t: 与后端业务服务器连接建立成功时间
 ups_head_t：后端响应的头部到达时间
 err_msg：   错误信息
 tcp_rtt：   客户端tcp连接信息，RTT（Round Trip Time）由三部分组成：链路的传播时间（propagation delay）、末端系统的处理时间、路由器缓存中的排队和处理时间（queuing delay）。

 
