## 操作场景

本文主要介绍API 网关共享集群服务迁移至专项实例的迁移流程和常见问题解答。

关于专享实例的介绍请参考[实例规格](https://cloud.tencent.com/document/product/628/55510)。



## 迁移流程

| 步骤  | 具体操作详情                                                 | 操作方             | 是否完成 |
| ----- | ------------------------------------------------------------ | ------------------ | -------- |
| step1 | 客户提供需要迁移的服务包括（地域 appId 服务 ID）比如：广州 123688xxx  service-0x6u6xxx。 | 客户               |          |
| step2 | 评估 需要迁移的服务配置，并输出评估报告。                    | 网关               |          |
| step3 | 在step2评估可迁移的情况下，客户需要进行专享实例参数评估专享实例的规格（根据业务 qps 评估）专享实例的 vpc 参数（如果原来服务后端有跨 vpc 的情况，需要配置云联网打通跨 vpc 的场景）。 | 客户主导，网关配合 |          |
| step4 | step3创建好专享实例后，将专享实例id提供给apigw，apigw 二次 check。 | 网关               |          |
| step5 | step4通过后，客户确认迁移时间。                              | 客户               |          |
| step6 | 在约定时间，apigw 对服务发起迁移（通常1分钟完成），客户配合观察业务监控。**如果迁移当中或者迁移后，服务异常，apigw 这边会即可回滚。** | 网关主导，客户配合 |          |
| step7 | 迁移完成后，apigw 这边会持续观察一段时间，观察期间，如有异常会立即回滚，并通知客户。 | 网关               |          |



## 常见问题

### 1. 迁移当中，服务是否会中断

理论上，用户无感。如果出现异常，会立即回滚。

**目前迁移操作可以保证 apigw 的域名不发生变更，但是入口 IP 和出口 IP 会发生变化，如果 client 依赖入口 IP 或者后端有出口 IP 白名单，需要提前和 apigw 沟通。**

### 2. 多个服务可以同时迁移到一个专享实例上吗？

需要根据实际情况评估：

1）多个待迁移服务，都只有公网，可以迁移到同一个专享实例上。

2）如果多个待迁移服务同时存在内网访问（目前http 8xxx端口， https 9xxx端口）。

- 内网端口一样的，那么可以迁移到同一个专享实例上。
- 内网端口不一样，则不能迁移到相同专享实例上。

3）在第二种情况下，如果客户端支持多个内网访问端口有8xxx修改80，9xxx修改成443，可以支持迁移到同一个专享实例上。

### 3. 是不是所有的共享服务都可以无感迁移到专享实例上？

不是，由于历史原因，如果原来域名后缀是 apigateway.myqcloud.com 的服务，目前不推荐迁移，无法做到用户无感。但是有备选方案：用户自行在专享实例上，创建新的服务，然后利用 apigw 现有的 api 复制功能，将原服务上的 api 配置同步到专享服务上。**如果myqcloud 域名在自定义域名、或者客户端中 hardcode、或者 waf 中配置了，需要同步更新。**

![](https://qcloudimg.tencent-cloud.cn/raw/bf771645dfebbeb698f996498bde485a.png)

![](https://qcloudimg.tencent-cloud.cn/raw/96d7290e095ccd9c82cc486162522f26.png)

​                
