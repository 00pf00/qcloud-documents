若对等连接不能满足您的业务需求时，可以将您的网络架构平滑迁移到云联网上，即可体验极速、稳定、安全、灵活的全球互联网络，实现全网互通。

## 背景信息
若您的 VPC1 和 VPC2 已使用对等连接建立了互联，如需迁移至云联网，实现与其他 VPC 的全网互联，有以下几种应用场景：
![](https://main.qcloudimg.com/raw/bbd0b063807d8a9f045b8373bb4dcd60.png)
- 场景一：子网网段和 VPC CIDR 相同的场景，具体迁移操作请参见 [场景一](#1)。
- 场景二：子网网段小于 VPC CIDR，且对等连接使用 VPC CIDR 的路由，具体迁移操作请参见 [场景二](#2)。
- 场景三：子网网段小于 VPC CIDR，且对等连接使用子网的路由，具体迁移操作请参见 [场景三](#3)。

<span id="1"></span>
## 子网网段和 VPC CIDR 相同
例如，广州 - 俄罗斯之间已有对等连接，广州 - VPC1 的 CIDR 为192.168.0.0/22，子网网段为192.168.0.0/22。俄罗斯 - VPC2 的 CIDR 为 192.168.210.0/23，子网网段为 192.168.210.0/23，具体迁移步骤如下：
1. 在广州 VPC 上新增备份路由策略，具体操作请参见 [配置路由策略](https://cloud.tencent.com/document/product/215/36682#.E9.85.8D.E7.BD.AE.E8.B7.AF.E7.94.B1.E7.AD.96.E7.95.A5)。
2. 拆分路由策略，把指向对等连接的路由进行拆分，本示例中将 192.168.210.0/23， 拆分为两个 24 位的路由：192.168.210.0/24、192.168.211.0/24。新增的路由为默认启用，按照最长掩码匹配，因此广州 VPC 到俄罗斯 VPC 使用/24位的路由。
	 ![](https://main.qcloudimg.com/raw/db3076fbd874b3c7e0869407c35c9df6.png)
3. 在俄罗斯 VPC 上新增备份路由策略，具体操作请参见 [配置路由策略](https://cloud.tencent.com/document/product/215/36682#.E9.85.8D.E7.BD.AE.E8.B7.AF.E7.94.B1.E7.AD.96.E7.95.A5)。
4. 拆分路由策略，本示例中将 192.168.0.0/22，拆分为两个 23 位的路由:192.168.0.0/23，192.168.2.0/23。
   ![](https://main.qcloudimg.com/raw/4d9da983215cd7e2dd33629278c288b1.png)
5. 如果已有云联网实例，请跳过此步。新建一个云联网实例，具体操作请参见 [新建云联网实例](https://cloud.tencent.com/document/product/877/18752)。
6. 将广州 - VPC1 和俄罗斯 - VPC2 与对应的云联网实例关联，具体操作请参见 [关联网络实例](https://cloud.tencent.com/document/product/877/18747)。
7. 关联云联网后，云联网的路由表会新增两个 VPC 的子网网段的路由。
![](https://main.qcloudimg.com/raw/e8a38a7fa3c5068e77fd6ec28290bd3b.png)
8. 分别进入广州 - VPC1 和俄罗斯 - VPC2 的各个子网的路由表中，查看路由情况（云联网路由会默认下发到子网路由表，但不一定生效），并通过停用和启用路由完成迁移，例如本实例中：
	- 广州-VPC1的路由表如图所示，则需要完成以下操作：
   ![](https://main.qcloudimg.com/raw/a74cc1755771896d865393346239b3d9.png)
   1. 禁用目的地为 192.168.210.0/23 的下一跳类型为对等连接的路由。
   2. 启用目的地为 192.168.210.0/23 的下一跳类型为云联网的路由。
   3. 禁用目的地为 192.168.210.0/24，192.168.211.0/24 的下一跳类型为对等连接的路由。
	- 俄罗斯-VPC2 的路由表如图所示，则需要完成以下操作：
  ![](https://main.qcloudimg.com/raw/8bfa0f10e3ffb0fb46045946ed15603e.png)
   1. 禁用目的地为 192.168.0.0/22 的下一跳类型为对等连接的路由。
   2. 启用目的地为 192.168.0.0/22 的下一跳类型为云联网的路由。
   3. 禁用目的地为 192.168.0.0/23，192.168.2.0/23 的下一跳类型为对等连接的路由。此时业务无缝切换至云联网路由。
   
>!在流量切到云联网后，请暂时不要删除对等连接，观察业务稳定运行一段时间后，客户确保对等连接无用的情况下，再删除对等连接。

<span id="2"></span>

## 子网网段小于 VPC CIDR，且对等连接使用 VPC CIDR 的路由

子网网段小于 VPC CIDR，且对等连接使用 VPC CIDR 的路由。请按以下步骤迁移：
1. 新建一个云联网实例（如果已有则不需要），具体操作请参见 [新建云联网实例](https://cloud.tencent.com/document/product/877/18752)。
2. 将 VPC1、VPC2 与对应的云联网实例关联，具体操作请参见 [关联网络实例](https://cloud.tencent.com/document/product/877/18747)。
3. 分别进入广州 - VPC1 和俄罗斯 - VPC2 的各个子网的路由表中，查看路由情况（云联网路由会默认下发到子网路由表，但不一定生效），并通过停用和启用路由完成迁移。
4. VPC1 和 VPC2 加入云联网后，VPC1 和 VPC2 路由表中都会新增对方的子网路由，且处于**未启用**状态。因子网小于 CIDR，可直接启用 VPC 路由表中指向云联网的子网路由，启用后流量通过云联网。
   >!
   >- 请关注在切换过程中，会出现来回路径不一致情况，正常情况下不会引起丢包，仅链路延时会有细微差别。
   >- 在流量切到云联网后，请暂时不要删除对等连接，观察业务稳定运行一段时间后，客户确保对等连接无用的情况下，再删除对等连接。
   >
![](https://main.qcloudimg.com/raw/44ac7e8fddf591e9e4823d03712edda3.png)

<span id="3"></span>

## 子网网段小于 VPC CIDR，且对等连接使用子网的路由
例如，广州 - 北京之间已有对等连接，广州 - VPC1 的 CIDR 为192.168.0.0/16，子网网段有192.168.0.0/24，192.168.3.0/24。 北京 - VPC2 的 CIDR 为 10.0.0.0/16，子网网段有 10.0.2.0/24，10.0.4.0/24。
1. 新建一个云联网实例（如果已有则不需要），具体操作请参见 [新建云联网实例](https://cloud.tencent.com/document/product/877/18752)。
2. 将广州 - VPC1 和北京 - VPC2 与对应的云联网实例关联，具体操作请参见 [关联网络实例](https://cloud.tencent.com/document/product/877/18747)。
3. 将广州 - VPC1 和北京 - VPC2 与对应的云联网实例关联后，云联网路由表中会自动下发 VPC 中子网路由，且为启用状态。
![](https://main.qcloudimg.com/raw/a81f6a422ea696742341bdeca0006751.png)
在广州 - VPC1 路由表中，有自动下发的目的地为 10.0.2.0/24，10.0.4.0/24 的云联网类型子网路由，由于已存在有相同地址的对等连接路由，故处于未生效状态。
![](https://main.qcloudimg.com/raw/ba6c22d28da263a5550c1db0daa72cc0.png)
4. 配置广州 - VPC1 子网路由表。
   1. 将子网路由进行收敛，增加 10.0.0.0/16 的路由策略，下一跳仍然指向对等连接，具体操作请参见 [配置路由策略](https://cloud.tencent.com/document/product/215/36682#.E9.85.8D.E7.BD.AE.E8.B7.AF.E7.94.B1.E7.AD.96.E7.95.A5)。
   >!此步骤务必保证路由收敛的正确性。
   >
![](https://main.qcloudimg.com/raw/845fe064aadbfe108d04a24bfb8b1cac.png)
   2. 禁用下一跳为对等连接的 10.0.2.0/24，10.0.4.0/24 的子网路由，此时路由无缝切换至 10.0.0.0/16（下一跳指向对等连接），业务侧无感知。
![](https://main.qcloudimg.com/raw/fdfff3ef996c6241b25502d5b059e1ac.png)
      <span id ="step3"></span>
   3. 启用上一步中的下一跳指向云联网的 10.0.2.0/24，10.0.4.0/24 的子网路由。此时根据最长掩码匹配，路由无缝切换至云联网路由。
      >!此时广州 - 北京方向通过云联网转发，北京 - 广州方向通过对等连接转发，正常情况下来回路径不一致不会引起丢包， 仅链路延时会有细微差别。
      >
![](https://main.qcloudimg.com/raw/1d51669b9fc925f90dcdab9c9522018e.png)
5. 按照配置广州 - VPC1 子网路由表中的 [步骤 3](#step3) 配置北京 - VPC2 子网路由表，配置后结果如下：
![](https://main.qcloudimg.com/raw/338e4c28e2598a0766c0035a9481c0ca.png)

>!在流量切到云联网后，请暂时不要删除对等连接，观察业务稳定运行一段时间后，客户确保对等连接无用的情况下，再删除对等连接。

