# 1. 任务概述

本文将通过配置和部署一个典型 Dubbo 项目 Q 云书城（Q Cloud Book Mall，QCBM）为例，详细介绍和展示如何在多云多集群场景下部署应用服务，演示多集群的应用分发，调度管理，服务治理，以及多集群服务的多活容灾能力。


# 2. 前期准备
在开始部署服务前，请确认以下步骤已完成：
- [注册腾讯云账号](https://cloud.tencent.com/document/product/378/17985)，并完成 [实名认证](https://cloud.tencent.com/document/product/378/3629)
- 阅读 QCBM 项目，了解 Dubbo 微服务架构，详情可参见 [QCBM 项目](https://github.com/TencentCloud/container-demo/tree/main/dubbo-on-tke)
- 阅读 [Dubbo 应用托管到 TKE](https://cloud.tencent.com/document/product/457/55152)，了解 QCBM 项目如何能够部署在 TKE 集群上，实现完整的功能
- 掌握容器服务基础知识：[容器服务 TKE 介绍](https://cloud.tencent.com/document/product/457/6759)


# 3. 技术架构

QCBM 是采用微服务架构，并使用 dubbo-2.7.8 框架开发的一个网上书城 Demo 项目，详情可参见 [QCBM 项目](https://github.com/TencentCloud/container-demo/tree/main/dubbo-on-tke)。

本文将 QCBM 扩展至多集群上实现多云容灾能力，在整体架构上主要划分为接入层，应用层 和 数据层，配合相应管控和监控组件，实现多集群管理和多活容灾能力。
整体架构图如下：

![]()

接入层使用腾讯云 CLB 或其他云厂商 LB 产品实现流量接入和转发，也支持配置 nginx 实现。本文以 腾讯云 CLB 为例说明。
数据层使用腾讯云数据库 MYSQL 和 Redis，或使用其他云厂商的数据库产品，同时也支持对接自建的 MySQL 和 Redis。本文以 腾讯云数据库 MYSQL 和 Redis 为例说明。

应用层由以下微服务应用组成，通过 [应用治理]() 向多集群快速部署发布，并支持根据集群差异化配置进行灰度更新。
- QCBM-Front ：使用 react 开发的前端项目，基于 nginx 官方提供的 1.19.8 docker 镜像 构建和部署。
- QCBM-Gateway ：API 网关，接受前端的 http 请求，并转化为后台的 dubbo 请求。
- User-Service ：基于 dubbo 的微服务，提供用户注册、登录、鉴权等功能。
- Favorites-Service ：基于 dubbo 的微服务，提供用户图书收藏功能。
- Order-Service ：基于 dubbo 的微服务，提供用户订单生成和查询等功能。
- Store-Service ：基于 dubbo 的微服务，提供图书信息的存储等功能。



# 4. 操作步骤

## 4.1 准备环境

### 4.1.1 集群准备
请准备好 QCBM 服务所运行的集群，参考 [创建集群](https://cloud.tencent.com/document/product/457/32189) 创建TKE集群指引，创建TKE集群。
如果您已有的 Kubernetes 集群，请确认能够通过 kubectl 命令访问。
在实际生产环境中，多个集群可位于不同地域、可用区、甚至不同云服务商，实现可控的基础设施故障域。

### 4.1.2 其他基础服务准备
在 Mysql 控制台 创建实例，并使用 qcbm-ddl.sql 初始化。详情请参见 创建 MySQL 实例。
在 Redis 控制台 创建实例并初始化。详情请参见 创建 Redis 实例。
在 负载均衡控制台 为子网 Subnet-K8S 新建一个内网型的负载均衡（后续实践中会使用到该 CLB 实例 ID）。详情请参见 创建负载均衡实例。
申请通过 TSW 内测。TSW 目前处于内测阶段，支持 Java 和 Golang 两种语言接入。
部署 Nacos 集群：
在 云服务器控制台 购买3台 “标准型SA2” 1核2G的云服务器，详情请参见 通过购买页创建实例。
登录实例，执行以下命令安装 Java。
yum install java-1.8.0-openjdk.x86_64
执行以下命令，如有输出 java 版本信息，则说明 java 安装成功。
java - version
部署 Nacos 集群，详情请参见 Nacos 官方文档 集群部署说明 。


## 4.2 进入分布式云中心，注册集群

参考 [注册集群]()，将您的集群添加至分布式云中心，分别命名为demo-cluster1，demo-cluster2。


注册完成后，查看集群状态正常，点击集群名称可查看该集群的详细信息


## 4.3 部署多集群应用

支持通过 使用控制台 或 使用命令行 和 YAML 的方式进行配置。参考[]()登录控制台, 参考[]()获取命令行工具。

### 4.3.1 创建 Namespace

#### 方式1: 使用控制台

#### 方式2: 使用命令行
执行以下命令即可创建 Namespace：
```kubectl clusternet create namespace piggymetrics```

执行以下命令即可创建 ConfigMap：
```kubectl clusternet create namespace piggymetrics```

执行以下命令即可创建 Secret：
```kubectl clusternet create namespace piggymetrics```

执行以下命令即可创建 Statefulset：
```kubectl clusternet create namespace piggymetrics```

执行以下命令即可创建 Deployment：
```kubectl clusternet create namespace piggymetrics```

执行以下命令即可创建 Service：
```kubectl clusternet create namespace piggymetrics```

#### 查看部署结果


### 4.3.1 创建 分发策略 subscription

#### 方式1: 使用控制台

#### 方式2: 使用YAML
执行以下命令即可创建 分发策略，并关联 PiggyMetrics 应用的资源进行分发
```
apiVersion: apps.clusternet.io/v1alpha1
kind: Subscription
metadata:
  name: app-demo
  namespace: default
spec:
  subscribers: # defines the clusters to be distributed to
    - clusterAffinity:
        matchLabels:
          clusters.clusternet.io/cluster-id: ebfcf224-acc8-4992-8a37-61c371cb7c1f
  feeds: # defines all the resources to be deployed with
    - apiVersion: v1
      kind: Namespace
      name: qcbm
    - apiVersion: v1
      kind: ConfigMap
      name: qcbm-env
      namespace: qcbm
    - apiVersion: v1
      kind: Secret
      name: qcbm-keys
      namespace: qcbm
    - apiVersion: apps/v1
      kind: Deployment
      name: user-service
      namespace: qcbm
    - apiVersion: apps/v1
      kind: Deployment
      name: store-service
      namespace: qcbm
    - apiVersion: apps/v1
      kind: Deployment
      name: qcbm-gateway
      namespace: qcbm
    - apiVersion: apps/v1
      kind: Deployment
      name: qcbm-front
      namespace: qcbm
    - apiVersion: apps/v1
      kind: Deployment
      name: order-service
      namespace: qcbm
    - apiVersion: apps/v1
      kind: Deployment
      name: favorites-service
      namespace: qcbm
    - apiVersion: v1
      kind: Service
      name: qcbm-front
      namespace: qcbm
    - apiVersion: v1
      kind: Service
      name: api-gateway
      namespace: qcbm
    - apiVersion: extensions/v1beta1
      kind: Ingress
      name: qcbm-ingress
      namespace: qcbm
```

#### 查看部署结果


## 4.4 多集群调度管理

### 4.4.1 新增集群发布

假设根据业务发展或容灾备份，需要将 PiggyMetrics 服务新部署至另外一个集群，通过分布式云中心的[应用治理]()功能，能够快速地将业务扩展至多集群上

- 注册新集群，参考[]()
- 修改分发策略，添加新的集群， 或者使用 labelselector 标签选择合适的集群进行分发
- 查看部署结果

### 4.4.1 灰度更新应用
支持按集群维度灰度更新和发布 PiggyMetrics 应用服务，独立控制不同集群上各个 PiggyMetrics 应用组件的版本和配置。

- 查看 PiggyMetrics 应用组件在多个集群上的分发实例
- 修改 xx组件在 xx 集群上的镜像版本，从 xxx 升级至xxx
- 修改 xxx组件 在 xxx集群上的副本数，从 xxx 更新至 xxx
— 查看部署结果
```
apiVersion: apps.clusternet.io/v1alpha1
kind: Localization
metadata:
  name: qcbm-config-override
  namespace: clusternet-bbg66 
spec:
  priority: 300
  feed:
    apiVersion: v1
    kind: ConfigMap
    name: qcbm-env
    namespace: qcbm
  overrides: # defines all the overrides to be processed with
    - name: config-override
      type: JSONPatch
      value: |-
        [
            {
                "op": "replace",
                "path": "/data/REDIS_HOST",
                "value": "10.24.4.25"
            },
            {
                "op": "replace",
                "path": "/data/NACOS_HOST",
                "value": "10.24.4.35"
            },
            {
                "op": "replace",
                "path": "/data/MYSQL_PORT",
                "value": "63579"
            },
            {
                "op": "replace",
                "path": "/data/MYSQL_HOST",
                "value": "hk-cdb-a2b1ptyb.sql.tencentcdb.com"
            }
        ]

```

## 4.5 流量服务治理

### 4.5.1 多集群Service/Ingress
将应用分发到多个集群的最直接的方法，是将应用服务分散部署在多个集群上，每个集群上独立闭环特定的服务，同时保持每个服务的可用性。例如，一个两层应用程序可能会跨两个独立的集群对其前端服务进行负载平衡，这些集群通过启用多集群的负载均衡器访问，该均衡器将流量分布到两个集群。前端集群然后共享对承载应用程序后端服务的第三个集群的访问。



### 4.5.2 多集群 Mesh 微服务
部署多集群应用服务的一种更高级的方法，是多集群Mesh Istio，实现跨集群边界的pod-to-pod连接。运行在不同集群上的服务之间的通信可以通过Mesh来管理。
tcm 跨地域托管方案





# 5. 多活容灾能力验证

按照 [操作步骤]() 的说明操作，您将构建出一个跨云跨集群的，多活容灾 PiggyMetrics 服务架构。参考以上步骤，将您的关键的工作负载运行在多个集群之上，独立的集群故障域保证了对灾难级别事件的保护的能力，多集群的应用治理和调度能力降低多云基础设施的管理复杂度，大大提升工作效率。




