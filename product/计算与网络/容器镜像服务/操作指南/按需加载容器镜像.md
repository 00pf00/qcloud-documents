## 操作场景
腾讯云容器镜像服务 TCR 企业版提供按需加载镜像功能。提前预缓存容器镜像，使用时按需加载，可将大规模镜像分发速度提升5 - 10倍，进而满足海量容器应用快速启动需求。

## 前提条件
1. 按需加载容器镜像功能仅限高级版实例开启使用。
2. 启用此功能需配套使用文件系统 CFS 性能存储。
3. 当前按需加载功能仅面向腾讯云容器服务提供适配支持，且需集群具备以下配置：
   1. 集群版本在 1.16 及以上。
   2. 集群运行时为 containerd，且版本为 1.4.3。已创建的集群可修改运行时配置至 containerd 1.4.3，调整后添加的节点默认为此版本运行时。
   3. 集群操作系统为 centos 7.6 及以上。

## 操作步骤
### 开启镜像加速
1. 登录 [容器镜像服务](https://console.cloud.tencent.com/tcr) 控制台，选择左侧导航栏中的【镜像加速】。
在“镜像加速”页面即可查看当前实例镜像加速的状态及镜像加速规则列表。如需切换实例，请在页面上方的“实例名称”下拉列表中进行选择。
1. 单击【开启镜像加速】，在“开通镜像加速服务”窗口中，参考以下提示进行配置。如下图所示：
   ![](https://main.qcloudimg.com/raw/eb83f7a4cd6f1cb710f069bc01d87e2e.png)
    - **所属实例**：当前已选择实例。
    - **加速模式**：默认为”基于CFS按需挂载加速“
    - **缓存配置**：
      - **可用区**：创建 CFS 文件系统所在的可用区，需选择支持购买性能存储的可用区。
      - **存储类型**：镜像加速暂时仅支持使用性能存储，以保证镜像数据分发速度。
      - **私有网络**：文件系统归属的私有网络，请选择与配套使用的容器集群同一个私有网络。如有其他私有网络VPC内集群也需要访问本实例，请使用云联网打通所需的VPC。
      - **权限组**：选择文件系统的权限组配置，按需选择即可。
1. 单击【确定】即可开启镜像加速功能。

### 添加镜像加速规则
1. 单击【添加镜像加速规则】，在“新建镜像加速规则”窗口中，参考以下提示进行规则配置。如下图所示：
![](https://main.qcloudimg.com/raw/34460e763783aff22e7778f4905cbb22.png)
 - **名称**：规则名称，支持小写字母、数字及（`-`、`.`、` _`）三种符号，且需以字母或数字开头。
 - **描述**：规则描述，支持中文。
 - **触发规则**：
    - **触发实例**：当前所选实例即为触发实例。
    - **命名空间**：当前实例内需要加速分发的命名空间，暂不支持选择全部命名空间。
    - **仓库名称**：加速的仓库，支持正则表达式筛选，不填写则默认是命名空间内全部仓库。
    - **版本Tag**：加速的版本，支持正则表达式筛选，不填写则默认是符合条件的仓库内所有版本。
    - **仓库类型**：同步资源的类型，可同时同步容器镜像及 Helm Chart，或只同步其中一种资源。
 - **验证规则**：输入需要加速的镜像地址，验证当前规则下该镜像是否会被加速。
2. 单击【确定】即可创建同步规则。
3. 在镜像加速页面可管理已创建的镜像加速规则，如删除规则，重新配置规则或禁用规则。

镜像加速规则在创建完成后自动生效，新推送的镜像若符合加速规则，将自动生成加速后的镜像，也可手动为指定镜像配置加速。
![](https://main.qcloudimg.com/raw/d715e8936df9ec9d119795962c1267c9.png)
### 在容器服务 TKE 中使用加速镜像
容器服务 TKE 是腾讯云官方提供的 Kubernetes 托管服务，与容器镜像服务 TCR 紧密结合，用户可在已有集群中安装 TCR 专属插件，并开启镜像加速功能。
1. 配置 TCR 插件：
   1. 选择需要使用镜像加速分发功能的集群，进入集群详情页，并选择”组件管理“，新建组件。
   2. 选择 TCR（容器镜像服务插件），并点击 ”参数配置”，配置以下信息：
      1. 关联实例：选择与集群同地域，且已开启镜像加速的实例
      2. 镜像加速配置：勾选启用镜像加速，并配置加速生效的命名空间，默认仅在 default 命名空间内启用加速拉取，可使用 “default,sa1,sa2” 指定多个命名空间，暂不支持指定全部命名空间。

   其他配置可参考 [TKE 集群使用 TCR 插件内网免密拉取容器镜像](https://cloud.tencent.com/document/product/1141/48184)。
   >! 如果集群之前已安装 TCR 插件，可先删除，再按照上述步骤重新配置。
   >
2. 配置集群节点：
   集群节点默认不支持使用加速镜像，如需让节点优先使用加速镜像，请执行下方指令为集群节点打上标签：
   ```
   kubectl label node xxx cloud.tencent.com/apparate=true
   ```
3. 使用加速镜像:
   新建工作负载时选择实例内镜像，仅当符合以下条件时，集群将实现加速拉取镜像
   1. 工作负载所在命名空间已在 TCR 插件配置中标记为生效空间。
   2. 工作负载 Pod 被调度到的节点已被打上使用镜像加速的标签。
   3. 该镜像已被加速，即以 getting-started:latest 镜像为例，镜像仓库内存在 getting-started:latest-apparate 加速镜像。
   如当前镜像尚未被加速，符合 1，2 条件的 Pod 启动时将拉取原有镜像。
