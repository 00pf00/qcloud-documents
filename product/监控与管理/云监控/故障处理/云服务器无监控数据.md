## 简介

云服务器指标数据采集依赖于监控组件。  若您没法正常获取监控指标数据，请参考本文排查故障。

##  故障原因及处理方法

| 无监控数据原因                       | 处理方法                              |
| ------------------------------------ | ------------------------------------- |
| 未安装监控 Agent 或未启动 Agent      | 参考 [步骤一](#step1)  排查并处理故障 |
| 云服务器内部 DNS 配置错误            | 参考 [步骤二](#step2)  排查并处理故障 |
| Agent获取uuid错误                    | 参考 [步骤三](#step3)  排查并处理故障 |
| 用户通过控制台或者命令行操作云服务器 | 参考 [步骤四](#step4)  排查并处理故障 |
| 云服务器高负载                       | 参考 [步骤五](#step5)  排查并处理故障 |


## 处理步骤
[](id:step1)
### 步骤一：检查是否安装监控组件 Agent 或是否启动 Agent

Linux 和 Windows 未安装监控 Agent 或未启动 Agent 的排查步骤不一致，详情请参考下文。

<dx-tabs>
::: Linux
**1. 检查 Agent 是否运行正常**
执行以下命令：
```plaintext
ps ax |grep sgAgent
ps ax |grep barad_Agent
```若如图所示则运行正常，若无上图服务运营状态则进入 [步骤2](#step2)。

![](https://main.qcloudimg.com/raw/78427ff35cdd80ceaeca555f1fbe7f40.png)

![](https://main.qcloudimg.com/raw/2ea6857b89a12898d26cbd0580eba213.png)
**2. 执行以下命令，查看Agent是否安装成功：**
```plaintext
crontab -l |grep stargate
```

若如图所示则安装成功，进入 [步骤3](#step3) 重启监控组件。若未安装成功，请参考 [安装监控组件 ](https://cloud.tencent.com/doc/product/248/2258) 重新安装 Agent。
![](https://main.qcloudimg.com/raw/23131e10c7a1fac9422411c94ae7f112.png)

**3. 重启监控组件**
执行以下命令，提示"stargate Agent run succ" 和 "barad_Agent run succ"，表示重启成功，可重复 [步骤1](#step1) 确认组件运行是否正常。

```plaintext
sudo su
cd /usr/local/qcloud/stargate/admin
./restart.sh
cd /usr/local/qcloud/monitor/barad/admin
./stop.sh
./trystart.sh
```
:::
::: Windows
运行服务（services.msc），查看 Agent 是否安装成功和是否启动。若 BaradAgent 或 stargate 未显示 “Running” 或“正在运行”，则说明服务未启动。可单击对应的服务名称，启动服务。

![](https://main.qcloudimg.com/raw/fa88598d5d632b66867c0f3749058b14.jpg)

<dx-alert infotype="explain" title="">
- 若 Agent 已启动，仍无监控数据，可继续查看下面排查思路。
- 未安装监控组件会导致无法对您的服务器做更细致的监控，若服务器故障则将无法正常通知，存在高危风险。有关安装监控组件的更多内容，请参见 [安装云服务器监控组件](https://cloud.tencent.com/document/product/248/6211) 文档。
</dx-alert>

:::
</dx-tabs>

[](id:step2)

### 步骤二：检查云服务器内部 DNS 配置是否错误

**1. 查看 DNS 配置是否错误**
i. 登录云服务器。
ii. 执行下列命令，查看内网 DNS 服务器地址。

```
nslookup update2.Agent.tencentyun.com
nslookup receiver.barad.tencentyun.com
nslookup custom.message.tencentyun.com
```

iii. 执行成功入下图所示，解析结果请对比 [DNS解析结果列表](#)。若解析结果不正确，则说明您的内网 DNS 服务器配置错误，导致云服务器无监控数据。


<dx-alert infotype="explain" title="">
- 若您使用的是私有网络（默认配置），则所有地域的内网 DNS 服务器 IP 地址均183.60.83.19 或 183.60.82.98 。
- 云服务器内网 DNS 地址配置错误，会导致监控组件无法上报数据。
</dx-alert>




**2. 修复内网 DNS**

当您的内网地址 DNS 配置错误时，您可以根据云服务器操作系统的类型，进行手动设置内网 DNS。

Linux 和 Windows 修复内网 DNS 的排查步骤不一致，详情请参考下文。
<dx-tabs>
::: Linux
1. 登录 Linux 云服务器。
2. 执行以下命令，打开 `/etc/resolv.conf` 文件。
```
vi /etc/resolv.conf
```
3. 按 **i** 切换至编辑模式，并根据 [内网 DNS](https://cloud.tencent.com/document/product/213/5225#.E5.86.85.E7.BD.91-dns) 列表中对应的不同地域，将内网 DNS 服务器追加到文件中。
例如，将内网 DNS IP 修改为北京地域的内网 DNS 服务器执行命令如下。执行成功后按 **Esc**，输入 **:wq**，保存文件并返回。
```
nameserver 10.53.216.182
nameserver 10.53.216.198
options timeout:1 rotate
```
4. 若您依赖自己的 DNS 解析，您也可以修改hosts配置来替换步骤3。
执行以下命令，打开`/etc/hosts` 文件
```
vi /etc/hosts
```按 **i** 切换至编辑模式，把下列私有网络解析的 IP 追加到文件中
例如，将 hosts 文件修改为私有网络的 hosts 。
```
169.254.0.15 update2.Agent.tencentyun.com
169.254.10.10 metadata.tencentyun.com
169.254.0.4  receiver.barad.tencentyun.com
```
:::
::: Windows
1. 登录 Windows 云服务器。
2. 在操作系统界面，打开【控制面板】>【网络和共享中心】>【更改适配器设备】。
3. 右键单击【以太网】，选择【属性】，打开 “以太网 属性” 窗口。
4. 在 “以太网 属性” 窗口，双击打开【Internet 协议版本 4 (TCP/IPv4)】。如下图所示：
![](https://main.qcloudimg.com/raw/023e97de00a08b44a19c510798d2d1c6.png)
5. 选择【使用下面的 DNS 服务器地址】，根据 [内网 DNS](https://cloud.tencent.com/document/product/213/5225#.E5.86.85.E7.BD.91-dns) 列表中对应的不同地域，修改 DNS IP。修改完后单击确定即可。
![](https://main.qcloudimg.com/raw/8921862c0b6ea5e407de4796f2806c8e.png)
6. 运行 `services.msc` ，按鼠标右键<点击【重启启动】按钮，重启 SgAgent 和 BaradAgent 即可。
![](https://main.qcloudimg.com/raw/fa88598d5d632b66867c0f3749058b14.jpg)

>?若重启后仍无监控数据，请参考 [安装云服务器监控组件](https://cloud.tencent.com/document/product/248/6211) 卸载并重装 Agent。

[](id:step3)
:::
</dx-tabs>


### 步骤三：检查 uuid 是否正确

<dx-tabs>
::: Linux
1. 进入 [云服务器控制台](https://console.cloud.tencent.com/cvm/instance) ，进入实例详情查看 uuid 。
   ![](https://main.qcloudimg.com/raw/56e0512607fad64dcaad129a467ffb37.png)
2. 登录云服务器。
3. 执行以下命令查看   Agent获取的 uuid,对比云服务器控制台展示的 uuid ,若不一致，执行 [步骤4](#step4)。
```plaintext
cat /sys/class/dmi/id/product_serial
```
4. 执行以下命令修复 uuid 。
```plaintext
echo `cat /etc/uuid |awk -F '= ' '{print $NF}'` > /etc/uuid_to_serial; mount --bind /etc/uuid_to_serial /sys/class/dmi/id/product_serial
```
5. 重启 Agent，执行以下命令，提示"stargate Agent run succ" 和 "barad_Agent run succ"，表示重启成功，可重复步骤1确认组件运行是否正常
   ```plaintext
   sudo su
   cd /usr/local/qcloud/stargate/admin
   ./restart.sh
   cd /usr/local/qcloud/monitor/barad/admin
   ./stop.sh
   ./trystart.sh
   ```
:::
::: Windows
1. 进入 [云服务器控制台](https://console.cloud.tencent.com/cvm/instance) ，进入实例详情查看 uuid 。
   ![](https://main.qcloudimg.com/raw/56e0512607fad64dcaad129a467ffb37.png)
2. 登录云服务器。
3. 通过浏览器访问`http://metadata.tencentyun.com/meta-data/uuid`，在返回结果中检查 uuid 与控制台的 uuid 是否一致。
![](https://main.qcloudimg.com/raw/c5330faee2f9d4539ccafe7a1684e40a.png)
若 uuid 文件未变动，检测子机的时间戳。若时间相差较大，重启监控组件后可恢复。
:::
</dx-tabs>



[](id:step4)
### 步骤四：检查监控组件是否离线
云服务器操作关机后处于关机状态，会导致监控组件离线并且没有数据。
用户通过云服务器控制台或者登录云服务器，操作重启，升级云服务器，重装，制作镜像等常见的云服务器运维操作，都会使云服务器监控数据上报超时导致离线。
**问题排查方式：** 可以根据当时时间点排查云服务器是否有存在相关的运维操作，操作日志可以进入云服务器详情页面中操作日志中查看。
![](https://main.qcloudimg.com/raw/35509775ce23f7dfb6e776a6fbbf5a88.png)

### 步骤五：检查云服务器是否高负载[](id:step5)
云服务器 CPU 高负载，内存使用占满，带宽占用过高都会导致监控组件上报数据异常。
**问题排查方式：** 
- CPU 高负载：详细排查步骤请查看  [云服务器 CPU 或内存占用过高](https://cloud.tencent.com/document/product/248/44698)。
- 内存占用过高：可以登录云服务器或者查看监控图表是否有存在内存 使用达到`100%`的情况 ，若达到`100%`，可以根据实际情况来扩容服务。 
- 带宽占用过高：详细排查步骤请查看 [云服务器带宽使用率过高](https://cloud.tencent.com/document/product/248/44701)。



