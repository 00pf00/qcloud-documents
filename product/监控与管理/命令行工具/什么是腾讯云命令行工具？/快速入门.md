## 操作场景

本文将介绍如何在 TKE 上部署一套 Gitlab 作为私有的代码托管平台。

## 前提条件

已创建 TKE 集群，详情请参见 [部署容器服务 TKE](https://cloud.tencent.com/document/product/457/11741)。


## 操作步骤

### 部署 Helm 应用


使用 Helm 安装 Gitlab，传入这里推荐的 [values.yaml](https://raw.githubusercontent.com/TencentCloudContainerTeam/manifest/master/gitlab/values-gitlab-ce.yaml) 配置（镜像同步 + TKE 适配）。在 TKE 上有两种方法部署 Helm 应用，详细步骤如下：


<dx-tabs>
::: 方法1：使用应用市场部署
在 [应用市场](https://console.cloud.tencent.com/tke2/market) 搜索 Gitlab 并指定要安装的集群，将 `values.yaml` 配置粘贴到参数中：

![](https://main.qcloudimg.com/raw/273f2dee7675bd6937df7805e7eb35d0.png)

>?使用方法1，无需安装 Helm 命令，直接在界面上操作即可。
:::
::: 方法2：使用\shelm\s命令部署
使用该方法需保证自行安装好 helm 命令，参考 [官方安装文档](https://helm.sh/docs/intro/install/)，并且需要保证能够使用 kubectl 操作集群，然后就可以通过 helm 命令安装 Jenkins 了，参考 [Jenkins 安装官方文档](https://www.jenkins.io/doc/book/installing/kubernetes/#install-jenkins-with-helm-v3) (helm install 的时候加下 -f values-gitlab-ce.yaml 替换部署配置)。

>?方法2适合用在 CI/CD 流程，不通过控制台部署。
:::
</dx-tabs>



### 获取访问入口与登录方式

安装好后，默认会创建一个 CLB 并使用4层监听器作为 Gitlab 的访问入口，在控制台可找到对应的 CLB 及其外网 IP。如下图所示：
![](https://main.qcloudimg.com/raw/64a6e55d982d81563089082d48a78623.png)

端口默认为8181，用户名为 root，初始密码从 gitlab-migrations 的 pod 标准输出可以看到，或者从 `gitlab-initial-root-password` 的 secret 中获取。



## 配置说明与自定义

推荐配置中有许多参数可以根据自身环境和需求进行自定义，详细介绍如下：

### 安装合适依赖

Gitlab 的 Chart 包中包含许多其他依赖的应用，这部分应用可选，在多数场景下并不需要安装，而且不同环境不一样，如果都安装上，反而带来更多不确定性，加大维护难度；若需要，可以根据自身情况单独安装，所以不建议安装太多的依赖。推荐配置中许多依赖应用已禁用，YAML 文件如下：

<dx-codeblock>
:::  yaml
certmanager: 
  install: false 
nginx-ingress: 
  enabled: false 
prometheus: 
  install: false 
gitlab-runner: 
  install: false 
registry: 
  enabled: false 
  ingress: 
    enabled: false
:::
</dx-codeblock>


### Redis 与 PostgreSQL

在测试环境中，可以将依赖的 Redis 与 PostgreSQL 一起安装。在生产环境则建议您使用相应的专业云产品。该实例推荐配置中默认安装 Redis 与 PostgreSQL，由于 TKE 默认的 StorageClass 是创建云硬盘，且最低容量为10Gi，因此 Redis 与 PostgreSQL 默认申请10Gi的容量来持久化数据。YAML 文件如下：


<dx-codeblock>
:::  yaml
redis: 
  install: true 
  usePassword: true 
  password: "123456" 
  cluster: 
    enabled: false 
  master: 
    persistence: 
      size: 10Gi
postgresql: 
  install: true 
  postgresqlUsername: gitlab
  postgresqlPostgresPassword: "123456"
  persistence:
    size: 10Gi
:::
</dx-codeblock>




### 流量入口

默认安装会创建一个 CLB 并使用4层监听器（8181端口）作为 Gitlab 的访问入口。YAML 文件如下：

```yaml
gitlab:
  webservice:
    service:
      type: LoadBalancer # 使用四层 LB 暴露
      workhorseExternalPort: 8181 # gitlab 界面对外端口号
```




在浏览器输入 `http://<外网IP>:8181` 进行访问。

在生产环境中建议使用 Ingress 来暴露流量，如需使用 HTTPS，将证书配置在 Ingress 上即可。在 TKE 上推荐使用 nginx-ingress，需要额外安装的组件，请参见 [官方文档说明](https://cloud.tencent.com/document/product/457/50502)。

使用 nginx-ingress 对外暴露 gitlab 服务的话，gitlab 本身的 service 就不需要为 LoadBalancer 了，只需要 ClusterIP 即可:

```yaml
gitlab:
  webservice:
    service:
      type: ClusterIP # 不为 gitlab 自动创建 CLB
```

然后在 TKE 控制台创建 Ingress:

![](https://main.qcloudimg.com/raw/ac583714b9f93bf4fe4947589c10feb0.png)

当然也可以用 yaml 创建:


<dx-codeblock>
:::  yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata: 
  annotations: 
    kubernetes.io/ingress.class: nginx
  name: gitlab
  namespace: devops
spec: 
  rules: 
  - host: gitlab.xxxx.io
    http: 
      paths: 
      - backend: 
          serviceName: gitlab-webservice-default
          servicePort: 8181 
        path: /
        pathType: ImplementationSpecific
  tls: 
  - hosts: 
    - gitlab.xxxx.io
    secretName: gitlab-crt-secret
:::
</dx-codeblock>



Ingress 创建好后，流量入口 IP 地址为所选 nginx-ingress 实例的外网 IP:

![](https://main.qcloudimg.com/raw/747ac14d9efa7ebcce591277d1bfca89.png)

http 端口为 80，https 端口为 443。如果部署在国内，使用这两个标准端口需要备案才能访问，测试时如果想使用非标端口，可以修改 nginx-ingress 实例的 service，将 80/443 改为其它端口:

``` bash
kubectl -n kube-system edit svc nginx-ingress-nginx-controller # svc 名称带 ingressClass 名称前缀
```

如果需要暴露 gitlab 的 ssh 协议，可修改 nginx-ingress 配置，将 22 端口也暴露出来，修改暴露 tcp 的 configmap:

``` bash
$ kubectl -n kube-system get cm | grep nginx-ingress
nginx-ingress-nginx-controller             6      8d
nginx-ingress-nginx-tcp                    0      8d
nginx-ingress-nginx-udp                    0      8d
qcloud-tke-nginx-ingress-controller        0      14d

$ kubectl -n kube-system edit cm nginx-ingress-nginx-tcp
```

将 gitlab shell 的 22 端口暴露在 nginx ingress controller 的 22 端口上:

```yaml
data:
  22: "devops/gitlab-gitlab-shell:22"
```

再修改 nginx ingress controller 的 service:

```bash
$ kubectl -n kube-system get svc
nginx-ingress-nginx-controller             LoadBalancer   172.21.252.133   49.233.238.230   8888:30443/TCP,8443:32345/TCP   8d

$ kubectl -n kube-system edit svc nginx-ingress-nginx-controller
```

将 controller 的 22 端口暴露到 CLB 上:

```yaml
  - name: git-ssh
    port: 22
    protocol: TCP
    targetPort: 22
```

然后 git clone 代码时就可以用 `git@` 开头的地址(ssh 协议)。

### 配置域名

gitlab 的域名配置主要用于信息展示，比如 git clone 代码时显示的 url 地址，可以通过以下配置来设置:

```yaml
global:
  hosts:
    gitlab:
      name: gitlab.example.com # 页面展示的域名
      https: true # 展示的 URL 中是否用 https。如果为 ingress 配了证书，这里就置为 true
```
