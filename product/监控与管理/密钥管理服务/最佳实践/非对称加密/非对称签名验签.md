## 操作流程
当您需要进行传递敏感信息时，针对在信息系统中所有需要无法否认的行为（包括发送、接收、审批、修改、删除、添加、配置等操作），可以通过非对称签名验签的方案来实现实体行为的不可否认性。

从信息发送者的角度来说，使用非对称签名验签方案，您需要进行以下操作：
1. 在密钥管理系统 KMS 中创建非对称密钥对，详情请参见 [创建主密钥](https://cloud.tencent.com/document/product/573/34430) 。
2. 信息发送者使用创建的用户私钥对需要传输的数据生成签名，详情请参见 [签名](https://cloud.tencent.com/document/product/573/50534) 。
3. 信息发送者将签名和数据传递给信息接收者。
4. 信息接收者拿到签名和数据之后，进行签名验证，有以下两种方式进行校验。
	 1. 调用 KMS 的验证签名功能接口进行校验，详情请参见 [验证签名](https://cloud.tencent.com/document/product/573/50535) 。
	 2. 下载 KMS 非对称密钥公钥，在本地通过 gmssl、密码库、KMS 的国密 Encryption SD K等验签方法进行验证。

>?非对称签名验签目前只支持 SM2 加密算法。

## 操作步骤

调用 [创建主密钥](https://cloud.tencent.com/document/product/573/34430) API 接口创建用户主密钥，在 KMS 中创建密钥的时候，必须传入正确的密钥用途 **KeyUsage= ASYMMETRIC_SIGN_VERIFY_SM2**，才可以使用签名的功能。

### 步骤一：创建非对称签名密钥
请求：
```
tccli kms CreateKey --Alias test --KeyUsage ASYMMETRIC_SIGN_VERIFY_SM2
```
返回结果：
```
{
"Response": {
  "KeyId": "22d79428-61d9-11ea-a3c8-525400******",
  "Alias": "test",
  "CreateTime": 1583739580,
  "Description": "",
  "KeyState": "Enabled",
  "KeyUsage": "ASYMMETRIC_SIGN_VERIFY_SM2",
  "RequestId": "0e3c62db-a408-406a-af27-dd5ced******"
}
}
```

### 步骤二：下载公钥

请求：
```
tccli kms GetPublicKey  --KeyId 22d79428-61d9-11ea-a3c8-525400******
```
返回结果：
```
{
"Response": {
  "RequestId": "408fa858-cd6d-4011-b8a0-653805******",
  "KeyId": "22d79428-61d9-11ea-a3c8-525400******",
  "PublicKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzQk7x7ladgVFEEGYDbeUc5aO9TfiDplIO4WovBOVpIFoDS31n46YiCGiqj67qmYslZ2KMGCd3Nt+a+jdzwFiTx3O87wdKWcF2vHL9Ja+95VuCmKYeK1uhPyqqj4t9Ch/cyvxb0xaLBzztTQ9dXCxDhwj08b24T+/FYB9a4icuqQypCvjY1X9j8ivAsPEdHZoc9Di7JXBTZdVeZC1igCVgl6mwzdHTJCRydE2976zyjC7l6QsRT6pRsMF3696N07WnaKgGv3K/Zr/6RbxebLqtmNypNERIR7jTCt9L+fgYOX7anmuF5v7z0GfFsen9Tqb1LsZuQR0vgqCauOj************",
  "PublicKeyPem": "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzQk7x7ladgVFEEGYDbeU\nc5aO9TfiDplIO4WovBOVpIFoDS31n46YiCGiqj67qmYslZ2KMGCd3Nt+a+jdzwFi\nTx3O87wdKWcF2vHL9Ja+95VuCmKYeK1uhPyqqj4t9Ch/cyvxb0xaLBzztTQ9dXCx\nDhwj08b24T+/FYB9a4icuqQypCvjY1X9j8ivAsPEdHZoc9Di7JXBTZdVeZC1igCV\ngl6mwzdHTJCRydE2976zyjC7l6QsRT6pRsMF3696N07WnaKgGv3K/Zr/6RbxebLq\ntmNypNERIR7jTCt9L+fgYOX7anmuF5v7z0GfFsen9Tqb1LsZuQR0************\n1QIDAQAB\n-----END PUBLIC KEY-----\n"
}
}
```
将公钥 PublicKeyPem 转成 pem 格式，并存入 public_key.pem 文件：
```
echo 
"
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzQk7x7ladgVFEEGYDbeU
c5aO9TfiDplIO4WovBOVpIFoDS31n46YiCGiqj67qmYslZ2KMGCd3Nt+a+jdzwFi
Tx3O87wdKWcF2vHL9Ja+95VuCmKYeK1uhPyqqj4t9Ch/cyvxb0xaLBzztTQ9dXCx
Dhwj08b24T+/FYB9a4icuqQypCvjY1X9j8ivAsPEdHZoc9Di7JXBTZdVeZC1igCV
gl6mwzdHTJCRydE2976zyjC7l6QsRT6pRsMF3696N07WnaKgGv3K/Zr/6RbxebLq
tmNypNERIR7jTCt9L+fgYOX7anmuF5v7z0GfFsen9Tqb1LsZuQR0************
1QIDAQAB
-----END PUBLIC KEY-----
" > public_key.pem
```

>?另外，您可以登录 [KMS 控制台](https://console.cloud.tencent.com/kms2/index) ，单击【用户密钥】>【密钥ID/密钥名称】进入密钥信息页面，直接下载非对称密钥公钥。

### 步骤三：计算消息摘要

- 如果待签名的消息的长度不超过4096字节，可以跳过本步骤，直接进入 [步骤 4](#test4)。
- 如果待签名的消息的长度超过4096字节，则需先在用户端本地计算消息摘要。具体操作如下：
 1. 创建测试明文文件：
	```
	echo "test" > test_verify.txt
	```
>?生成文件后，需对文件进行 truncate 操作（**truncate -s -1 test_verify.txt**）。
 2. 使用 gmssl 对 test_verity.txt 文件内容进行摘要计算
	```
	gmssl sm2utl -dgst -in ./test_verify.txt -pubin -inkey ./public_key.pem -id 1234567812345678 > digest.bin
	```

[](id:test4)
### 步骤四：通过 KMS 签名接口生成签名

调用 KMS 的 [签名](https://cloud.tencent.com/document/product/573/50534) API 接口计算信息的签名。
1. 消息原文或消息摘要进行计算签名之前，需先进行 base64 编码。
```
gmssl enc -e -base64 -A -in digest.bin -out encoded.base64
```
2. 进行签名的计算。
请求：
```
// 将上述 encoded.base64 文件中的内容作为 SignByAsymmetricKey 的 Message 参数，以消息摘要的形式进行签名：
tccli kms AsymmetricRsaDecrypt --KeyId 22d79428-61d9-11ea-a3c8-525400****** --Algorithm SM2DSA --Message "qJQj83hSyOuU7Tn0SRReGCk4yuuVWaeZ44BP******==" --MessageType DIGEST

// 以消息原文的形式进行签名：
tccli kms AsymmetricRsaDecrypt --KeyId 22d79428-61d9-11ea-a3c8-525400****** --Algorithm SM2DSA --Message "dG***Ao=" --MessageType RAW
```
返回结果：
```
{
"Response": {
  "Signature": "U7Tn0SRReGCk4yuuVWaeZ4******",
  "RequestId": "408fa858-cd6d-4011-b8a0-653805******"
}
}
```
将签名内容 Signature 存入 signContent.sign 文件：
```
echo "U7Tn0SRReGCk4yuuVWaeZ4******" | base64 -d > signContent.bin
```

### 步骤五：验证签名

1. 通过 KMS 验证签名接口校验。
	请求：
	```
	// 对消息原文进行验证
	tccli kms VerifyByAsymmetricKey --KeyId 22d79428-61d9-11ea-a3c8-525400****** --SignatureValue signContent.sign --Message digestFile.bin --Algorithm SM2DSA --MessageType DIGEST
	// 对消息摘要进行验证
	tccli kms VerifyByAsymmetricKey --KeyId 22d79428-61d9-11ea-a3c8-525400****** --SignatureValue signContent.sign --Message "dG***Ao=" --Algorithm SM2DSA --MessageType RAW
	```
	>?签名接口和验签接口中使用的参数 Message 和 MessageType 的取值要保持一致。
	>
	返回结果：
	```
	{
	"Response": {
		"SignatureValid": "Verified OK",
		"RequestId": "6758cbf5-5e21-4c37-a2cf-8d47f5******"
	}
	}
	```
2. 通过 KMS 公钥和签名内容在本地进行验证。
	请求：
	```
	gmssl  sm2utl -verify -in ./test_verify.txt -sigfile ./signContent.bin -pubin -inkey ./public_key.pem -id 1234567812345678
	```
	返回结果：
	```
	Signature Verification Successful
	```
