
### 代码中 `throw new Error` Aegis SDK 没有捕获到，如何处理？[](id:que1)
在 VUE 框架中，Vue.config.errorHandler 会主动捕获错误，可以通过主动捕获再调用 aegis.error() 进行上报


接口403一般是因为页面域名校验失败导致的，可以检查项目创建时候设置的域名跟实际上报的域名是否一致。如果项目为非 web 项目，这个域名需要填 *。用户在 RUM 平台上创建应用后，会得到一个长度为 18 位的字符串，这个字符串为上报id，new Aegis 的时候传入的 id 就是这个上报id。 如果项目刚刚创建，那 RUM 数据同步需要一定的时间，大概在1-2min，可以稍微等一下，这段时间用来读一下文档也是不错的。

### 自定义测速为什么仅支持 0 - 60000 之间的数据？[](id:que2)

自定义测速的逻辑是用户上报任意数据，我们对用户数据进行求均值和中位数，然后显示计算后的结果，但是这样带来的问题就是，服务端无法判断脏数据，但是少量脏数据对用户实际数据却会产生非常大的影响，因此我们目前在服务端对用户数据进行了限制，目前只支持 0-60000 内的数据。

### RUM 根据哪个字段来计算UV？[](id:que3)

aegis sdk 没有根据用户设置的uin来计算uv，因为如果当前用户没有登录，则无法计算，而且uin值由开发者设置，并不完全可靠，还有无法将用户登录前后状态统一起来，因此 aegis sdk为每个用户独立生成一个 aid 作为用户（设备）的唯一标识，并且存储在 localstorage 里面，不受登录态影响。

### 日志里面的“图片加载失败”、“JS 加载失败”、“CSS 加载失败” 这样的问题如何查？[](id:qu4)

首先自己访问一下这个资源看是否有异常情况。如果自己访问正常，但是日志里面还是有比较多的异常情况，再查看一下这些异常是否有聚集的情况，比如区域聚集，运营商聚集等等。如果还是没有发现有聚集的情况，那大概率是因为用户的网络问题导致的资源加载异常，可以尝试项目中接入PWA或者离线包来减少这类情况。本质上，前端没有办法完全避免这种情况。

### 有不少错误日志是 Script error. @ (:0:0) 没啥信息。 这种是第三方JS异常吗？可以通过配置过滤掉吗？[](id:que5)

Script error. 也被称为跨域错误，当网站请求并且执行一个非本域名下的脚步的时候，如果跨域脚本发生错误，就有可能抛出这个错误。由于项目中，我们的脚本都是放在 CDN 上的，因此这种错误最为常见。

其实这并不是一个JavaScript Bug。出于安全考虑，浏览器会刻意隐藏其他域的JS文件抛出的具体错误信息，这样做可以有效避免敏感信息无意中被不受控制的第三方脚本捕获。因此，浏览器只允许同域下的脚本捕获具体错误信息，而其他脚本只知道发生了一个错误，但无法获知错误的具体内容。更多信息，请参见[Webkit源码](https://trac.webkit.org/browser/branches/chromium/648/Source/WebCore/dom/ScriptExecutionContext.cpp?spm=a2c63.p38356.879954.4.35155db7eUvHNi&file=ScriptExecutionContext.cpp#L294)。

具体解决方式：

解决办法1：CORS

第一步：资源添加 crossorigin 属性

```html
<script src="http://another-domain.com/app.js" crossorigin="anonymous"></script>
```

第二步：CDN 添加 cors 响应头，这个基本是 cdn 默认的，所以实际上我们并不需要做什么。

```javascript
`Access-Control-Allow-Origin: *`
```

解决办法2: try catch

window.onerror 中只能捕获 `Script error.`，但是 try catch 中却能打印详细的错误栈。

```html

<!doctype html>
<html>
<body>
    <script src="http://another-domain.com/app.js"></script>
    <script>
        window.onerror = function (message, url, line, column, error) {
            console.log(message, url, line, column, error);
        }
        try {
            foo(); // 调用app.js中定义的foo方法
        } catch (e) {
            console.log(e);
            throw e; // 主动抛出的错误捕获后不是 Script error
        }
    </script>
</body>
</html>
```

解决办法3: 如果不想解决，只想直接屏蔽的话，请参见 [问题6](#que6)。

### 我有一些特殊的日志，不想上报到 RUM 平台，有什么办法？[](id:que6)

SDK 提供一个 hook 来帮助用户在日志上报前对日志进行操作和限制，可以使用 beforeReport，返回false或者空值就可以不上报该条日志啦。

```javascript
new Aegis({  
  id: 'pGUVFTCZyewhxxxxxx',
  beforeReport(log) {
    if (log.msg && log.msg.indexOf('Script error') !== -1) {
      return false
    }
    return log;
  }
})
```

### 我开启了 SPA 参数，但是页面之间跳转的时候，为什么没有上报页面性能呢？[](id:que7)

spa页面之间的跳转，本质上只是一段js代码的执行，首屏探测的是从用户浏览器发起请求到页面可见元素渲染完成的时间，因此，没有办法计算首屏。

### 日志里面上报了非常多 AJAX 异常，状态码是 0 ，这个可能是什么原因导致的？[](id:que8)

HTTP 接口的 status 是 0，有以下几种可能：超时，abort，cancel，跨域。

开发者本地调试可能没有发现这种错误，但是在用户侧却能经常发生，这个是什么原因呢？因为用户侧可能随时离开页面，或者因为网络问题把某次 HTTP 请求中断了，这种情况就会发生 status 为 0 的情况。
虽然 status 为 0 有多种情况，但是我们也可以根据日志里面的信息看出一些端倪。比如接口耗时都非常小，而且发生的用户比较集中，因此可以判断该接口是 浏览器插件屏蔽掉了，这种情况常见于一些数据上报的接口。

如果看到 duration 非常长，那超时的可能性就比较大了，开发者也可以查看自己接口的超时时间来进行对比。至于跨域的情况，可以检查一下后台的业务逻辑是否正常，而 cancel 的情况，多半是前端业务控制的，也可以看下具体的业务逻辑。
