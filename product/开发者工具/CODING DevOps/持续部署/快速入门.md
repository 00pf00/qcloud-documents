本文为您详细介绍 CODING 持续部署中的应用与项目。

## 前提条件
使用 CODING 项目管理的前提是，您的腾讯云账号需要开通 CODING DevOps 服务，详情请参见 [开通服务](https://cloud.tencent.com/document/product/1159/44859)。

## 进入项目
1. 登录 [CODING 控制台](https://console.cloud.tencent.com/coding)，单击**立即使用**进入 CODING 使用页面。
2. 单击工作台首页左侧的 <img src ="https://main.qcloudimg.com/raw/12230547b45d5eae85ad1c4fa86fba68.png" width="15"style ="margin:0" data-nonescope="true" >，进入持续部署控制台。

## 功能介绍
CODING 持续部署中的应用和项目都是属于企业/团队的一级资源，它们之间为一对多关系，即一个项目包含多个应用，一个应用从属于多个项目。
![](https://main.qcloudimg.com/raw/5fc16ba3ed1c8a7ff1018ef7cfbc5fa3.png)
在该设计下，运维人员可以专注于应用的持续部署管理（部署流程、基础设施等），而非运维人员（一般指开发）只需要在项目维度操作（提交发布单，查看发布详情），使运维能够专注于在云的基础上做基础设施运维，开发在项目内就能够进行大部分业务运维并完成从需求到发布的完整闭环。

## 应用本文为您详细介绍在 CODING 中持续部署的基本操作。

## 前提条件
使用 CODING 项目管理的前提是，您的腾讯云账号需要开通 CODING DevOps 服务，详情请参见 [开通服务](https://cloud.tencent.com/document/product/1159/44859)。 


## 进入项目
1. 登录 [CODING 控制台](https://console.cloud.tencent.com/coding)，单击**立即使用**进入 CODING 使用页面。
2. 单击工作台首页左侧的 <img src ="https://main.qcloudimg.com/raw/12230547b45d5eae85ad1c4fa86fba68.png" style ="margin:0" width="15"data-nonescope="true">，进入持续部署控制台。

## 功能介绍[](id:intro)
CODING 持续部署用于把控构建之后的项目发布与部署交付流程。能够无缝对接上游 Git 仓库、制品仓库以实现全自动化部署。在稳定的技术架构、运维工具等基础上，具备蓝绿发布，灰度发布（金丝雀发布），滚动发布，快速回滚等能力。
下文将以一个简单的 Demo 项目为例，演示如何使用 CODING 持续部署控制台将应用发布至腾讯云集群。

## 前置准备[](id:prepare)

-   开启持续部署部署设置权限，更多详情请参见 [权限说明](https://cloud.tencent.com/document/product/1159/44862)。
-   一个可被 CODING 持续部署访问的 Kubernetes 集群，如何申请 Kubernetes 集群，请参见 [腾讯云标准集群](https://cloud.tencent.com/document/product/457/54231)。
-   导入 [示例代码库](https://codingtest-cd.coding.net/public/k8sdemo/k8sDemo/git/files)。
-   Docker 制品仓库，具体如何使用请参见 [Docker 制品仓库](https://cloud.tencent.com/document/product/1116/46527)。

## 操作步骤
### 步骤1： 获取并关联云账号[](id:1)
因使用了腾讯云容器服务，部署后应用将发布至集群，本示例使用的团队账号已在**团队管理**>**服务集成**中关联 [腾讯云账号](https://cloud.tencent.com/document/product/1159/45162)。
1. 单击首页左侧的**部署控制台**，在**云账号**中绑定腾讯云账号。云账号名称可以自拟，选择地域后将自动获取对应集群。
![](https://qcloudimg.tencent-cloud.cn/raw/5aa6d996c5ce55cdc579f154d7ad9c25.png)
2. 自动生成的制品仓库访问凭证将存储于**命名空间**，您可以在腾讯云控制台中新建。
![](https://qcloudimg.tencent-cloud.cn/raw/58c6f7156f1fc918b6cce00304b223c9.png)

### 步骤2：配置应用[](id:2)
1. 成功添加云账号后，在部署控制台中单击**创建应用**，填写应用名与选择部署方式。
![](https://qcloudimg.tencent-cloud.cn/raw/745d29719a7edbbbd3ae6efe68d22da0.png)
2. 选择**部署到 Kubernetes 集群**模板，填写名称与描述后完成创建。
![](https://qcloudimg.tencent-cloud.cn/raw/2da9d97a78b89da4c71ae0a8a8e806f6.png)

### 步骤3：初始化项目[](id:3)
此步骤主要用于配置持续部署所涉及代码仓库与制品仓库。
1. 在**代码仓库**中点选导入外部仓库，访问 [示例仓库](https://codingtest-cd.coding.net/public/k8sdemo/k8sDemo/git/files) 并克隆仓库地址。
![](https://qcloudimg.tencent-cloud.cn/raw/09d778c3c27fbcddb4f5efccb1258380.png)
2. 导入完成后进行制品管理，将拟发布的 Docker 制品托管至 CODING 制品仓库，详情请参见 [Docker 制品库](https://cloud.tencent.com/document/product/1116/46527)。
![](https://qcloudimg.tencent-cloud.cn/raw/3a087193bbafd452d66f32782caa524e.png)
3. 推送至制品仓库后，获取制品的拉取地址并填写至代码仓库中 `/k8s/deployment.yaml` 中的 `image` 地址。
![](https://qcloudimg.tencent-cloud.cn/raw/947e8f6ed40e8423618a0fd64b742d9c.png)
4. 接下来需导入云账号的 `imagePullSecrets` 至代码仓库中。在**部署控制台**>**云账号**中单击查看详情后，复制名称。
![](https://qcloudimg.tencent-cloud.cn/raw/9653d5ec8540d34aafdd25fc951aa8f8.png)
5. 粘贴至代码仓库中的 `deployment.yaml` 文件中，同时需注意 `namespace` 内容是否与上文中指定的**命名空间**一致。
![](https://qcloudimg.tencent-cloud.cn/raw/dece71b185c00a65dbef981854a6556d.png)
6. 同一层级的 `service.yaml` 文件中的 `namespace` 内容也需保持一致。
![](https://qcloudimg.tencent-cloud.cn/raw/34598f2826ae8215b89296cb3070571a.png)

### 步骤4：配置部署流程[](id:4)
进入部署流程配置页面，可以为此流程设定：
-   流程的执行选项（在此示例中保持默认即可）。
-   部署 Deployment 阶段以及部署 Service 阶段所需制品。
-   手动或自动触发。


1. 首先配置部署（Manifest）阶段。基础设置选择已绑定的云账号，在 Manifest 来源选择 **CODING 代码库**，填写相应的路径，镜像版本配置选择自动获取。
![](https://qcloudimg.tencent-cloud.cn/raw/d64a088ef7d137f2dacd2d5bd66a1ffd.png)
2. 配置部署 Service 阶段时步骤同上，但在文件路径处选择 `k8s/service.yaml` 文件。

### 步骤5：触发器配置[](id:5)

1. 完成部署阶段配置后，您可以使用自动化触发器、手动提交发布单执行部署。
<dx-tabs>
::: 自动触发
在**基础配置**中点选触发器类型，选择 Docker 仓库触发器。当开发人员更新代码仓库并使用 CI 将镜像打包推送至制品库后，Docker 镜像版本的更新将自动触发部署流程并将应用发布至 Kubernetes (TKE) 集群，完成后可以在基础设施页面查看并确认应用是否发布成功。
![](https://qcloudimg.tencent-cloud.cn/raw/b6f9733a997f0eb036a5df177acdbd77.png)
:::
::: 手动提交发布单
若希望通过手动提交发布单的形式触发部署流程，那么可以将**应用**（如本范例的 flaskapp ）与项目关联。在部署控制台的**应用列表**中搜索项目名称进行关联：
![](https://qcloudimg.tencent-cloud.cn/raw/a4ca58b92dc5ee67289a21d42d41b96d.png)
:::
</dx-tabs>

2. 关联完成后，单击项目中的**持续部署** > **Kubernetes** 手动提交发布单。
![](https://qcloudimg.tencent-cloud.cn/raw/ae6237b4a2adc0d3d8155aac5d45b205.png)

### 步骤6：发布完成[](id:6)
1. 发布成功后，可以查看发布的制品及启动参数及阶段执行详情等信息。
![](https://qcloudimg.tencent-cloud.cn/raw/a3067ebb1bb1a83c4e2e7f02c9df0ca9.png)
2. 当需要查看某个资源在集群中的运行状态时，单击**集群**下的工作负载即可查看详情（如工作负载的 Pod 实例，日志等信息）。
![](https://qcloudimg.tencent-cloud.cn/raw/a2306e912ed66c4595468c4190c82c12.png)
3. 在腾讯云的容器服务中查看工作负载。
![](https://qcloudimg.tencent-cloud.cn/raw/c99806922283a0ccc9e08026094470f7.png)

应用是 CODING CD 中的基本部署单位。应用包含若干个应用集群，以及安全组和负载均衡器等。应用对部署的软件集合进行抽象，通常代表您想要部署的服务、配置、以及运行所需的基础设置。推荐的做法是一个应用对应微服务架构中的一个服务。
![](https://main.qcloudimg.com/raw/f76ecdf987a25db36e5ec55810e3cd75.png)

### 对应关系示例
在微服务架构下的微服务往往对应于一个 CODING 持续部署的应用，当然您也可以在了解对应关系的情况下依照自己的偏好来设定对应关系。下面是一个典型的团队、项目、应用、集群、云账号之间的关系示例：
<table>
    <tr>
        <th colspan="4">团队：XXX 科技有限公司</th>
    </tr>
    <tr>
        <td>云账号</td>
        <td><ul style="margin:0;list-style-type:disc;">
            <li>自建 Kubernetes Service Account</li>
            <li>腾讯云北京 TKE 集群 Service Account</li>
            <li>腾讯云中国香港 API Key</li></ul>
        </td>
    </tr>
    <tr>
        <td>项目1：车载用品电商站点项目</td>
        <td><ul style="margin:0;list-style-type:disc;">
            <li>应用1：车载电商后端</li>
            <li>应用2：车载电商前端</li>
            <li>应用3：物流管理服务</li></ul>
        </td>
    </tr>
    <tr>
        <td>项目2：服装电商站点项目</td>
        <td><ul style="margin:0;list-style-type:disc;">
            <li>应用1：服装电商后端</li>
            <li>应用2：服装电商前端</li>
            <li>应用3：物流管理服务</li></ul>
        </td>
    </tr>
    <tr>
        <td>部署控制台</td>
        <td><ul style="margin:0;list-style-type:disc;">
            <li>应用1：车载电商后端
                <ul><li>测试集群</li><li>生产集群</li></ul></li>
            <li>应用2：车载电商前端
                <ul><li>测试集群</li><li>生产集群</li></ul></li>
            <li>应用3：物流管理服务
                <ul><li>车载电商测试集群</li><li>车载电商生产集群</li><li>服装电商测试集群</li><li>服装电商生产集群</li></ul></li>
            <li>应用4：服装电商后端
                <ul><li>测试集群</li><li>生产集群</li></ul></li>
            <li>应用5：服装电商前端
                <ul><li>测试集群</li><li>生产集群</li></ul></li>
        </ul>
        </td>
    </tr>
</table>

## 云账号绑定
云账号是访问云资源的凭证，进入 CODING 部署控制台创建应用，单击导航栏**应用** > **创建应用**。在进行应用创建之前，请确保您已经完成了 [云账号绑定](https://cloud.tencent.com/document/product/1159/45162)。
![](https://qcloudimg.tencent-cloud.cn/raw/f9e1d48cd5d596efe777622798d00450.png)

## 应用创建
单击首页左侧的控制台，单击右上角**创建应用**。
![](https://qcloudimg.tencent-cloud.cn/raw/3e561d7fd7e0c6102b0a2bc1195d34b8.png)

## 与项目关联
在部署控制台内完成应用创建后，可以直接在控制台首页将应用与项目相关联。
![](https://qcloudimg.tencent-cloud.cn/raw/af307348e6f30095bdc07b8bd703cad3.png)

## 新建发布单
当运维人员完成对应用的 [部署流程配置](https://cloud.tencent.com/document/product/1159/45165) 后，开发人员在项目内就可以实现从项目协同到应用发布的 DevOps 闭环。典型的场景是当有新版本需要发布时，开发人员在**持续部署** > **Kubernetes** 页面新建发布单，发布单自动触发部署流程执行，开发可随时查看发布状态和历史详情。
![](https://qcloudimg.tencent-cloud.cn/raw/261314e591c976873fa131486239655d.png)

## 管理应用
在部署控制台新建应用后可以在应用的**配置**中调整应用属性与通知，或删除应用。
![](https://qcloudimg.tencent-cloud.cn/raw/980f90c995d115ab15800db2899213ad.png)

### 应用通知
目前支持 CODING 站内通知、企业微信、钉钉和飞书四种通知方式：
![](https://qcloudimg.tencent-cloud.cn/raw/ceda4c52b9ca66b5d4d958582721571d.png)

### 显示 / 隐藏功能入口
对于不需要显示的功能入口，可以在**特性**栏将其禁用，这里的禁用并不会删除相应的数据，仅表示在控制台界面隐藏。可以隐藏部署流程、集群、负载均衡器和安全组功能入口：
![](https://qcloudimg.tencent-cloud.cn/raw/da5bb5879168af7122c8c6491eef6246.png)

### 添加实例的自定义属性链接
在**集群** > **服务组** > **实例详情**面板可以查看运行实例的自定义链接，自定义链接提供关于实例的简略信息，如：日志、健康状态等。
![](https://qcloudimg.tencent-cloud.cn/raw/5e1e79628397ad0287c2d8f3e7350596.png)
自定义链接对应的 IP 可以是公有或私有 IP，默认端口为 80；如果需要设置其他端口号，在 Path 文本框以`:`开头，如：`:7002/health`。
1. 在**链接**一栏，单击 **Add Section**。
2. **Section Heading** 输入自定义链接标题。
3. **Links** 输入自定义链接名称，以及 URL。

>?URL 字段支持使用表达式引用更多的实例属性。例如对于腾讯云实例，可以使用`{region}`引用实例的所在地域。

5. 单击 **Add Link** 在同一属性下添加更多链接。
6. 单击 **Add Section** 添加新的自定义属性链接。
7. 单击**撤销**取消添加操作。**撤销**不会删除已保存的自定义属性链接。
8. 单击**保存**完成操作。

### 流量保护
>? 流量保护旨在确保任何时间至少有一个实例处于正常运行状态。

启用流量保护功能后，如果用户或者脚本尝试删除、禁用或对服务组进行伸缩容操作，CODING 控制台会对操作进行验证以确保集群中至少有一个实例在正常运行，否则将会拒绝用户或脚本请求。
1. 在**流量保护**栏，单击**添加流量保护**。
2. 以下是需要填写的字段：

<table>
   <tr>
      <th width="0px" style="text-align:center">字段</td>
      <th width="0px" style="text-align:center">必填项</td>
      <th width="0px"  style="text-align:center">说明</td>
   </tr>
   <tr>
      <td>云账号</td>
      <td>是</td>
      <td>设置流量保护的云账号</td>
   </tr>
   <tr>
      <td>地域</td>
      <td>是</td>
      <td>可选的地域，`*` 表示选择所有地域</td>
   </tr>
   <tr>
      <td>分组</td>
      <td>否</td>
      <td>设置流量保护的集群分组，如果留空表示选择不属于任何分组的集群</td>
   </tr>
   <tr>
      <td>详情</td>
      <td>否</td>
      <td>详情是区分集群的三级字段，具有相同 `${Application}-${Stack}-${Detail}` 的服务组属于同一个集群</td>
   </tr>

</table>

3. 单击**保存**使配置生效。

### 应用删除
如果应用中有服务组，需要先删除服务组。
进入 [部署控制台](https://console.cloud.tencent.com/coding) 后，单击应用右下角**齿轮图标**，进入应用配置页后单击**删除**。
![](https://qcloudimg.tencent-cloud.cn/raw/3b05e53650b614676086670879a08abd.png)
