## 执行 SELECT 任务
用户可以通过 SQL 语句对创建的数据库和数据表中数据进行查询、分析和计算。DLC 支持的 SQL 查询语句及函数请参考章节【SQL语法参考】

### 执行 SELECT 查询任务
1. 选择默认数据库。用户可以选择一个默认数据库，则在 SQL 语句中会将没有指定数据库的操作在默认数据库下执行。
2. 运行 SQL 任务。单击**运行**，即可开始运行 SQL 任务。
 - DLC 单个任务运行时间的上限为30分钟。
 - DLC 为 Serverless 架构，算力资源会临时被调度。在一段时间内，首次运行 DML 任务的结果返回时间可能会比正常任务稍慢。
3. 任务执行完成，会在控制台展示查询结果。
若用户退出了控制台页面，则无法在控制台查看历史任务的查询结果，需要到用户配置的查询结果 COS 桶中查看任务结果文件。

### 取消正在执行的查询任务
在任务运行过程中，**运行**会切换为**取消**，可单击**取消**，取消本次查询。取消查询后，DLC 不会返回查询结果，但是 DLC 会统计已经执行的数据扫描量。
![](https://main.qcloudimg.com/raw/2d9a0d79253e3746fef614e05719d7be.png)

### SELECT 查询任务结果投递到用户桶
DLC 会将每次 SELECT 任务的结果投递至用户的 COS 桶中，首次访问 DLC 控制台，系统会提示配置查询结果投递路径。若未配置，则无法执行 SQL 语句。任务结果的存储路径可参见 [任务结果](#jump2)。

[](id:jump1)
## 查询分区表
若用户将数据以分区目录的方式进行存储，可以减少 DLC 计算任务的数据扫描量，大幅度提升运算性能。对数据进行分区最常见的做法是将数据按照时间存储到不同目录下，例如，将同一天产生的数据放到一个目录下，可以按照“年-月-日”组织多层数据目录。DLC 中的同一个表及其分区必须使用相同的数据格式。

### 创建分区别
创建分区表需要在建表语句中指定分区字段，具体可参见 [数据表操作](#jump3)。

### 添加分区数据
在创建数据表时指定分区仅是配置了分区字段，不能立刻执行查询语句获取数据。用户需要将分区数据添加至数据表。若有新的分区数据添加至数据目录，则需要添加分区信息到数据表。

- 方案一：使用`ALTER TABLE ADD PARTITIO`语句，手动添加分区
`ALTER TABLE ADD PARTITIO`语句将会把指定的分区目录添加至数据表。若区目录兼容 Hive 的分区规则：**分区列名=分区列值**，则无需指定数据路径。否则，需要显示指定数据路径。详情请参考【SQL语法说明】。
 - 示例1：单个分区目录，分区目录符合
```sql
ALTER TABLE tabel_demo ADD
PARTITION (dt = '2021-01-01');
```
 - 示例2：多层分区目录嵌套
```sql
ALTER TABLE tabel_demo ADD
PARTITION (year = '2021', month='01', day='01');
```
 - 示例3：显示指定分区路径
```
ALTER TABLE tabel_demo ADD
PARTITION (year = '2021', month='01', day='01') LOCATION 'cosn://tablea_demo' ;
```
- 方案二：使用`MSCK REPAIR TABLE`语句，自动添加分区
`MSCK REPAIR TABLE`语句将扫描在建表时指定的数据目录，若存在新的分区目录，则系统会自动将这些分区添加到数据表的元数据信息中，详情请参考【SQL语法说明】。示例如下：
```sql
MSCK REPAIR TABLE table_demo
```

**系统约束**
-  `MSCK REPAIR TABLE`仅向数据表元数据添加分区，不会删除它们。想要删除已经添加的分区，可执行语句`ALTER TABLE table-name DROP PARTITION`。详情请参见 [SQL 语法](https://cloud.tencent.com/document/product/1342/61734)。
- 若数据量非常大，MSCK REPAIR TABLE不是推荐的方案。系统会扫描全量数据，并且消耗很长的时间，可能会导致任务超时，使得数据表的分区信息处于不完整状态。
- 分区目录必须兼容 Hive 的分区规则：**分区列名=分区列值**，若不一致，请使用`ALTER TABLE ADD PARTITIO`加载分区。详情请参见 [SQL 语法](https://cloud.tencent.com/document/product/1342/61734)。
- 请确保在单独的文件夹层次结构中保留单独表的数据。例如，假设 COS 服务中有表 A 的数据`cosn://tablea_a`和表 B 的数据`s3://table_a/table_b`如果两个表都按字符串进行分区，`MSCK REPAIR TABLE`会将表 B 的分区添加到表 A。为了避免这种情况，请使用单独的文件夹结构，如`cosn://tablea_a`和`cosn://tablea_b`。
- 该语句可能会导致 COS 服务的数据读写开销，可参见 [COS 服务的收费标准](https://cloud.tencent.com/document/product/436/16871)。

## 查询 Json 数据
1. 创建数据表，指定 Json 解析格式。
```
 	CREATE EXTERNAL TABLE `order_demo`(
  `docid` string COMMENT 'from deserializer',
  `user` struct < id :int,
  username :string,
  name :string,
  shippingaddress :struct < address1 :string,
  address2 :string,
  city :string,
  state :string > > COMMENT 'from deserializer',
  `children` array < string >
) ROW FORMAT SERDE 'org.apache.hive.hcatalog.data.JsonSerDe' LOCATION 'cosn://dlc-bucket/order'
```
2. 执行查询语句查询 Json 数据。DLC 支持 Json 解析函数`json_parse()`，`json_extract_scalar()`，`json_extract()`等。详情请参见 [SQL 语法](https://cloud.tencent.com/document/product/1342/61734)。
```sql
SELECT `user`.`shippingaddress`.`address1` FROM `order_demo` limit 10;
```

**系统约束**
- 必须是完整的 JSON 格式，否则 DLC 无法正常解析。
- 同一行数据不能有换行符，不能对 Json 进行可视化格式优化。例如：
```json
{"name":"Michael"}
{"name":"Andy", "age":30}
{"name":"Justin", "age":19}
```
- DLC 会自动将 Json 的一层级识别为数据表的属性列，其余嵌套结构识别为对应的属性值。
