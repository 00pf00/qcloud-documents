深度学习实现图片分类
场景背景

随着信息时代的发展，伴随着照相装备和图片采集设备的普及，越来越多的图片数据广泛存在于生产生活的各个角落，如何对海量图片数据进行高效的分类和检索成为了一项新的挑战。

本文通过智能钛机器学习平台，提供一种深度学习快速搭建图像分类模型的使用方法。用户无须编写代码，只要拖动相应的算法组件，便可以在十几分钟的时间内快速上手，解决自己的实际问题。

## 案例相关材料
相关材料下载链接（该实验选取部分图像作为训练数据）：
 - [LICENSE.txt](https://main.qcloudimg.com/raw/bf4914e86227a9b374866bfb04cc87d7/LICENSE.zip)
 - [data.zip](https://main.qcloudimg.com/raw/098d9b14ea28b0b95e0910dd08d03f1a/data.zip)（包含：daisy、dandelion、roses、sunflowers、tulips 5 个文件夹）
 数据集中有五个子文件夹，代表了需要分辨的五类花朵： Daisy（菊花）、Dandelion（蒲公英）、Rose（玫瑰）、向日葵（Sunflower）和Tulip（郁金香），均为JPG格式。
(https://main.qcloudimg.com/raw/cb16186fcf4cf98a6764face437a59ca.png)
本案例中拆分比例为8:2，即80%的图片用于训练，20%的图片用于测试

整体流程

工作流整体流程如下





本场景中，将通过搭建CNN网络训练分类模型，识别五种花朵；训练完成后部署模型，通过HTTP调用返回预测结果，共包含6个环节，预计完成需要***时间。这六个流程分别是：

  1.  	数据准备                         
  2.  	将数据拆分成训练集、验证集和测试集            
  3.  	将原始 JPG 文件转换成高效的 TFRecord    
  4.  	选择合适的 CNN 网络处理分类任务           
  5.  	生成 TensorBoard 服务， 提供可视化的查看工具
  6.  	模型运行、部署及调用                   

前提条件

- 已完成 开通服务
- 已完成 新建工程和工作流（目前是一键授权，还未体验无法改写）

详细流程

1. 数据准备

本案例中，用户可通过【控制台】上传数据文件，将图片样本以上传【文件夹】形式上传至 COS：

通过控制台上传文件夹详见：https://cloud.tencent.com/document/product/851/17083

1. 在 智能钛 控制台的左侧导航栏，选择【输入】>【数据源】>【 COS 数据集】，拖入画布中
2. 填写 COS 路经地址：
   ${COS}为地址前缀，本案例先在cos根目录下创建了一个名为flower的文件夹，并且将flower数据集上传至本文件夹中，因此路径为如图所示编写。第一个flower代表用户自建的文件夹名称，第二个flower为数据集名称。



2. 切分数据

在模型训练的时候通常会将所有的数据分成三部分， 分别是训练集 training set， 验证集 validation set 和测试集 test set。 训练集用来训练模型， 验证集用于调节超参数，测试集用来整体评估模型的性能。 本文的实验较简单，可以只将数据切割成训练集和测试集，比例为 8 : 2， 80% 用于训练， 20% 用于测试

1. 在 TI 控制台的左侧导航栏，选择【输入】>【数据转换】>【Split dataset】
2. 将【Split dataset】组件拖入画布，右键单击该组件重命名为：切分数据
3. 填写参数， 其余参数均可默认：
   - 图像存储路径：自动生成 
   - 输出路径：填写您希望输出文件的地址，比如/flower/output。本案例中为
   - 分类 or 检测任务：Classification (分类)
   - 验证集比例：0.2



本组件将会在输出路径下产生三个文件，分别是 train.txt （训练集索引）， valid.txt （测试集索引） 和 label_map.txt （映射文件）

3. 数据格式转换

TFRecord 数据文件是一种将图像数据和标签统一存储的二进制文件，能更好的利用内存，在tensorflow中快速的复制，移动，读取，存储等。在这一步中，我们将原始 JPG 文件转换成高效的 TFRecord

1. 在 TI 控制台的左侧导航栏，选择【输入】>【数据转换】>【 image -> tfrecord (Image Classification）】
2. 将【image -> tfrecord (Image Classification）】组件拖入画布，右键单击该组件重命名为：数据格式转换。
3. 将 【切分数据】 的输出桩，连到 【数据格式转换】 左边的输入桩上；
   
4. 填写参数， 其余参数均可默认：
   - 数据输入：即左侧输入桩， 代表 train.txt 和 valid.txt 所在地址，自动生成
   - 图像存储路径： 本示例填写：/flower/flower
   - 训练集和验证集数据输出路径： 自动生成
   - 是否分类任务：True
   - images/split（每份 record 文件所含图像数，在数据集较大时将存储成多份文件）：1000



本组件将会在两个输出路径下，分别生成训练集和测试集的TFRecord文件， 供后面的分类网络使用

4. 分类网络

选择合适的 CNN 网络处理分类任务，这里以 Inception 网络为例。 Inception 网络的详情可以参考论文 https://arxiv.org/abs/1409.4842

1. 在 TI 控制台的左侧导航栏，选择【算法】>【深度学习算法】>【计算机视觉】>【 Inception 】
2. 将【 Inception 】组件拖入画布，右键单击该组件重命名为：Inception
3. 将【数据格式转换】的两个输出桩，分别连接到【 Inception 】 左侧的两个输入桩上，代表了训练集和测试集的文件位置。
   
4. 填写参数：
   - 数据输入， 数据输出： 即左侧两个输入桩，代表了训练集和测试集的文件位置， 已根据连线自动生成。
   - 可视化文件存储目录： 即您希望的输出日志文件的地址，用于 tensorboard 读取。本示例中填写：/flower/tensorboard
   - 预训练模型： 即增量训练的基础模型的地址，此处为从头训练，默认填0即可
   - 类别标签映射文件： 即 【切分数据】 中生成的 label_map.txt 文件， 填写 /flower/output/label_map.txt
   - 网络名称： 即 Inception 的版本， 此处可以选择 V1
   - 类别数： 即分类的个数，此处共有五种花朵，故填5
   - 批处理大小： 即 batch_size 的大小。受限于计算机内存和显存的限制，不可能将数据全部载入训练，只能采用分批次的情况，此处填写每个批次需要学习的图片数量30
   - 迭代次数： 即运行了多少次训练， 迭代次数 * 批处理大小，代表了训练中实际用到的图片数量。 此处迭代次数可以填写 2000
   - 初始学习率： 即网络更新迭代的初始速率， 此处可以填写0.01
   - 学习率衰减步数 和 衰减因子： 开始训练时，较大的学习率有利于学习新的信息，而随着学习的深入，将网路的迭代速率调慢，有助于网络的收敛。此处可以分别填写 100 和 0.1
   - GPUs: 深度学习网络用到了 GPU 资源， 可以极大地提高训练速度。 点击该选项，在对话框中选择合适的显卡型号和数量。 此处 1 张显卡即可



1. 本组件会根据配置生成相应的算法模型，供评价、部署使用。长方形组件左边的圆形漏斗，即代表了模型本身。将【数据格式转换】右边的输出桩连到【inception】组件最左侧的蓝色漏斗处。
2. 设置漏斗（模型）参数
   - 自动运行：打开
   - 类别数：5
   - 批量处理大小：30
   - 迭代次数：2000
     
   

5. TensorBoard

TensorBoard是一个可视化工具，能够有效地展示Tensorflow在运行过程中的计算图、各种指标随着时间的变化趋势以及训练中使用到的数据信息。

1. 在 TI 控制台的左侧导航栏，选择【算法】>【深度学习算法】>【计算机视觉】>【 TensorBoard Visualization 】
2. 将【 TensorBoard Visualization 】组件拖入画布，右键单击该组件重命名为：TensorBoard
3. 将长条状的【 Inception 】组件的输出桩连接到 【TensorBoard】的输入桩上
4. 填写参数：
   - TensorBoard 路径： 即 【Inception】网络的“可视化文件存储目录”， /flower/tensorboard
   - 展示时间： 由于 TensorBoard 本身是一种服务，故需要填写服务的生命周期， 此处填写20， 即代表该组件将运行20分钟，在这20分钟内可以查看 TensorBoard 的内容



本组件将生成一个 TensorBoard 的服务， 提供可视化的查看工具

6、运行调度及训练进度查看

保存工作流

  单击工具条上的磁盘图标，保存工作流



运行完整流程

  单击工具条上的“三角”箭头，运行完整的流程



从指定环节开始运行

  右键单击要运行的环节，选择“起点运行”，从该环节开始向下执行



日志信息

  可以在相应组件点击右键【日志信息】和 【TensorFlow 控制台】 - 【APP详情】 查看相应日志



训练进度及模型评价

有三种查看训练效果的路径，分别是【Inception】- 【 APP 详情】- 【stdout】， 【Inception】- 【 APP 详情】 - 【TensorBoard】， 【TensorBoard】- 【APP 详情】 - 【TensorBoard】

- 在 【Inception】 组件运行过程中， 可以通过鼠标右键 【TensorFlow控制台】 - TensorBoard详情， 查看实时的训练进度。 注意，只有在【Inception】组件运行时，它右键的TensorBoard才能查看，一旦当该网络训练结束，对应服务停止后，将无法查看
- 为了满足训练完成后查看训练结果的需求， 我们最后手工拖动的 TensorBoard 组件，将在设定的生命周期内，为我们提供查看服务

   下图是 TensorBoard 显示的训练指标，可以看到，随着迭代次数的增加，训练集的 loss 逐渐降低， 准确率 Accuracy 逐渐升高，说明网络在不断收敛。 同此同时，测试集的 Loss 也在逐渐降低， Accuracy逐渐升高，说明网络并没有过拟合，具有良好的泛化能力，在新的数据集上依旧有良好的分类表现。 由图可知， Inception V1 网络在五种花朵的分类训练中，训练集的准确率达到99%， 测试集的准确率为75%



  下图是 TensorBoard 显示的 Inception V1 的网络拓扑结构图， 从图中我们可以查看到整个 TensorFlow 的调度流程以及 网络的内部结构。 从图中我们可以看到， Inception V1 网络包含了不同尺度的卷积网络。我们可以对照论文中的描述，直观地了解它的结构，更深入地理解模型



模型部署及调用

部署

训练完成后，鼠标右击【Inception】网络左边的圆形漏斗，选择【模型操作】-【模型在线部署】

填写部署参数：

- 模型组：选择需要部署的模型组，如果没有可选的模型组需要事先在“模型管理”菜单里新建模型组。
- 实例类型：选择实例运行的配置，本例中选择“GPU”。
- 实例数：1
- 服务分类：根据模型类型选择，本例中选择“深度学习”。
- 部署版本：实例的版本，本例中选择“新增版本”。
- 单击确定开始部署模型。

单击服务中的模型，可以获取服务详情，包括模型指标、服务地址和服务性能



调用

您可以使用命令行或在线调试工具调用模型服务，例如使用 postman 来测试服务调用。

输入参数：

- 服务地址：可从服务详情中获取
- 服务调用类型选择 post
- 选择 Body - form-data，参数 Key 格式选择 flie，名称设置为“file”，单击【选择文件】上传需要进行分类预测的照片
- 点击 【 send 】，发送调用请求，查看返回结果



返回结果解读：

服务会返回模型对图片的分类结果，结果按照评分返回 top n 的类别，Classes中的string_val对应Scores中的float_val，float_val的值代表置信度，值越高则表示该类别越有可能是该图片的正确分类。如图所示，此处调用结果，判断此花为 Rose （玫瑰花）的置信度最高。
