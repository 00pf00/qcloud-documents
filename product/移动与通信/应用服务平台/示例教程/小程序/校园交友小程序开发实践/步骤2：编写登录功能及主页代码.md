
## 操作步骤



### 进行小程序的配置，以及创建页面

1. app.json 中，配置两个页面的路径：
<dx-codeblock>
:::  json
"pages": [
    "pages/index/index",
    "pages/history/history"
  ]
:::
</dx-codeblock>
配置好后刷新开发者工具，就会在页面 pages 文件夹下生成 index，history 文件夹以及对应的 `.js`，`.wxml`， `.wxss` 和 `.json` 文件。
2. 设置tabbar的位置，在页面顶部以及设置里面的内容：
<dx-codeblock>
:::  json
"tabBar": {
    "color": "black",
    "selectedColor": "#D00000",
    "position": "top",
    "list": [{
      "pagePath": "pages/index/index",
      "text": "抽个对象"
    },
    {
      "pagePath": "pages/history/history",
      "text": "我的纸条"
    }
  ]
  },
:::
</dx-codeblock>
3. 在 app.js 里新增全局的数据，用来存放当前用户的 openId：
<dx-codeblock>
:::  js
this.globalData = {
      openId: ''
    }
:::
</dx-codeblock>


### 完成用户登录功能，实现对用户 openId 的记录

#### 通过 login_yun 云函数

1. 先配置环境
<dx-codeblock>
:::  js
cloud.init(
  {
    env: 'cloud1-1gn5uyhza8931345'
  }
)
:::
</dx-codeblock>
2. 在云函数入口函数里进行 openId 的操作
<dx-codeblock>
:::  js
   // 查询这个openid下有无数据
     let user_data = await db.collection("users_school").where({
       openId: openId
     }).get()
   // 没有此用户则将openId添加到数据库
     if(user_data.data.length === 0){
       try{
         let data_add =  await db.collection("users_school").add({
           data: {
             openId: openId
           }
         })
         return {
           data_add,
           openId,
           status: 202  // 新添加的数据
         }
       }
       catch(e){
         console.error(e)
       }
        // 有了则直接返回
     }else{
       return {
         user_data, 
         status: 200  // 已经有了用户
       }
     }
:::
</dx-codeblock>
3. 然后上传部署，即完成了云函数的编写。
   ![image-20220114124321682](%E4%B8%83%E5%A4%A9%E4%B8%80%E4%B8%AA%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F.assets/image-20220114124321682.png)
4. 登录功能的云函数的调用，是在index.js页面的加载时进行调用。在onload的生命周期中：
<dx-codeblock>
:::  js
 const that = this
		 if (wx.getUserProfile) {
			 that.setData({
				 canIUseGetUserProfile: false,
			 })
		 }

		 wx.cloud.callFunction({
			 name: 'login_yun'  //  调用云函数
		 }).then(res => {
			 console.log(res)
			 if(res.result.status === 200){
					// 存到全局的globalData里，便于后续使用 
				 app.globalData.openId = res.result.user_data.data[0].openId
			 }else{
				 app.globalData.openId = res.result.openId
			 }
		 })
:::
</dx-codeblock>
   以上就完成了登录功能的代码。

### 编写index前端页面

1. 顶部的轮播图，直接可以用小程序提供的**swiper**加上**swiper-item**标签来写。

   ```html
   <view class="swiper_view">
     <swiper autoplay="true" interval="3000" duration="500" circular="true" class="swiper">
       <swiper-item><image mode="widthFix" src="../../images/_2.jpg"></image></swiper-item>
       <swiper-item><image mode="widthFix" src="../../images/_1.png"></image></swiper-item>
     </swiper>
     <!-- scaleToFill -->
   </view>
   ```

2. 中间的盒子用基本的标签+图片+css样式来编写。点击放入与抽取都会跳出一个收集信息的框，使用bindtap来绑定点击的事件，并在Index.js里处理对应的事件。

   ```html
   <view class="body_bottom">
       <view class="body_bottom_put" bindtap="putBody">放入一张男生纸条</view>
       <view class="body_bottom_out" bindtap="outBody">抽取一张男生纸条</view>
   </view>
   ```

3. 黑遮罩层用一个view标签，结合css的样式来完成。点击遮罩层对应cancelHide来隐藏遮罩层。

   ```html
   <view class="hide" wx:if="{{putBodyMask || outBodyMask || putGirlMask || outGirlMask || xuzhiMask || xieyiMask}}" bindtap="cancelHide"></view>
   ```

   css占满整个屏幕，加上颜色与透明度即可。

   ```css
   /* 遮罩层 */
   .hide {
     width: 100vw;
     height: 100vh;
     background-color: black;
     opacity: 0.5;
     position: fixed;
     top: 0vw;
     left: 0vh;
   }
   ```

4. 男女生放入与抽取的弹出框, picker用来选择分类的不同的学校。

   ```html
   <picker bindchange="bindSchoolChangePut" value="{{indexBody4}}" range="{{arrayBody4}}" class="out_body_content_2_picker">
       <view>
       - {{arrayBody4[indexBody4]}} -
       </view>
   </picker>
   ```

5. 最后效果

![image-20220114165448415](%E4%B8%83%E5%A4%A9%E4%B8%80%E4%B8%AA%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F.assets/image-20220114165448415.png)



