
###第三天
进行index.js的逻辑处理。

##### 一、调用login_yun云函数

在onload的生命周期里，进行登录的操作，不需要用户确认（因为只获取用户的openId信息）。

```js
wx.cloud.callFunction({
      name: 'login_yun'
    }).then(res => {
      console.log(res)
      if(res.result.status === 200){
        app.globalData.openId = res.result.user_data.data[0].openId
      }else{
        app.globalData.openId = res.result.openId
      }
    })
```

##### 二、data存放所需要的数据

```js
data: {
    // 遮罩层标志
    putBodyMask: false,
    putGirlMask: false,
    xuzhiMask: true,
    // 抽出的遮罩层
    outBodyMask: false,
    outGirlMask: false,
    // 交友宣言
    textareaBody: '',
    textareaGirl: '',
    // qq微信号
    numberBody: '',
    numberGirl: '',
    // 上传图片预览的src
    srcListBody: [],
    srcListGirl: [],

    // 放入的学校
    arrayBody4: ["河南理工大学", "焦作大学", "焦作师范"],
    indexBody4: 0,
    // 纸条的生命
    arrayBody2: ["被抽中一次销毁", "被抽中两次销毁", "被抽中三次销毁"],
    indexBody2: 0,
    arrayBody3: ["河南理工大学", "焦作大学", "焦作师范"],
    indexBody3: 0,

    // 放入的学校
    arrayGirl4: ["河南理工大学", "焦作大学", "焦作师范"],
    indexGirl4: 0
    // 纸条的生命
    arrayGirl2: ["被抽中一次销毁", "被抽中两次销毁", "被抽中三次销毁"],
    indexGirl2: 0,
    arrayGirl3: ["河南理工大学", "焦作大学", "焦作师范"],
    indexGirl3: 0,
    // 添加图片的加号
    addMask: true
  },
```

##### 三、学校选择的逻辑

1.picker中bindchange="bindSchoolChangePut"，通过bindSchoolChangePut来触发学校改变的事件，选择对应的学校。

2.e.detail.value来获取在data中绑定的学校的列表索引。

```js
// 放入时，学校的选择
  bindSchoolChangePut: function(e){
    this.setData({
      indexBody4: parseInt(e.detail.value)
    })
  }
```

##### 四、限制交友宣言长度

在点击确认放入，触发对应的surePutBodyBtns事件，再进行判断。

```js
if(that.data.textareaBody.length < 20){
      return wx.showToast({
        title: '交友宣言太短',
        icon: 'error',
        duration: 2000
      })
    }
```

##### 五、上传微信号的正则匹配

微信官方定义的微信号规则：

1、可使用6-20个字母、数字、下划线和减号。

2、必须以字母开头（字母不区分大小写）。

3、不支持设置中文。

```js
if(!(/^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1})|(17[0-9]{1}))+\d{8})$/).test(that.data.numberBody) && !(/^[a-zA-Z]([-_a-zA-Z0-9]{6,20})$/).test(that.data.numberBody)){
      return wx.showToast({
        title: '微信号格式错误',
        icon: 'error',
        duration: 2000
      })
    }
```

##### 六、本地图片的选择

一次上传限制一张，并且进行图片大小的限制，cloudPath随机配置存储在云存储里的路径。

```js
// 选择本地图片
  chooseImgGirl: function(){
    const that = this
    wx.chooseImage({
      count: 5,
      sizeType: ['original', 'compressed'],
      sourceType: ['album', 'camera'],
      success (res) {
        // tempFilePath可以作为img标签的src属性显示图片
        if(res.tempFiles[0].size > 1200000){
          return wx.showToast({
            title: '图片过大',
            icon: 'error',
            duration: 2000
          })
        }
        
        const filePath = res.tempFilePaths[0]
        let timeStamp = Date.parse(new Date());
        const cloudPath = "image/" + timeStamp + filePath.match(/\.[^.]+?$/)[0]
        that.pageData.filePath = filePath
        that.pageData.cloudPath = cloudPath
        that.setData({
          srcListGirl: res.tempFilePaths
        })
      }
    })
```

##### 七、纸条生命值的选择

对应数据库life字段：

![image-20220114191702403](%E4%B8%83%E5%A4%A9%E4%B8%80%E4%B8%AA%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F.assets/image-20220114191702403.png)

##### 八、点击确认放入之后的逻辑

先上传图片，再上传location，weChatId等信息到body_girl_yun表，上传成功要跳转到history页面。

```js
// 上传图片的api，先上传图片到云存储
wx.cloud.uploadFile({
      cloudPath,
      filePath,
      success: function(res){
        wx.hideLoading()
        wx.showLoading({
          title: '信息上传中',
          mask: true
        })
        // 上传图片完成后上传数据
        db.collection("body_girl_yun").add({
          data: {
            location: that.data.indexGirl4,
            weChatId: that.data.numberGirl,
            picture: res.fileID,
            life: parseInt(that.data.indexGirl2) + 1,
            des: that.data.textareaGirl,
            sex: 2,
            openId: app.globalData.openId,
            time: new Date().getTime()
          }
        }).then(result => {
          wx.hideLoading()
          
          that.pageData = {
            filePath: '',
            cloudPath: ''
          }
          that.setData({
            putGirlMask: false,
            srcListGirl: [],
            textareaGirl: '',
            numberGirl: ''
          })
			// 上传完成后跳转到history页
          wx.switchTab({
            url: '/pages/history/history',
            success: res=>{
              wx.showToast({
                title: '放入纸条成功',
                icon: 'success'
              })
            },
            fail: err => {
              wx.showToast({
                title: err,
                icon: 'error'
              })
            }
          })
      }
    })
```






##总结

本项目通过使用云开发的云函数，云存储，数据库等功能，7天可快速搭建实现一款校园交友小程序。
