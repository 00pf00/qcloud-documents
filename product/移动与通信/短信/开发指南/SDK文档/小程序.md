
## 开发前准备
在开始开发云函数调用云短信之前，需要准备以下信息：
- **获取 SDK AppID 和 AppKey**
云短信应用 SDK **AppID**和 **AppKey** 可在 [短信控制台](https://console.cloud.tencent.com/sms) 的应用信息里获取，如您尚未添加应用，请到 [短信控制台](https://console.cloud.tencent.com/sms) 中添加应用。
- **申请签名**
一个完整的短信由短信**签名**和**短信正文内容**两部分组成，短信 **签名** 需申请和审核，**签名** 可在 [短信控制台](https://console.cloud.tencent.com/sms) 的相应服务模块【内容配置】中进行申请，详细申请操作请参考 [创建签名](https://cloud.tencent.com/document/product/382/18061#.E5.88.9B.E5.BB.BA.E7.AD.BE.E5.90.8D)。
- **申请模板**
短信或语音正文内容**模板**需申请和审核，**模板**可在 [短信控制台](https://console.cloud.tencent.com/sms) 的相应服务模块【内容配置】中进行申请，详细申请操作请参考 [创建正文模板](https://cloud.tencent.com/document/product/382/18061#.E5.88.9B.E5.BB.BA.E6.AD.A3.E6.96.87.E6.A8.A1.E6.9D.BF)。
例如，申请模板内容为：“您的验证码为{1},请在5分钟内填写，如非本人操作，请忽略。”

## 参考文档

各个接口及其参数的详情介绍请参考 [API 文档](https://cloud.tencent.com/document/product/382/5976)、[SDK 文档](https://qcloudsms.github.io/qcloudsms_js/)、[错误码](https://cloud.tencent.com/document/product/382/3771) 和 [微信小程序·云开发](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)。


## 使用指南
 
### 1. 安装微信开发者工具 IDE 
根据 [微信小程序云开发·起步](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html) 注册并获取小程序 AppID，同时安装微信开发者工具。
### 2.  新建小程序
1. 选择【小程序项目】>【小程序】，单击<img src="https://main.qcloudimg.com/raw/01320cd33e05a1477d5a9b58c0146efc.png"  style="margin:0;">。
2. 根据实际需求，填写以下参数：
 - 项目名称：请填写项目的名称。
 - 目录：请选择项目文件夹。
 - AppID：请输入注册时获取的正确 AppID。
 - 开发模式：请选择【小程序】
 - 后端服务：支持【不使用云服务】、【小程序.云开发】和【腾讯云】三种选择，本文以选择【小程序.云开发】为例。
 >?当使用【不使用云服务】或【腾讯云】时需自建后端 Server，由后端 Server 再调用云短信 API，相关 API 以及 SDK 请参考 [腾讯云短信 API](https://cloud.tencent.com/document/product/382) 以及 [腾讯云短信 SDK](https://cloud.tencent.com/document/product/382/5804)。
 
### 3. 新建云函数
1. 右键单击`cloudfunctions`文件夹，选择新建`Node.js云函数`。
2. 输入`sendsms`，按`Enter`确认。

### 4. 添加云函数依赖库
打开`/cloudfunctions/sendsms/package.json`文件，在`dependencies`中添加`qcloudsms_js`库，如下所示：

```json
	{
		  "name": "sendsms",
		  "version": "1.0.0",
		  "description": "",
		  "main": "index.js",
		  "scripts": {
		    "test": "echo \"Error: no test specified\" && exit 1"
		  },
		  "author": "",
		  "license": "ISC",
		  "dependencies": {
			    "wx-server-sdk": "latest",
			    "qcloudsms_js": "^0.1.1"
		  }
	}
```
 
 <span id="STEP5"></span>
### 5.编写云函数处理逻辑
在`/cloudfunctions/sendsms/index.js`文件中添加处理发送短信实现逻辑，本部分主要调用 qcloudsms_js 库相关接口。
   
```javascript

	// 云函数入口文件
	const cloud = require('wx-server-sdk')
	const qcloudsms = require("qcloudsms_js")
	const appid = 140000001 // 替换成您申请的云短信 AppID 以及 AppKey
	const appkey = "abcdefghijkl123445"
	const templateId = 1234 // 替换成您所申请模板 ID
	const smsSign = "腾讯云" // 替换成您所申请的签名
		
	cloud.init()

	// 云函数入口函数
	exports.main = async (event, context) => new Promise((resolve, reject) => {
	
	/*单发短信示例为完整示例，更多功能请直接替换以下代码*/
	  var ssender = qcloudsms.SmsSingleSender();
	  var params = ["5678"];
	  // 获取发送短信的手机号码
	  var mobile = event.mobile
	  // 获取手机号国家/地区码
	  var nationcode = event.nationcode
	  ssender.sendWithParam(nationcode, mobile, templateId, params, smsSign, "", "", (err, res,     resData) => {
	  /*设置请求回调处理, 这里只是演示，您需要自定义相应处理逻辑*/
	   if (err) {
	      console.log("err: ", err);
	      reject({ err })
	    } else {
	      resolve({ res, resData })
	    }
	  });
	  
	})
```
   
### 6 部署云函数
右键单击`/cloudfunctions/sendsms`文件夹，选择【上传并部署(云端安装依赖)】。

### 7 调用云函数
小程序提供 [callfunction](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-server-api/functions/callFunction.html) 进行云函数调用，您可以根据实际需求可以在任意JS逻辑处理函数中添加如下代码进行云函数调用。
例如，需要在页面小程序首页加载完成后发送短信，则可以在`miniprogram/index/index.js`的 onLoad 函数中添加如下代码。

```javascript
	if(!wx.cloud) {
	    wx.redirectTo({
	      url: '../chooseLib/chooseLib',
		 })
	    return
	}
	wx.cloud.callFunction({
		name: 'sendsms',
		data: {
			mobile: '19012345678',
			nationcode: '86'
		},
		success: res => {
				console.log('[云函数] [sendsms] 调用成功')
				console.log(res.resData)
		},
		fail: err => {
				console.error('[云函数] [sendsms] 调用失败', err)
		}
	})
```

最后编译您的小程序，进行预览，至此您的小程序已可进行短信下发。
>?
>- 如果程序中调用失败可以参考接口 [错误码](https://cloud.tencent.com/document/product/382/3771) 说明，更多常见问题可参阅 [FAQ](https://cloud.tencent.com/document/product/382/3771)。
>- 无论单发/群发短信还是指定模板 ID 单发/群发短信都需要**从控制台中申请模板并且模板已经审核通过**，才可能下发成功，否则返回失败。
>- 为保证测试正常，建议申请模板内容为:“您的验证码为{1},请在5分钟内填写，如非本人操作，请忽略。”


## 接口示例

在 [编写云函数处理逻辑](#STEP5) 时调用的是 qcloudsms_js 库的 SmsSingleSender() 来进行短信发送。除此之外qcloudsms_js 提供了更多丰富的功能，例如指定内容单发短信、指定模板群发、语音通知、语音验证码以及短信回执状态拉取等功能，只需将云函数处理逻辑对应代码替换成以下示例代码即可。

- **参数说明**
下面对几个功能接口用到参数进行说明，客户替换成自己响应的配置即可。
```
/** 
 * sdkappid, appkey, templateId, smsSign 请根据 `开发前准备` 指引申请。  
 */
// 短信应用 SDKAppID
var appid = 1400009099;
// 短信应用 Appkey
var appkey = "9ff91d87c2cd7cd0ea762f141975d1df37481d48700d70ac37470aefc60f9bad";
// 需要发送短信的手机号码
var phoneNumbers = ["21212313123", "12345678902", "12345678903"];
// 短信模板 ID,请在短信控制台申请模板，使用真实的已申请的模板 ID，建议申请模板内容为：“您的验证码为{1},请在5分钟内填写，如非本人操作，请忽略。”
var templateId = 7839;
// 短信签名内容，请在短信控制台申请签名，使用真实的已申请的签名, 签名参数使用的是`签名内容`，而不是`签名ID`
var smsSign = "腾讯云";
```

- **指定模板ID单发短信**

```javascript
  //单发短信
  var ssender = qcloudsms.SmsSingleSender();
  var params = ["5678"];
  ssender.sendWithParam(86, phoneNumbers[0], templateId, params, smsSign, "", "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
    if (err) {
      console.log("err: ", err);
      reject({ err })
    } else {
      resolve({ res, resData })
    }
  });
```

- **单发短信**

```javascript
// Enum{0：普通短信, 1：营销短信}
var smsType = 0;
var ssender = qcloudsms.SmsSingleSender();
ssender.send(smsType, 86, phoneNumbers[0], `${smsSign}您的验证码为{1},请在5分钟内填写，如非本人操作，请忽略。`, "", "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

- **指定模板ID群发**

```javascript
var msender = qcloudsms.SmsMultiSender();
var params = ["5678"];
msender.sendWithParam("86", phoneNumbers, templateId, params, smsSign, "", "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

>?一次群发请求最多支持200个号码。

- **群发**

```javascript
// Enum{0: 普通短信, 1: 营销短信}
var smsType = 0; 
var msender = qcloudsms.SmsMultiSender();
msender.send(smsType, "86", phoneNumbers, `${smsSign}您的验证码为{1},请在5分钟内填写，如非本人操作，请忽略。`, "", "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

>?一次群发请求最多支持200个号码。

- **发送语音验证码**

```javascript
var cvsender = qcloudsms.CodeVoiceSender();
cvsender.send("86", phoneNumbers[0], "1234", 2, "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

>?
>- 个人认证不支持语音短信。
> - 语音验证码发送只需提供验证码数字，如需自定义内容，可以使用语音通知。
 例如，当 msg=“5678” 时，您收到的语音通知为“您的语音验证码是五六七八。”。


-   **发送语音通知**

```javascript
var pvsender = qcloudsms.PromptVoiceSender();
// 请在短信控制台->语音短信->语音内容配置页面创建正文模板，模板内容为：“您的语音验证码是{1}”
pvsender.send("86", phoneNumbers[0], 2, "您的语音验证码是5678", 2, "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

>?个人认证不支持语音通知。

- **拉取短信回执以及回复**

```javascript
var maxNum = 10;  // 单次拉取最大量
var spuller = qcloudsms.SmsStatusPuller();
// 拉取短信回执
spuller.pullCallback(maxNum, (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
// 拉取回复
spuller.pullReply(maxNum, (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

>?短信拉取功能需要联系腾讯云短信技术支持（QQ：3012203387），量大客户可以使用此功能批量拉取，其他客户不建议使用。

- **拉取单个手机短信状态**

```javascript
var beginTime = 1511125600;  // 开始时间（UNIX timestamp）
var endTime = 1511841600;    // 结束时间（UNIX timestamp）
var maxNum = 10;             // 单次拉取最大量
var mspuller = qcloudsms.SmsMobileStatusPuller();
// 拉取短信回执
mspuller.pullCallback("86", phoneNumbers[0], beginTime, endTime, maxNum, (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
// 拉取回复
mspuller.pullReply("86", phoneNumbers[0], beginTime, endTime, maxNum, (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

- **发送海外短信**

海外短信与国内短信发送类似，发送海外短信只需替换相应国家码。本文以**指定模板 ID 单发短信**为例。

```javascript
var smsType = 0;
var ssender = qcloudsms.SmsSingleSender();
ssender.sendWithParam(1, phoneNumbers[0], templateId, params, smsSign, "", "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```

- **指定模板发送语音通知**

```javascript
// 请在短信控制台 > 语音短信】>【语音内容配置】页面创建正文模板，例如模板内容为：“您的语音验证码是{1}”
var voiceTemplateId = 12345;
var params = ["5678"];
var tvsender = qcloudsms.TtsVoiceSender();
tvsender.send("86", phoneNumbers[0], voiceTemplateId, params, 2, "", (err, res, resData) => {
  // 设置请求回调处理, 此处仅为示例，请根据实际需求自定义处理回调
  if (err) {
    console.log("err: ", err);
    reject({ err })
  } else {
    resolve({ res, resData })
  }
});
```