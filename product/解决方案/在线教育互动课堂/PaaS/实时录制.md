
# 互动课堂云端实时录制服务接入文档

## 1. 功能简介

腾讯云互动课堂云端实时录制服务为您提供在上课过程中，同步将的各路音视频以及白板画面分别录制为视频的能力，方便您记录每堂课的完整过程，满足课堂质量分析，学生复习回顾等业务场景。

## 2. 如何使用实时录制

![](https://test-1257240443.cos.ap-shanghai.myqcloud.com/picgo/实时录制流程图.png)

### 2.1 功能开通

若您能还没开通云端实时录制服务，请按照[服务开通指南](../开通服务/服务开通指南.md)发送邮件申请开通，并在申请功能里保留`云端实时录制`。

### 2.2 准备UserId与UserSig

实时录制后台需要加入课堂并对课堂的音视频与白板进行录制，因此需要您提供一个录制后台进房的`UserId`以及`UserSig`，生成`UserId`与`UserSig`的请参考 [如何计算UserSig](https://cloud.tencent.com/document/product/647/17275)

为了将录制后台的`UserId`与普通用户进行区分，我们约定`UserId`的必须如下：
```
tic_record_user_{roomid}_{随机数}
```
其中，`{roomid}`为您真实的房间号，假如课堂的音视频房间`100241`，一个合法的实时录制`UserId`为`tic_record_user_100241_100`，同时您需要提供`tic_record_user_100241_100`对应的`UserSig`签名

> 注意：
>
> 1. `UserSig`签名请设置一个较长的有效期，例如1小时，避免由于签名过期导致录制失败。
> 2. 如果同一房间内需要多次发起录制，请使用不同的录制`UserId`，否则会出现录制服务被踢出房间而导致录制失败。

### 2.3 开始录制

在需要进行录制时，例如老师学生都已经准备好开始上课，您可以使用`4.1 开始录制`接口开始实时录制，在请求接口时，需要上一步准备好的用于录制后台加入课堂的`UserId`与`UserSig`，当实时录制开始时，如果您配置了回调地址，您将收到事件为`开始录制`的回调请求通知。


> 由于网络延迟等因素，发起开始录制请求后，实时录制实际将在`2s`左右后开始

### 2.4 停止录制

在课堂结束或者需要停止录制的时候，您可以使用`4.2 停止录制`接口通知实时录制服务停止当前录制，
您可以使用`4.3 查询录制结果`接口主动查询实时录制结果，如果您配置了回调地址，录制视频处理完成后，您将收到事件为`录制完成`的回调请求通知。

>  1. 由于网络延迟等因素，发送停止录制请求后，实际上实时录制将在`2s`左右后停止

### 2.5 解析录制结果

当您主动查询录制进度时收到 `progress` 参数值为100，或者收到录制完成回调时，您可以拿到录制结果（一个JSON串），其格式如下：

| 参数名          | 类型         | 描述                         |
|:---------------|:------------|:----------------------------|
| sdkappid       | int         | sdkappid                    |
| room_id        | int         | 房间号                       |
| group_id       | string      | 白板的群组ID                  |
| record_user_id | string      | 录制所使用的UserId            |
| start_time     | int         | 录制开始时间，Unix时间戳，单位秒 |
| stop_time      | int         | 录制停止时间，Unix时间戳，单位秒 |
| video_info     | []VideoInfo | 录制视频列表                  |

VideoInfo对象格式

| 参数名           | 类型    | 描述                                      |
|:----------------|:-------|:-----------------------------------------|
| video_play_time | int    | 视频播放时间  (单位毫秒)                     |
| video_size      | int    | 视频大小(字节)                              |
| video_format    | string | 视频格式                                   |
| video_duration  | int    | 视频播放时长(单位毫秒)                       |
| video_url       | string | 视频录制文件url                             |
| video_id        | string | 点播后台返回的视频fileId                     |
| video_type      | int    | 视频流类型 0:摄像头视频 1:屏幕分享视频 2:白板视频 |
| user_id         | string | 视频所属用户的id，白板视频时，user_id为空       |

以下为一个录制结果JSON串示例：

```json
{
    "sdkappid":1400042982,
    "room_id":1234,
    "group_id":"1234",
    "record_user_id": "tic_record_user_1234_test1",
    "start_time":1558613140,
    "stop_time":1560053140,
    "video_info":[
        {
            "video_play_time":0,
            "video_size":13151,
            "video_format":"flv",
            "video_duration":1200000,
            "video_url":"http://1253488539.vod2.myqcloud.com/oM86K7X3Ig8b.mp4",
            "video_id":"5285890781570653827",
            "video_type":0,
            "user_id":"ios_test1"
        },
        {
            "video_play_time":300000,
            "video_size":3756,
            "video_format":"flv",
            "video_duration":810000,
            "video_url":"http://1253488539.vod2.myqcloud.com/oM86K7X3IsdfA.mp4",
            "video_id":"5285890781570653828",
            "video_type":0,
            "user_id":"pc_test1"
        },
        {
            "video_play_time":120000,
            "video_size":1241,
            "video_format":"flv",
            "video_duration":1320000,
            "video_url":"http://1253488539.vod2.myqcloud.com/52lk3KA0A562.mp4",
            "video_id":"5285890781570653830",
            "video_type":2,
            "user_id":""
        }
    ]
}
```
该JSON串表示课堂录制产生了3个视频文件，这3个视频文件在时间轴上的排列如下图所示：

![](https://main.qcloudimg.com/raw/3f19a0fe4c2c0c38c5be364e326e3e7d.png)


## 3. 接口鉴权

所有请求调用都需要带上签名以便服务器鉴权，签名算法如下：

```
sign = md5(TicKey+expire_time)
```

| 参数名      | 描述                             |
|:------------|:---------------------------------|
| TicKey      | 2.1中获取的密钥 TicKey           |
| expire_time | Unix时间戳，单位秒，签名过期时间 |

> 签名举例：
> 1. 当前时间戳是 `1548247717`
> 2. 签名有效时间是 `120` 秒，则过期时间戳是 `expire_time =
>    1548247717+120=1548247837`
> 3. `tic_key = 9016607A382749C69D4F4B00C61DD083`
> 4. 计算签名：`sign =
>    md5(9016607A382749C69D4F4B00C61DD0831548247837)=5400bac77ba6467a8f8ac056f1769f45`
> 5. 在使用的接口的JSON请求参数中，带上`expire_time`字段，值为`1548247837`

GoLang代码示例：

```go

func CalculateSign(ticKey string, expireTime int) string {
    // 获取签名过期时间为当前时间加上签名有效期
    // TicKey为邮件中的回复的32位TicKey，expireTime是当前签名过期时间的Unix时间戳（单位秒）
    
    // 拼接TicKey与过期时间
    hashString := fmt.Sprintf("%v%v", ticKey, expireTime)
    // 计算拼接后字符串的MD5获得签名
    return GetMD5Hash([]byte(hashString))
}

func GetMD5Hash(data []byte) string {
    checksum := md5.Sum(data)
    return fmt.Sprintf("%x", checksum)
}
```

> 注意
>
> 测试体验用户没有提供TicKey，而是直接提供了指定过期时间的签名字符串，请直接使用邮件中的`过期时间`填充请求包体中的`expire_time`，使用`签名`替换请求URL中的`sign`

### 4.1 开始录制

##### 接口说明

| 请求基本信息 | 描述                                                 |
|:-------------|:-----------------------------------------------------|
| 方法         | POST                                                 |
| 请求URL      | https://iclass.api.qcloud.com/record/v1/online/start |
| 请求Header   | Content-Type:application/json                        |


##### 请求参数

URL参数

| 参数名   | 描述                                                                    |
|:---------|:------------------------------------------------------------------------|
| sdkappid | 客户的sdkappid                                                          |
| sign     | 用于鉴权的签名                                                          |
| random   | 随机int32正整数，每次请求都需要带上，定位问题时需要提供该次请求的random |

Body参数（json格式）

| 参数名       | 类型           | 描述                                                                                                                                                                 | 是否必填 |
|:------------|:--------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|
| expire_time | int           | 签名的过期时间                                                                                                                                                         | 是      |
| room_id     | int           | 需要录制的房间ID                                                                                                                                                       | 是      |
| group_id    | string        | 白板的IM群组ID，默认同房间号                                                                                                                                             | 否      |
| user_id     | string        | 用于录制的user_id，必须包含前缀"tic_record_user_${roomid}"，其中${roomid}为房间号，实时录制服务会使用这个user_id进房进行录制房间内的音视频与白板，为了防止进房冲突，请保证此user_id不重复 | 是      |
| user_sig    | string        | 用于录制的user_id对应的签名                                                                                                                                             | 是      |
| whiteboard  | Whiteboard参数 | 实时录制白板参数，例如白板宽高等                                                                                                                                          | 否      |

Whiteboard参数

| 参数名  | 类型 | 描述                    | 是否必填 |
|:-------|:----|:------------------------|:-------|
| width  | int | 实时录制白板宽，默认为1280 | 否      |
| height | int | 实时录制白板高，默认为960  | 否      |


请求示例：
> 请将random/sdkappid/sign/expire_time/user_id/user_sig/whiteboard字段替换为实际的值

```
请求URL：https://iclass.api.qcloud.com/record/v1/online/start?random=526919&sdkappid=1400127115&sign=d33bfea49d7f2795a4829c0d80047a7d
请求Header："Content-Type:application/json"
请求包体：
{
    "expire_time":1557202745,
    "room_id": 1234,
    "user_id": "tic_record_user_1234_01",
    "user_sig": "valid usersig",
    "whiteboard": {
        "width": 1280,
        "height": 960
    } 
}
```

##### 接口返回参数

返回参数（json格式）

| 参数名      | 类型    | 描述                                          |
|:-----------|:-------|:---------------------------------------------|
| error_code | int    | 错误码                                        |
| error_msg  | string | 错误信息                                       |
| task_id    | string | 实时录制任务ID，停止录制以及查询录制信息都会依赖任务ID  |


返回示例：

```json
{
    "error_code": 0,
    "error_msg": "ok",
    "task_id": "g68cee8e90jcq4ogg8jb"
}
```

### 4.2 停止录制

| 请求基本信息 | 描述                                                |
|:-------------|:----------------------------------------------------|
| 方法         | POST                                                |
| 请求URL      | https://iclass.api.qcloud.com/record/v1/online/stop |
| 请求Header   | Content-Type:application/json                       |

##### 请求参数

URL参数

| 参数名    | 描述                                                        |
|:---------|:-----------------------------------------------------------|
| sdkappid | 客户的sdkappid                                              |
| sign     | 用于鉴权的签名                                                |
| random   | 随机int32正整数，每次请求都需要带上，定位问题时需要提供该次请求的random |

Body参数（json格式）

| 参数名       | 类型    | 描述                |
|:------------|:-------|:-------------------|
| expire_time | int    | 签名的过期时间        |
| task_id     | string | 需要停止录制的任务ID   |

请求示例：
> 请将random/sdkappid/sign/expire_time/task_id字段替换为实际的值

```
请求URL：https://iclass.api.qcloud.com/record/v1/online/stop?random=526919&sdkappid=1400127115&sign=d33bfea49d7f2795a4829c0d80047a7d
请求Header："Content-Type:application/json"
请求包体：
{
    "expire_time":1557202745,
    "task_id": "g68cee8e90jcq4ogg8jb"
}
```

##### 接口返回参数

返回参数（json格式）

| 参数名     | 类型   | 描述     |
|:-----------|:-------|:---------|
| error_code | int    | 错误码   |
| error_msg  | string | 错误信息 |


返回示例：

```json
{
    "error_code": 0,
    "error_msg": "ok"
}
```

### 4.3 查询实时录制任务结果

查询一个实时录制任务的录制结果

##### 接口说明


| 请求基本信息 | 描述                                                  |
|:----------|:-----------------------------------------------------|
| 方法       | POST                                                 |
| 请求URL    | https://iclass.api.qcloud.com/record/v1/online/query |
| 请求Header | Content-Type:application/json                        |

##### 请求参数

URL参数

| 参数名   | 描述                                                                    |
|:---------|:------------------------------------------------------------------------|
| sdkappid | 客户的sdkappid                                                          |
| sign     | 用于鉴权的签名                                                          |
| random   | 随机int32正整数，每次请求都需要带上，定位问题时需要提供该次请求的random |

Body参数（json格式）

| 参数名       | 类型    | 描述         |
|:------------|:-------|:------------|
| expire_time | int    | 签名的过期时间 |
| task_id     | string | 实时录制任务ID |

请求示例：
> 请将random/sdkappid/sign/expire_time/task_id字段替换为实际的值

```
请求URL：https://iclass.api.qcloud.com/record/v1/online/query?random=526919&sdkappid=1400127115&sign=d33bfea49d7f2795a4829c0d80047a7d
请求Header："Content-Type:application/json"
请求包体：
{
    "expire_time":1557202745,
    "task_id": "g68cee8e90jcq4ogg8jb"
}
```

##### 接口返回参数

返回参数（json格式）

| 参数名          | 类型         | 描述                                                                                                       |
|:---------------|:------------|:----------------------------------------------------------------------------------------------------------|
| error_code     | int         | 错误码                                                                                                     |
| error_msg      | string      | 错误信息                                                                                                   |
| task_id        | string      | 需要查询结果的录制任务ID                                                                                      |
| status         | string      | 录制任务状态，"prepared"表示录制正在准备中（进房/启动录制服务等操作），"recording"表示录制已开始，"finished"表示录制完成 |
| start_time     | int         | 实际开始录制时间，Unix时间戳，单位秒                                                                           |
| stop_time      | int         | 实际停止录制时间，Unix时间戳，单位秒                                                                           |
| record_user_id | string      | 用于录制的用户ID                                                                                            |
| room_id        | int         | 房间号                                                                                                     |
| group_id       | string      | 白板的群组ID                                                                                                |
| video_info     | []VideoInfo | 录制视频列表                                                                                                |

VideoInfo对象格式

| 参数名           | 类型    | 描述                                      |
|:----------------|:-------|:-----------------------------------------|
| video_play_time | int    | 视频播放时间                                |
| video_size      | int    | 文件大小(字节)                              |
| video_format    | string | 文件格式(目前应该全部是mp4)                   |
| video_duration  | int    | 文件播放时长(单位s)                          |
| video_url       | string | 录制文件url                                |
| video_id        | string | 点播后台返回的fileId字段                     |
| video_type      | int    | 视频流类型 0:摄像头视频 1:屏幕分享视频 2:白板视频 |
| user_id         | string | 视频所属用户的id，白板视频时，user_id为空       |

返回示例：

```json
{
    "error_code": 0,
    "error_msg": "",
    "task_id": "g68cee8e90jcq4ogg8jb",
    "status": "finished",
    "room_id": 1000135,
    "group_id": "1000135",
    "record_user_id": "tic_record_user_1000135_01",
    "start_time": 1557891712,
    "stop_time": 1557891712,
    "video_info": [
        {
            "user_id": "jepson",
            "video_duration": 22504,
            "video_format": "mp4",
            "video_id": "52858907621654352000418",
            "video_play_time": 25915,
            "video_size": 1431138,
            "video_type": 0,
            "video_url": "http://1257307760.vod2.myqcloud.com/f0.mp4"
        },
        {
            "user_id": "",
            "video_duration": 48832,
            "video_format": "mp4",
            "video_id": "52858907621654356352413",
            "video_play_time": 0,
            "video_size": 2948089,
            "video_type": 2,
            "video_url": "http://1257307760.vod2.myqcloud.com/f1.mp4"
        }
    ]
}
```


### 4.4 设置录制服务回调地址

##### 接口说明

- 调用设置回调接口时，会往回调地址发送测试请求，**回调URL地址需要回复`{"error_code":0}`才能设置成功**


| 请求基本信息 | 描述                                                    |
|:-------------|:--------------------------------------------------------|
| 方法         | POST                                                    |
| 请求URL      | https://iclass.api.qcloud.com/record/v1/online/callback |
| 请求Header   | Content-Type:application/json                           |

##### 请求参数

URL参数

| 参数名   | 描述                                                                    |
|:---------|:------------------------------------------------------------------------|
| sdkappid | 客户的sdkappid                                                          |
| sign     | 用于鉴权的签名                                                          |
| random   | 随机int32正整数，每次请求都需要带上，定位问题时需要提供该次请求的random |

Body参数（json格式）

| 参数名      | 类型   | 描述                                                       |
|:------------|:-------|:-----------------------------------------------------------|
| expire_time | int    | 签名的过期时间                                             |
| callback    | string | 录制完成后回调地址，如果传空字符串会删除原来的回调地址配置 |

请求示例：
> 请将random/sdkappid/sign/expire_time/callback字段替换为实际的值

```
请求URL：https://iclass.api.qcloud.com/ppt2h5/v1/callback?random=526919&sdkappid=1400127115&sign=d33bfea49d7f2795a4829c0d80047a7d
请求Header："Content-Type:application/json"
请求包体：
{
    "expire_time":1557202745,
    "callback": "https://iclass.api.qcloud.com/task/callback"
}
```

##### 接口返回参数

返回参数（json格式）

| 参数名     | 类型   | 描述     |
|:-----------|:-------|:---------|
| error_code | int    | 错误码   |
| error_msg  | string | 错误信息 |


返回示例：

```json
{
    "error_code": 0,
    "error_msg": "ok"
}
```

### 4.5 实时录制结果回调格式

##### 接口说明

如果您的业务服务器设置了回调地址，当实时录制服务在完成录制准备开始录制以及完成录制后会往回调地址发送请求

- 业务服务器需对签名做校验，判断是否为有效请求
- 业务服务器必须回包`{"error_code":0}`，否则，实时录制服务认为回调发送失败后进行重试，每分钟重试1次，最大重试10次


| 请求基本信息 | 描述                          |
|:-------------|:------------------------------|
| 方法         | POST                          |
| 请求Header   | Content-Type:application/json |

URL参数

| 参数名    | 描述                                                        |
|:---------|:-----------------------------------------------------------|
| sign     | 用于鉴权的签名，需对该签名做校验，判断是否为有效请求                   |
| random   | 随机int32正整数，每次请求都需要带上，定位问题时需要提供该次请求的random |
| sdkappid | 业务服务器对应的sdkappid                                       |



#### 4.5.1 开始录制回调

实时录制服务准备完成后，会发送"录制已开始"的回调信息

Body参数（json格式）

| 参数名          | 类型    | 描述                                       |
|:---------------|:-------|:------------------------------------------|
| expire_time    | int    | 签名的过期时间                              |
| error_code     | int    | 错误码                                     |
| error_msg      | string | 错误信息                                   |
| timestamp      | int    | 请求发送的Unix时间戳，单位秒                  |
| task_id        | string | 需要查询结果的录制任务ID                      |
| callback_type  | string | 回调类型，开始录制的类型固定为"record_started" |
| record_user_id | string | 用于录制的用户ID                            |
| room_id        | int    | 房间号                                     |
| group_id       | string | 白板的群组ID                                |

回调示例：
```
回调URL：https://业务后台URL?random=526919&sign=d33bfea49d7f2795a4829c0d80047a7d&sdkappid=1400042982
回调Body：
{
    "error_code":0,
    "error_msg":"",
    "expire_time":1529908745,
    "timestamp": 1529908745,
    "task_id": "g68cee8e90jcq4ogg8jb",
    "callback_type": "record_started",
    "record_user_id":"tic_record_user_1234_01",
    "room_id":1234,
    "group_id":"1234",
}
```
##### 回调地址返回参数

返回示例：

```json
{"error_code": 0}
```

#### 4.5.2 录制结束回调

实时录制服务完成录制并处理视频上传后，会发送"录制已完成"的回调信息

##### 回调请求参数

Body参数（json格式）

| 参数名          | 类型         | 描述                                        |
|:---------------|:------------|:-------------------------------------------|
| expire_time    | int         | 签名的过期时间                               |
| error_code     | int         | 错误码                                      |
| error_msg      | string      | 错误信息                                    |
| timestamp      | int         | 请求发送的Unix时间戳，单位秒                   |
| task_id        | string      | 需要查询结果的录制任务ID                       |
| callback_type  | string      | 回调类型，录制结束的类型固定为"record_finished" |
| start_time     | int         | 实际开始录制时间，Unix时间戳，单位秒            |
| stop_time      | int         | 实际停止录制时间，Unix时间戳，单位秒            |
| record_user_id | string      | 用于录制的用户ID                             |
| room_id        | int         | 房间号                                      |
| group_id       | string      | 白板的群组ID                                 |
| video_info     | []VideoInfo | 实时录制信息                                 |

VideoInfo对象格式

| 参数名           | 类型    | 描述                                      |
|:----------------|:-------|:-----------------------------------------|
| video_play_time | int    | 视频播放时间                                |
| video_size      | int    | 文件大小(字节)                              |
| video_format    | string | 文件格式(目前应该全部是mp4)                   |
| video_duration  | int    | 文件播放时长(单位s)                          |
| video_url       | string | 录制文件url                                |
| video_id        | string | 点播后台返回的fileId字段                     |
| video_type      | int    | 视频流类型 0:摄像头视频 1:屏幕分享视频 2:白板视频 |
| user_id         | string | 视频所属用户的id，白板视频时，user_id为空       |


回调示例：

```
回调URL：https://业务后台URL?random=526919&sign=d33bfea49d7f2795a4829c0d80047a7d&sdkappid=1400042982
回调Body：
{
    "error_code":0,
    "error_msg":"",
    "expire_time":1529908745,
    "timestamp": 1529908745,
    "task_id": "g68cee8e90jcq4ogg8jb",
    "callback_type": "record_finished",
    "record_user_id":"tic_record_user_1234_01",
    "start_time": 1529908745,
    "stop_time": 1529908745,
    "room_id":1234,
    "group_id":"1234",
    "video_info":[
        {
            "video_play_time":0
            "video_size":1200,
            "video_format":"mp4",
            "video_duration":3600
            "video_url":"http://1253488539.vod2.myqcloud.com/oM86K7X3Ig8b.mp4",
            "video_id":"5285890781570653827",
            "video_type":0,
            "user_id":"ios_test1"
        },
        {
            "video_play_time":4000
            "video_size":3756,
            "video_format":"mp4",
            "video_duration":5000
            "video_url":"http://1253488539.vod2.myqcloud.com/oM86K7X3IsdfA.mp4",
            "video_id":"5285890781570653828",
            "video_type":2,
            "user_id":"pc_test1"
        }
    ]
}
```


##### 回调地址返回参数

返回示例：

```json
{"error_code": 0}
```


## 5. 后台错误码

#### 实时录制错误码


#### 请求错误码

| 错误码 | 错误描述                     | 解决方法                                                       |
|:------|:---------------------------|:--------------------------------------------------------------|
| 20000 | 客户未开通服务                | 请参考`2.1 服务开通`中流程发送邮件申请开通                            |
| 20001 | 签名已过期                   | 检查请求JSON中的expire_time签名时间，更新过期时间后重新生成签名字符串     |
| 20002 | 签名校验失败                  | 检查TicKey与签名算法是否正确                                      |
| 20003 | 参数解析失败                  | 根据error_msg查询具体的请求参数异常信息，更正参数缺失/类型错误等          |
| 20004 | 设置回调地址请求失败           | 检查回调地址所在服务器是否网络可达，接收回调后是否返回`{"error_code": 0}` |
| 20005 | 数据读取失败                  | 请检查请求中的TaskId或联系客服人员                                  |
| 20011 | 发送停止任务请求时录制任务已经结束 | 可能由于长时间房间内没有用户音视频上行，实时录制服务自动停止录制            |
| 20099 | 内部错误                     | 请联系客服人员                                                   |
