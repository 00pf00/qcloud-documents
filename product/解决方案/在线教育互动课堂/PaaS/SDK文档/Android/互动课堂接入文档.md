

# TIC 2.0 接入文档-Android

## 1. 文件说明

### 1.1 TIC源码

| 文件名称 | 说明 | 
|------|-----|
| TICManager.java | TIC管理类 | 
| TICManagerImpl.java | TIC管理实现类 | 
| TICVideoRootView.java | TIC渲染视图 | 

### 1.2 依赖SDK

| 文件名称 | 说明 | 位置 |
|-----|-----|-----|
| TEduBoardSdk | 白板SDK库 | jcenter |
| com.tencent.imsdk | 云通信SDK库 | jcenter |
| com.tencent.liteav:LiteAVSDK_TRTC | 音视频SDK静态库 | jcenter |

TIC是一个相对简单的层，主要负责了白板 Board SDK、云通信Tim SDK、云视频Trtc SDK的初始化和基本功能封装，包含登录/登出、创建/销毁、加入课堂和退出课堂、收发消息。

## 2. 快速集成

### 2.1 项目配置
1、引入依赖库，build.gradle中库引用如下：
```java
// board 白板库
compile ('com.tencent.teduboard:TEduBoardSdk:2.1.0')

//Trtc 音视频库，如果使用腾讯的云视频Trtc，则需要加上
compile 'com.tencent.liteav:LiteAVSDK_TRTC:6.5.7272'

//imsdk 消息通信库，如果使用腾讯的云通信Tim，则需要加上
compile 'com.tencent.imsdk:mobilepbforimsdk:1.6.0.45'
compile 'com.tencent.imsdk:imsdk:4.3.145'
```
2、在 `Android Studio` 开发环境下，可把TIC sdk源代码直接制到工程中。


### 2.2 基本流程接口
#### 2.2.1 初始化
 1. TIC初始化主要是针对`Board SDK`、`Im SDK`和`Trtc SDK`的初始化，建议您在应用启动的时候调用。
```java
//在Application中的onCreate函数中进行TIC初始化，在onTerminate中进行反初始化TIC；
@Override  
public void onCreate() {  
    super.onCreate();  
    // 初始化TIC  
    mTicManager = TICManager.getInstance();  
    mTicManager.init(this, Constants.APPID);  
}
  
@Override  
public void onTerminate() {  
    if (mTicManager != null)  
        mTicManager.unInit();  
    super.onTerminate();  
}
```

 2. 用户被挤下线或账号过期会收到相应回调，建议您在登录之前设置`TICStatusListener`监听，及时获取回调信息进行处理。

```java
//1、使用过程中，可以获取TIC的引用并注册状态监听；
mTicManager = ((TICSDKDemoApp)getApplication()).getTICManager();  
mTicManager.addIMStatusListener(this);

//2、监听的回调函数
@Override  
public void onTICForceOffline() {  
    Log.i(TAG, "您已被踢下线，请检查后重新登录");  
}  
  
@Override  
public void onTICUserSigExpired() {  
    Log.i(TAG,  "用户签名已过期！");  
}
```


#### 2.2.2 登录/登出
 初始化完成后，您可以登录(类似QQ的用户登录)，如果此用已经在其他设备上处于登录状态，先登录的设备会被挤下线收到`onTICForceOffline`回调。在您使用结束后，可以调用登出接口，退出登录状态。
```java
//1、登录进入
mTicManager.login(mUserID, mUserSig, new TICManager.TICCallback() {  
    @Override  
    public void onSuccess(Object data) {  
    Log.i(TAG, mUserID + ":登录成功");  
    }  
  
    @Override  
    public void onError(String module, int errCode, String errMsg) {  
        Log.i(TAG, mUserID+ ":登录失败, err:" + errCode + "  msg: " + errMsg);  
    }
});

//2、登出
mTicManager.logout(new TICManager.TICCallback() {  
    @Override  
    public void onSuccess(Object data) {  
        Log.i(TAG, mUserID + ":登出成功" );  
    }  
  
    @Override  
    public void onError(String module, int errCode, String errMsg) {  
        Log.i(TAG, "登出失败, err:" + errCode + " msg: " + errMsg);  
    }  
});
```
其中 `userId`、`userSig`（[如何获取UserSig？](https://cloud.tencent.com/document/product/647/17275)），可以获取填写参数的方法。


#### 2.2.3 创建/销毁课堂
登录成功后您可以创建课堂，如果课堂已存在，可直接加入课堂。
```java
mTicManager.createClassroom(mRoomId, new TICManager.TICCallback() {  
    @Override  
    public void onSuccess(Object data) {  
        Log.i(TAG, "创建课堂成功, 房间号：" + mRoomId);  
    }
  
    @Override  
    public void onError(String module, int errCode, String errMsg) {  
        if (errCode == 10021) {  
            Log.i(TAG,"该课堂已被他人创建，请\"加入课堂\"");  
        }  
        else if (errCode == 10025) {  
            Log.i(TAG,"该课堂已创建，请\"加入课堂\"");  
        }  
        else {  
            Log.i(TAG,"创建课堂失败, 房间号：" + mRoomId + " err:" + errCode + " msg:" + errMsg);  
        }  
    }
});
```
其中 `mRoomId`为课堂群号(类似QQ的群号)，如果课堂不再使用后可销毁课堂。如果课堂销毁后，课堂内的成员将会收到`TICEventListener`中的`onTICClassroomDestroy`回调。

```java
mTicManager.destroyClassroom(mRoomId, new TICManager.TICCallback() {  
    @Override  
    public void onSuccess(Object o) {  
        Log.i(TAG,"销毁课堂成功: " + mRoomId);  
    }  
    @Override  
    public void onError(String s, int errCode, String errMsg) {  
        Log.i(TAG,"销毁课堂失败: " + mRoomId + " err:" + errCode + " msg:" + errMsg);  
    }  
});
```

#### 2.2.4 加入/退出课堂
您可以通过接口`addMessageListener`设置消息监听，在加入课堂后可获取到课堂内的消息。`addEventListener`设置事件监听及时感知事件，在课堂的加入成员会收到`onTICMemberJoin`回调。
```java
//1、增加消息监听
mTicManager.addIMMessageListener(this);

//2、进房参数
TICClassroomOption classroomOption = new TICClassroomOption().setClassId(mRoomId);  

//3、进入房间
mTicManager.joinClassroom(classroomOption, new TICManager.TICCallback() {  
    @Override  
  public void onSuccess(Object data) {  
        Log.i(TAG,"进入课堂成功:" + mRoomId);  
    }
  
    @Override  
  public void onError(String module, int errCode, String errMsg) {  
       if(errCode == 10015){  
           Log.i(TAG,"课堂不存在:" + mRoomId + " err:" + errCode + " msg:" + errMsg);  
        }  
        else {  
           Log.i(TAG,"进入课堂失败:" + mRoomId + " err:" + errCode + " msg:" + errMsg);
       }
    }
});
```
TICClassroomOption中的 `classId`是课堂ID，`TICClassroomOption`参数说明如下：

| 参数名 | 参数类型 | 参数说明 |
| ------  |-------|-------|
| classId | int | 课堂Id |
| ntpServer | String | 进行时间校验的server，一般不需要修改 |

退出课堂您需要先移除事件监听`removeEventListener`和消息监听`removeMessageListener`，然后退出课堂。课堂内的其他成员将会收到`TICEventListener`中的`onTICMemberQuit`回调。
```java
//1、移除事件监听
    mTicManager.removeIMMessageListener(this);

    //退出课堂
    //如果是老师，可以清除，如果是学生一般是不要清除数据  
    boolean clearBoard = false;

    mTicManager.quitClassroom(clearBoard, new TICManager.TICCallback() {  
    @Override  
	public void onSuccess(Object data) {  
        Log.i(TAG,"quitClassroom#onSuccess: " + data, true);  
    }  
  
    @Override  
	public void onError(String module, int errCode, String errMsg) {  
        Log.i(TAG,"quitClassroom#onError: errCode = " + errCode + "  description " + errMsg);  
    }  
});
```

> 注意：如果用户因为异常退出课堂（如强杀App、异常Crash），课堂内其他成员将不会收到`onTICMemberQuit`回调，由于该成员没有正常退出仍是课堂成员，再次加入课堂时，其他成员将不会收到`onTICMemberJoin`回调。

### 2.3 IM收发消息
TIC封装了`ImSDK`发消息的常用接口，每个发消息接口在`TICMessageListener`监听中都能找到对应的接收消息回调，具体对应关系如下：


| 发送消息接口 | 接收消息回调 | 参数说明 |
| ------  |-------|-------|
| sendTextMessage | onTICRecvTextMessage | 发送和接收C2C文本消息 |
| sendCustomMessage| onTICRecvCustomMessage | 发送和接收C2C自定义消息 |
| sendGroupTextMessage | onTICRecvGroupTextMessage | 发送和接收群文本消息 |
| sendGroupCustomMessage | onTICRecvGroupCustomMessage | 发送和接收群自定义消息 |
| sendMessage | onTICRecvMessage | 透传房间内除白板外的其他消息 |


### 2.4 TRTC视频渲染
如果房间内有成员打开或关闭摄像头，其他成员会收到`TICEventListener`监听中的`onTICUserVideoAvailable`回调，如果房间内有成员打开或关闭屏幕分享，其他成员会收到`TICEventListener`监听中的`onTICUserSubStreamAvailable`回调，您需要在回调中调用`TRTC`的相关方法开启或关闭渲染。

```java
@Override  
public void onTICUserVideoAvailable(final String userId, boolean available) {  
    if (available) {  
        final TXCloudVideoView renderView = mTrtcRootView.onMemberEnter(userId+ TRTCCloudDef.TRTC_VIDEO_STREAM_TYPE_BIG);  
        if (renderView != null) {  
            // 启动远程画面的解码和显示逻辑，FillMode 可以设置是否显示黑边  
            mTrtcCloud.setRemoteViewFillMode(userId, TRTCCloudDef.TRTC_VIDEO_RENDER_MODE_FIT);  
            mTrtcCloud.startRemoteView(userId, renderView);  
            renderView.setUserId(userId+TRTCCloudDef.TRTC_VIDEO_STREAM_TYPE_BIG);  
        }
    } 
    else {  
        mTrtcCloud.stopRemoteView(userId);  
        mTrtcRootView.onMemberLeave(userId+TRTCCloudDef.TRTC_VIDEO_STREAM_TYPE_BIG);  
    }  
}

```
TIC只封装`TXLiteAVSDK_TRTC`进房和退房方法，您可以通过`TICManager`获取`TRTC`实例做更多`TXLiteAVSDK_TRTC`的操作。

```java
//获取TRTC实例
mTrtcCloud = mTicManager.getTRTCClound();
//开启本地渲染（renderView为UIView实例）
mTrtcCloud.startLocalPreview(true,txCloudVideoView);
//关闭本地渲染
mTrtcCloud.stopLocalPreview();
```
以上只列出了`TRTC`常用方法，更多`TRTC`相关内容，请移步到[腾讯云TRTC文档](https://cloud.tencent.com/product/trtc/developer)

### 2.5 使用白板
```java
private void initTEduBoard() {  
    //获取白板对象
    mBoard = mTicManager.getBoard();  

    //生成一个继承于TEduBoardController.TEduBoardCallback事件监听，交给白板对象，用于处理白板事件响应。
    mBoardCallback = new MyBoardCallback(this);  
    mBoard.addCallback(mBoardCallback);  
        
    //初始化具体的参数，包含用户信息、appid，sig值；
    TEduBoardController.TEduBoardAuthParam authParam = new TEduBoardController.TEduBoardAuthParam(Constants.APPID, mUserID, mUserSig);  
        
    //如果用户希望白板显示出来时，不使用系统默认的参数，需要设置特性缺省参数，如是使用默认参数，则填null。
    TEduBoardController.TEduBoardInitParam initParam = new TEduBoardController.TEduBoardInitParam();  
    initParam.brushColor = new TEduBoardController.TEduBoardColor(0, 255, 0, 255);  
    //调用初始化函数
    mBoard.init(authParam, mRoomId, initParam);  
}
```
详细`TEduBoard`相关内容，可以参考[白板接入文档](README_TEduBoard.md)


### 2.6 离线白板录制

| 文件名称 | 说明 | 
|------|-----|
| TICRecorder.java | 录制功能定义 | 


TIC源码进房成功后自动发送离线录制需要的对时消息并上报群组ID，对时消息发送成功您会收到`TICEventListener`的回调`onTICSendOfflineRecordInfo`

注意：
1. demo对时消息ntp时间戳是从腾讯云ntp服务获取，您可以选择搭建自己的ntp服务器
2. 由于IM群消息有可能大于10000，当IM群消息大于10000时，消息会开始丢弃，导致空洞消息。上报群组后，后台判断，当群组中IM消息大于10000时，会自动备份群消息到COS


