
## 1. 对接流程

HTTPS API 说明请参见 [HTTPS API](https://cloud.tencent.com/document/product/569/11609)。
>!其中请求方的 HTTPS 握手协议需是 TLS1.1 及以上的协议，否则链接会不通。

服务商/子商户入驻总流程请参见 [配置文档](https://cloud.tencent.com/document/product/569/18788)。

### 1.1 HTTPS API 交易流程
#### 刷卡支付接入流程（顾客被扫）
![](https://main.qcloudimg.com/raw/455dc6e2451e22163b36c73e5d72f530.png)
- 刷卡支付接口：https://pay.qcloud.com/cpay/micro_pay
- 查询订单接口：https://pay.qcloud.com/cpay/query_order
- 支付结果未知包含网络超时、接口返回的status哪些表示结果未知参考文档说明。
- 接口返回 status为0，只表示业务请求成功，订单的支付结果需要通过订单的状态来判断。
- 如果2分钟内查询不到结果，请到手机端管理系统查看交易明细确认支付结果。

#### 退款接入流程
 ![](https://main.qcloudimg.com/raw/2d7f1d0144a7900dfecdf3aa12605496.png)
- 申请退款成功，并不代表退款成功。
退款是一个异步过程，申请退款成功后，只是代表第三方支付平台受理这笔退款，是否到账需要看这笔钱退到哪里。
 - 如果是退款至微信零钱账户或支付宝账户，会很快到账。
 - 如果是退款至顾客的银行卡，到账时间与银行处理进度相关，可能要花几个小时。
 因此申请退款成功后，需告知顾客，申请退款已经成功，请关注后续到账情况。顾客可以关注微信或支付宝的消息，便能收到已经发起退款或退款到账的消息。
- 如果想在设备上看这笔退款是否到账，可以调用退款查询接口，通过退款单的状态来查看是否退款成功。适配者可以自己选择是否适配退款查询接口。

## 2. 机具配置
### 获取配置二维码
管理员登录手机商户管理系统，找到需要配置的设备，进行如下设置。
![](https://main.qcloudimg.com/raw/59af5d4e3232b958cf9fe69ea6fd3bac.png)
![](https://main.qcloudimg.com/raw/6998d525ee42d0aa8529ad9594d09157.png)
如果不需要配置店员可以单击 继续 跳过这一步。
  
  
注意：
1)	添加设备时，选择移动收款机具或智能POS，只有这2种才可以生成配置二维码。
2)	生成的二维码链接如下：
https://pay.qcloud.com/cpay/use_device_setting?osi=xxxx&si=xxxx，
其中二维码的有效期是5分钟。
3)	当前只有商户管理员能够获取配置二维码。
2.2 机具扫码配置流程图
机具需要支持重复配置，比如配置异常时，可以重新开始配置。
 
说明：
1）扫码配置二维码后，请求后台的url需要增加sn号，获取配置的请求为http get请求。
2）配置二维码，有效期是5分钟，
3）机具配置的开始和结束需要有语音提示。
2.3 请求配置接口说明
2.3.1 请求配置url
GET https://pay.qcloud.com/cpay/use_device_setting?osi=xxxx&si=xxxx&sn=xxxxx
注：是get请求不是post请求。


参数	含义	类型	长度	是否必填	备注
osi	全局门店ID	String	20字节	必填	配置二维码的参数
si	云支付生成的配置ID	String	20字节	必填	配置二维码的参数
sn	机具sn编号	String	厂家自己知道，建议不超过32字节	必填	
2.3.2 请求参数

2.3.3 响应参数
响应是一个json字符串，包含以下字段：
参数	含义	类型	长度	是否一定返回	备注
out_mch_id	云支付服务商号	String	20字节	一定	
out_sub_mch_id	云支付子商户号	String	20字节	一定	
cloud_cashier_id	云支付商户订单前缀	String	8字节	一定	8位纯数字
authen_type	认证类型	Number	--	一定	
authen_key	认证密钥	String	32字节	一定	
out_shop_id	全局门店ID	String	20字节	一定	
shop_name	门店名称	String	不超过128字节	一定	
device_id	设备id	String	不超过64字节	一定	
device_name	设备名称	String	不超过128字节	一定	
staff_id	员工id	String	不超过64字节	不一定	看获取二维码时是否选择了店员
staff_name	员工名称	String	不超过128字节	不一定	看获取二维码时是否选择了店员

## 3. 验收标准
3.1 必须要有的功能
3.1.1 配置
统一在云支付手机端管理系统配置。
3.1.2 连接方式
机具直连云支付。
3.1.3 刷卡支付
	1）需要输入密码，显示“等待用户输入密码中”
	2）支付结果未知，显示“通过订单查询确认支付结果或手机端商户管理系统确认支付结果”
3.1.4 订单退款
	先扫订单条码，再查询订单得到订单总金额，再显示一个订单总金额作为默认的退款金额，如果要部分退款，收银员修改这个金额即可。
3.1.5 订单查询
	商户生成的订单号要短，不然订单条码机具扫不上。
云支付商户有2种订单号前缀，一种是带字符的、10位，如sz0100lmnx；一种是纯数字的、8位，如01000052；建议使用纯数字的8位前缀，这样机具扫描订单条码时很容易扫上。
3.1.6 店员可设置
	店员id可以在机具上设置。
3.1.7 机具可以升级
1）优先在线升级
2）其他升级方式
3.1.8 多域名支持
	机具需要支持多个域名切换；使用/cpay/ping接口去探测域名是否可以使用。云支付一共四个域名。
pay.qcloud.com
sz.pay.qcloud.com
sh.pay.qcloud.com
tj.pay.qcloud.com
	有一种方式， 比如列出4个域名， 选择第一个，如果第一个不行，自动探测第二个，如果第二个不行，自动探测第三个知道选择ok或不ok，然后给出相应的提示语。
	第二种方式，支付的时候自动切换。
3.1.9 支持扫码配置WIFI
	支持扫码配置WIFI。
3.1.10 OrderClient增加sub terminal type字段
	找云支付分配。
3.1.11 支持打印小票
	机具可以连接小票机打印小票。
3.1.12 语音播报
	机具支持语音播报。
3.1.13 机具操作手册
厂商提供服务商使用机具的操作手册。
3.2 可选择的功能
	如果机具没有提供下面两个功能，收银员可以在手机端商户管理系统去查看交易流水和汇总。
3.2.1 交易流水
	支付流水、退款流水。
3.2.2 汇总统计
3.2.3 语音区分支付平台
微信支付收款成功、支付宝收款成功。
## 4. 测试用例及注意事项
4.1 刷卡支付
	微信支付0.02，支付宝支付0.02。其他金额也测试下。
	测试用户输入密码的情形（正常情况下，账号当日支付超过10笔开始要求输入密码）。
	注意边界情况：
	1）不能语音播报超时但用户支付成功。
	2）支付金额0（包括输入0.001等四舍五入后为0的）应在机具层面拦截下，提示用户。
4.2 退款和查单
	下面流程对微信支付、支付宝分别测试：
	1）支付0.02，应支付成功；
	2）扫订单号条码，应显示支付成功；
	3）退款0.03（应当在机具层拦截，并提示超过可退金额）；
	4）继续退款0.01，应该退款成功；
	5）扫订单号条码，应该显示订单状态为已部分退款；
	6）继续退款0.02，应拦截并提示超过可退金额；
	7）继续退款0.01，应退款成功；
	8）扫订单号，订单状态应显示已全额退款。

	【注意】对支付宝订单而言，current_trade_state字段只有全额退款的时候才会变成4，否者一直是2（成功），所以不能通过query_order接口判断支付宝订单是否发生过部分退款，使用client_order_detail查订单能得到订单的refunded_fee值，才能判断是否已经部分退款。但client_order_detail接口目前（后续优化进行中）返回报文大小可能超过10k，25k大小也会出现，注意机具的处理能力，防止死机。
4.3 语音播报
	支付和退款都能正确播报平台和金额。注意应该播报用户需要的结果信息，而不是播报“成功”或者“查询成功”。
4.4 其他
必须正确填写sub_terminal_type字段。每个品牌机具取值区间请找云支付分配，请勿随意填写或不填。
