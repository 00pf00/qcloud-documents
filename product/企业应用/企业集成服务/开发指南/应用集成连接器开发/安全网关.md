

## 安全网关介绍

安全网关是为了实现鹊桥iPaaS与用户内网服务集成互通而创新设计的代理系统，主要应用场景为：用户内网服务不提供公网访问，而又希望通过鹊桥iPaaS服务(公有云部署)来完成与内网服务的集成。安全网关由Server和Agent构成，Server部署在鹊桥iPaaS系统内网，用户无需关注；Agent部署在用户内网，允许根据地域/服务划分，部署多个Agent。通过安全网关转发来实现鹊桥iPaaS与用户内网服务的数据交互。




## 配置 Agent 代理程序包 

### 步骤1：下载 Agent 代理程序包[](id:agent)

- 登录腾讯云[企业集成服务控制台](https://console.cloud.tencent.com/eis)，选择安全网关功能菜单
- 新建安全网关，参考[如何生成代理证书]()上传证书，配置好Server，点击保存
- 在安全网关列表中点击下载代理程序按钮，下载Agent代理程序包
- Agent代理程序包解压后目录结构如下：
  - bin目录中包含Agent的可执行程序，按照不同的操作系统放在子目录Linux、Windows、Mac下
  - configs目录中包含Agent运行过程中所必须的配置，configs目录介绍：
    - client中存放Agent tls通信所必须的密钥等配置，与Server对应，此目录下文件**不可删除，不可修改**
    - secret目录下存放Agent连接Server时的数据签名密钥，密钥如何生成请参考[如何生成代理证书]()
    - config.yaml文件中包含Agent运行过程中必须依赖的配置
    - logger_config.yaml 文件中包含Agent运行过程中的日志配置，**可修改日志级别及日志备份策略**
  - log中存放Agent运行过程中产生的日志
  - scripts目录存放Agent启动/停止脚本(start.sh/stop.sh)

### 步骤2：Agent 日志配置

修改 Agent 代理程序包ipaas-private-cloud-agent/configs目录下的logger_config.yaml文件，可以按需修改网关日志级别/日志备份策略等，logger_config.yaml中各参数含义在文件中已做详细说明，在此不再赘述。

### 步骤3：启用 Agent

按当前操作系统执行相应的启动脚本：

<dx-tabs>
::: Mac\s系统
<dx-codeblock>
:::  plaintext
./ipaas-private-cloud-agent/scripts/mac/start.sh
:::
</dx-codeblock>
:::
::: Linux\s系统
<dx-codeblock>
:::  plaintext
./ipaas-private-cloud-agent/scripts/linux/start.sh
:::
</dx-codeblock>
:::
::: Windows\s系统
<dx-codeblock>
:::  plaintext
./ipaas-private-cloud-agent/scripts/windows/start.bat
:::
</dx-codeblock>
:::
</dx-tabs>



### 2.4 禁用 Agent

按当前操作系统执行相应的禁用脚本：


<dx-tabs>
::: Mac\s系统
<dx-codeblock>
:::  plaintext
./ipaas-private-cloud-agent/scripts/stop.sh
:::
</dx-codeblock>
:::
::: Linux\s系统
<dx-codeblock>
:::  plaintext
./ipaas-private-cloud-agent/scripts/linux/stop.sh
:::
</dx-codeblock>
:::
::: Windows\s系统
<dx-codeblock>
:::  plaintext
./ipaas-private-cloud-agent/scripts/windows/stop.bat
:::
</dx-codeblock>
:::
</dx-tabs>




## 生成代理证书[](id:certificate)

### 步骤1：检查 Openssl 版本信息

检查系统是否已安装openssl，命令如下:

```
openssl version
```

执行命令如果能正常输出openssl版本信息，说明系统已安装openssl，可跳过openssl安装步骤。

### 步骤2：安装 Openssl

 openssl mac/unix/windows安装方式不同




<dx-tabs>
::: Mac\s系统
<dx-codeblock>
:::  plaintext
brew install openssl
:::
</dx-codeblock>
:::
::: Linux\s系统
**Centos**
<dx-codeblock>
:::  plaintext
  yum install openssl
:::
</dx-codeblock>
**Ubuntu**
<dx-codeblock>
:::  plaintext
  sudo apt-get install openssl 
  sudo apt-get install libssl-dev
:::
</dx-codeblock>
:::
::: Windows\s系统
<dx-codeblock>
:::  plaintext
./ipaas-private-cloud-agent/scripts/windows/stop.bat
:::
</dx-codeblock>
:::
</dx-tabs>






- #### Windows系统

  - 下载安装openssl安装包，点击[这里](http://slproweb.com/products/Win32OpenSSL.html)选择不同的安装包下载。例如64位的系统，则选择如图所示的安装包下载（选择light版本即可）

    ![windows下载openssl](/Users/eatonhan/Desktop/iPaaS/产品迭代/企业集成服务文档更新/安全网关图片/windows下载openssl.png)

  - openssl安装，一直点击next即可，注意记录openssl的安装目录（**后续openssl配置环境变量时需要用到**）

  - 配置环境变量， 以win10系统为例：

    - 打开属性，选择高级系统设置

      ![选择高级系统配置](/Users/eatonhan/Desktop/iPaaS/产品迭代/企业集成服务文档更新/安全网关图片/选择高级系统配置.png)

    - 选择环境变量

      ![选择环境变量](/Users/eatonhan/Desktop/iPaaS/产品迭代/企业集成服务文档更新/安全网关图片/选择环境变量.png)

    - 双击Path

      ![双击Path](/Users/eatonhan/Desktop/iPaaS/产品迭代/企业集成服务文档更新/安全网关图片/双击Path.png)

    - 点击新建，在左侧变量中新增openssl的安装路径

      ![新增安装路径](/Users/eatonhan/Desktop/iPaaS/产品迭代/企业集成服务文档更新/安全网关图片/新增安装路径.png)

  - 安装验证

    打开命令行窗口，执行：openssl version，如果出现以下内容，则说明openssl安装成功，否则仔细核对openssl安装步骤

    ![安装成功](/Users/eatonhan/Desktop/iPaaS/产品迭代/企业集成服务文档更新/安全网关图片/安装成功.png)

### 3.3 生成及更新证书

- 生成私钥，**注意：请将生成的私钥放置在ipaas-private-cloud-agent/configs/secret目录下**

```
openssl genrsa -out private.pem 1024
```

- 生成公钥

以3.3生成的private.pem私钥作为基础，生成公钥，当前目录下生成的公钥为安全网关证书

```
openssl rsa -in private.pem -RSAPublicKey_out -out public.pem
```

- 生成新的证书时，需替换ipaas-private-cloud-agent/configs/secret目录下的pem文件

