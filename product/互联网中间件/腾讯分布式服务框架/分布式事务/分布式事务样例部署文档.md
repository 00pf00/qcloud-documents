## 业务场景
本样例是常见的一个线上的代金券/现金协同购物场景。在进行购物的时候，消费用户可以通过使用代金券来抵消一部分的现金费用：用户在消费的时候出示一张2元的代金券，在购买价值20元的物品的时候，只需要从微信钱包中支付18元即可。
在整个购物事务场景中，假设涉及三个的不同子服务：代金券服务、微信钱包服务以及商家账务服务。各个子服务部署在不同的节点上，使用不同的数据库。本样例展示了如何使用 TCC 来完成一次跨服务/跨数据库的分布式事务。

## 样例模块说明
- [下载样例](https://main.qcloudimg.com/raw/5b00527cdda6e84b463655e3ae742b9c.7z)

下载 Demo 样例工程之后，进行解压，项目结构如下：
```
tcc-transaction-sample
   |__lib
   |__sample-tcc-consumer
   |__sample-tcc-couponService
   |__sample-tcc-mainService
   |__sample-tcc-transferService
   |__sample-tcc-walletService
   |__init_database.sql
```

**lib**：分布式事务需要依赖的 jar 包。
**sample-tcc-consumer**：消费用户 Client，发起购物事务。
**sample-tcc-couponService**：代金券子服务，处理代金券使用流程。
**sample-tcc-walletService**：微信钱包子服务，处理消费用户钱包消费流程。
**sample-tcc-transferService**：商家账务子服务，转账给对应商家。
**sample-tcc-mainService**：购物服务，购物事务入口，协调执行3个子服务。
**init_database.sql**：初始化样例。

## 样例本地构建方法
1. 在本地 Maven 仓库安装 SDK。进入解压后的 lib 目录，执行如下命令：
```
mvn install:install-file -Dfile=tsf-transaction-core-0.0.5-SNAPSHOT.jar -DpomFile=tsf-transaction-core-0.0.5-SNAPSHOT.pom  -DgroupId=com.tencent.tsf.transaction -DartifactId=tsf-transaction-core -Dversion=0.0.5-SNAPSHOT -Dpackaging=jar
```
2. 在 MySQL 中创建名称为 demo 的库，使用 init_database.sql 创建数据库。
登录 MySQL，执行如下命令：
```
create database demo;
use database demo;
source init_database.sql
```
3. 在本地安装 Consul，使用 agent 模式运行 consul：
 从本页面下载 Windows 版本 Consul，在CMD命令行中输入`consul agent -dev`，以 agent 模式启动 Consul。
4. 在各个子模块中的`src/main/java/resources/application.yml`，配置 yml 文件，示例如下：
```
spring:
application:
	name: consumerApp
datasource:
  url: jdbc:mysql://127.0.0.1:3306/demo
  username: root
  password: root
cloud:
  consul:
    host: 127.0.0.1
	port: 8500
	discovery:
	  heartbeat:
	  enabled: true
	  ttl-value: 5
	  ttl-unit: s
	preferIpAddress: true
	instanceId: ${spring.application.name}:${random.value}
server:
  tomcat:
	basedir: servlet
  port: 8079
  address: 0.0.0.0
```
只需要按照实际情况修改 datasource 和 Consul 的地址、端口以及用户名密码即可。
5. 依次启动 CouponApp、TransferApp、WalletApp、App、ConsumerApp。
6. 在安装了 mainService 的机器上通过 HTTP 请求 mainService：
```
curl -X POST \
http://localhost:8083/api/v6/data/serviceBuy/buy \
-H 'Cache-Control: no-cache' \
-H 'Content-Type: application/json' \
-H 'Postman-Token: 24c04685-8bd2-43b2-9f4a-0b1129524931' \
-d '{
"couponId" : "1000",
"userId" : "1",
"merchantId" : "2",
"money" : "20",
"couponValue" : "5"}'
```
其中 IP 和 port 以实际配置为准。

## 公有云构建方法
1. 下载 Demo 压缩包并解压，进入 lib 目录，lib 目录结构如下：
```
  lib
   |__couponService
   |__mainService
   |__transferService
   |__walletService
```
每个目录下有对应服务的 jar 包和配置文件。
2. 在公有云上申请机器，并且按照 couponService、transferService、walletService、mainService 的顺序部署应用。
3. 在 mainService 上安装 MySQL 和 ubuntu 服务器：
```
sudo apt-get install mysql-server
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf //修改bind-address为0.0.0.0
service mysql restart
```
4. 配置 MySQL 远程登录权限,并初始化数据库：
```
mysql -u root
grant all privileges  on *.* to root@'%' identified by "root";
create database demo;
use demo;
source init_database.sql
```
5. 部署完毕后，登录到服务所在的各个机器上，把对应的配置文件放在`/root/tsf-agent/exec/now`目录下，并且根据实际环境填写 MySQL 和 Consul 的配置项信息，重启应用。
6. 在安装了 mainService 的机器上通过 HTTP 请求 mainService：
```
curl -X POST \
http://localhost:8083/api/v6/data/serviceBuy/buy \
-H 'Cache-Control: no-cache' \
-H 'Content-Type: application/json' \
-H 'Postman-Token: 24c04685-8bd2-43b2-9f4a-0b1129524931' \
-d '{
"couponId" : "1000",
"userId" : "1",
"merchantId" : "2",
"money" : "20",
"couponValue" : "5"}'
```
