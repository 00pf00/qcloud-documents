当应用在滚动发布时，应用实例下线后向注册中心注销实例信息，服务调用方在监听到实例下线更新本地服务实例列表期间仍会将流量分发到已经下线的服务实例，造成业务异常。因此在应用滚动发布过程中，可以通过调整部署组滚动发布更新配置达到业务无中断优雅下线的目的。

## 场景说明
当容器应用进行滚动更新时，provider实例接受到实例下线通知，向注册中心注销实例信息后实例下线此时实例下线的变更并未推送至consumer，consumer会向已经下线的实例正常发起业务调用，造成业务异常。

当启动容器服务滚动发布优雅下线配置后，TSF会先启动一个provider实例向服务注册中心注册实例，而后向下线实例发送下线通知注销实例，带consumer将流量路由到新上线实例后在进行原有实例的服务下线，保障滚动发布升级时服务无中断。

![](https://main.qcloudimg.com/raw/ac0b95afa1321a9f9d8b9a353fca395a.png)

## 前提条件
- 目前仅支持集群类型为容器集群对应的部署组应用的服务优雅下线操作

## 操作步骤
1. 登录 [TSF 控制台](https://console.cloud.tencent.com/tsf)。

2. 在左侧导航栏中，单击【[应用管理](https://console.cloud.tencent.com/tsf/app)】，进入应用列表页，筛选应用点击 应用ID 。

3. 单击顶部【部署组】，在选择指定的部署组，在操作列表中点击 部署应用。

4. 点击 【展开高级选项设置】配置滚动发布策略

   **配置更新方式**：滚动更新。滚动更新会在应用发布时按照更新策略启动新实例销毁旧实例，在整个发布过程中保证实例数一致。

   **更新间隔**：120秒。更新间隔设置为120s，提供服务下线实例的注册信息注销更新缓冲时间。

   **更新策略**：启动新的pod，停止旧的pod。选择该策略则先启动新实例完成流量导入后再删除旧势力

   **策略配置**：pods数为1，选择pods数为1则每次更新则先启动一个新实例，再下线一个旧势实例。

   ![](https://main.qcloudimg.com/raw/866f0e59ab3b0ff11938051d86e7f387.png)

## 使用说明
在真实使用场景中，有以下几点需要注意：
- 当前用户部署组的pod被 kill 不会触发优雅下线的逻辑。
- 已经运行的部署组，需要通过TSF进行重新部署操作后才具备优雅下线能力

  
