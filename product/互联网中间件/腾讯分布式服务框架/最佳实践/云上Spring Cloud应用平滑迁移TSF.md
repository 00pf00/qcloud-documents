## 操作场景
该任务指导您将自有集群的应用服务平滑迁移至 TSF，并在迁移过程中确保服务正常的注册发现。

当您的 Spring Cloud 应用集群已经部署在云上的生产环境并承接业务流量，同时您想将 Spring Cloud 应用迁移至 TSF 享受一站式的微服务框架解决方案，在迁移过程中保障业务流量不中断，完全实现对业务用户的透明访问即为平滑迁移。

## 前提条件
您已经将 Spring Cloud 应用部署在腾讯云上。

## 迁移价值
- TSF 为您提供一站式应用生命周期管理服务。提供从部署应用到运行应用的全程管理，包括创建、删除、部署、回滚、扩容、下线、启动和停止应用。通过部署组来实现应用的版本控制功能，并将每次操作变更进行记录，方便您对每次应用发布进行跟踪回溯。
- TSF 为您提供高效的服务注册发现能力。支持秒级的服务注册发现能力并提供本地注册信息缓存、服务实例注册发现异常告警、注册中心跨AZ区容灾等完善的注册中心高可用保障机制为您的应用服务保驾护航。
- TSF 为您提供细粒度服务治理能力。支持服务级和 API 级别的服务治理能力，您可以通过控制台配置服务路由、服务限流、服务鉴权、服务熔断规则，并通过配置、权重标签的形式进行细粒度的流量控制，实现灰度发布、就近路由、熔断限流、服务容错、访问鉴权等功能。
- TSF 为您提供立体化应用数据运营。提供完善应用性能指标监控和分布式调用链分析、服务依赖拓扑、日志服务工具，帮助您准确掌控应用上线后的运行状况，高效分析应用性能瓶颈及故障问题排查。
- TSF 为您提供灵活的分布式配置管理能力，包括应用配置、全局配置和文件配置。您可以通过控制台进行分布式配置版本管理、发布配置到部署组或者命名空间范围内的实例。

## 迁移方案

为保障应用迁移过程中流量不中断，您可以通过**切流迁移**和迁移实例的**双注册发现迁移**两种方式实现平滑迁移。具体方案如下：

### 切流迁移方案

- **实现方法**：业务应用需要全量改造后在 TSF 集群全量部署，应用全部改造上线后通过切换域名配置将域名指向新集群的 CLB 服务均衡地址实现流量切换。

- **方案优点**：操作简单，原有应用集群和 TSF 集群不存在相互影响。

- **方案缺点**：需要同时保持两套集群同时运行存在资源浪费；此外，由于是全量迁移，迁移过程中存在业务异常的概率较大。
<img src="https://main.qcloudimg.com/raw/be6ba70d616b9fdd551210ab6b4465eb.png" style="zoom:50%;" />


### 双注册发现方案

- **方案说明**：您仅需要将迁移的应用通过引入 TSF 组件依赖并进行双注册中心服务注册订阅配置，将改造后的应用通过 TSF 进行部署，部署后的 Spring Cloud 应用即可被原应用集群和 TSF 集群中的服务发现，正常进行服务调用。

- **方案优点**：
	- 改造量小，仅需引入 TSF 组件依赖并进行完成配置操作，无需改动代码即可实现双注册发现能力。
	- 在迁移过程中实现已迁移应用与未迁移应用的互相发现，实现服务调用，有效保障业务连续性。
	- 此外整体服务迁移完成后，通过TSF提供配置管理能力可动态变更服务注册发现策略，无需重启应用即可完成迁移。
	- 迁移后的应用优先调用TSF内的服务实例，避免跨集群调用产生性能损耗。

>?目前TSF支持原有注册中心引擎为 Eureka、Zookeeper、Consul 与 TSF 注册中心引擎的双注册发现能力。

![](https://main.qcloudimg.com/raw/57b9e0414034af40f1cee3278160d647.png)

## 操作步骤
1. 在迁移的服务应用的 pom.xml 文件中引入 TSF 依赖：
```java
<dependency>
		<groupId>com.tencent.tsf</groupId>
		<artifactId>spring-cloud-tsf-dependencies</artifactId>
		<version>1.24.0-Finchley-RELEASE</version>
</dependency>
```
2. 在`application.properties` 中添加双注册发现配置。
其中，exclude 代表不注册到的哪些服务注册中心引擎；subscribes 代表从哪些服务注册引擎进行服务发现。
```java
   tsf:
     migration:
       registry:
         // 不注册到ZOOKEEPER
         excludes: ZOOKEEPER
         // 从EUREKA、TSF进行服务发现
       subscribes:
         - EUREKA
         - TSF
```
3. 将应用打包。
登录 [TSF 控制台](https://console.cloud.tencent.com/tsf/index?rid=4)，参照 [应用管理](https://cloud.tencent.com/document/product/649/16931) 完成应用发布。
4. 验证结果。
通过原有集群服务调用可发现服务是否正常，此外在【应用中心】>【服务治理】查看应用发布地域及命名空间查看是否存在服务信息，如果服务注册正常则具有该微服务名称、状态、运行实例、请求量等信息。
5. 在以上应用验证成功后，可逐步其他应用。
6. 清理迁移配置。
迁移完成后，登录 [TSF 控制台](https://console.cloud.tencent.com/tsf/index?rid=4)，参照 [配置管理](https://cloud.tencent.com/document/product/649/17956) 动态变更服务注册发现方式，将原有集群的注册中心配置移除。





