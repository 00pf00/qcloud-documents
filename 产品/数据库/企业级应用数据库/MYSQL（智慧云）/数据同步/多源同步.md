# 数据同步
## 多源同步
多源同步提供TDSQL到TDSQL，TDSQL到MySQL，TDSQL到Oracle之间的3种同步方案。
### TDSQL同步到TDSQL
## 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【数据同步】>【多源同步】进入多源同步界面。
2. 点击【创建TDSQL同步】，系统弹出【创建多源同步任务】对话框，系统默认进入【任务初始化】子菜单。
 - 【任务名称】：填写同步任务名称。
 - 【所在集群】、【实例】，填写源和目标实例集群和名称。
 - 【全量同步类型】、【超时时间】、【消费者线程数】、【镜像文件目录】：使用默认值，无需修改。
 - 【源实例大小写敏感】、【以整库方式全量同步】：无需勾选。
 - 【是否开启DDL同步】：根据需要设置，选择是否需要开启DDL同步。
3. 点击【下一步】，进入【选择库列表】子菜单。
4. 选择表名匹配模式。
若选择【全量匹配】不需填写数据匹配库，【精准匹配】和【正则匹配】需填写数据匹配库。
>!进行设置时，请详细阅读菜单下方的【TDSQL与TDSQL的同步规则】说明。
5. 点击【下一步】，设置数据效验（默认关闭）。
6. 点击【开始创建】，进入【多源同步任务规则匹配详情】页面，查看源实例与目标实例的各项指标同步情况。
进行实例同步时会出现同步短暂延迟，该延迟为正在进行同步的时间，当延迟下降到个位数，说明同步已完成。可以通过查看源端表和目标端表来验证。
7. 都通过后，点击【立即开启】退出多源同步设置界面。

### TDSQL同步到其他数据库
TDSQL实例数据可同步到MySQL或Oracle数据库。
## 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【数据同步】>【多源同步】进入多源同步界面。
2. 点击【创建其他数据库同步】，系统弹出【创建多源同步到其他数据库任务】对话框，默认进入【任务初始化】子菜单。
 - 【任务名称】：填写同步任务名称。
源实例信息：
 - 【所在集群】、【实例】，填写源标实例集群和名称。
目标实例信息：
 - 【实例类型】：选择目标实例。
 - 【实例名称】：输入目标实例ID或账户DB信息。
 - 【主机ip_port】：输入目标主机IP和数据端口号，注意书写格式。
 - 【账号】、【密码】：输入目标数据库用户名称和密码。
 - 【全量同步类型】、【超时时间】、【消费者线程数】、【镜像文件目录】：使用默认值，无需修改。
 - 【源实例大小写敏感】、【以整库方式全量同步】：无需勾选。
 - 【是否开启DDL同步】：根据需要设置，选择是否需要开启DDL同步。
3. 点击【下一步】，进入【选择库列表】子菜单。
4. 选择表名匹配模式。
若选择【全量匹配】不需填写数据匹配库，【精准匹配】和【正则匹配】需填写数据匹配库。
>!进行设置时，请详细阅读菜单下方的【TDSQL与TDSQL的同步规则】说明。
5. 点击【下一步】，设置数据效验（默认关闭）。
6. 点击【开始创建】，进入【多源同步任务规则匹配详情】页面，查看源实例与目标实例的各项指标同步情况。
进行实例同步时会出现同步短暂延迟，该延迟为正在进行同步的时间，当延迟下降到个位数，说明同步已完成。可以通过查看源端表和目标端表来验证。
7. 都通过后，点击【立即开启】退出多源同步设置界面。

### 多源同步开启DDL同步
## 背景介绍
多源同步默认不支持开启DDL同步，只会同步数据的变化。如果源端的表结构变化，那么将同步报错。此时可以手动在目标端修改对应表结构，或者开启DDL同步功能。 
## 操作步骤
1. 在赤兔系统管理台，点击【数据同步】>【多源同步】>【创建TDSQL同步】或【创建其他数据库同步】>【创建多源同步数据库任务】>【任务初始化】>设置【是否开启DDL同步】，具体操作详见“8.1多源同步”。
>!该修改只对之前已经创建的同步任务生效，且只能同步源端的表结构变化。如果是目标端的表结构变化，则需手动修改

## DCN同步
可将主、备机房分别部署的TDSQL数据库建立DCN同步关系。
 - 建立DCN同步关系前的主备集群注意事项
  - 主备集群创建实例时，应确保主、备实例的数据库版本、字符集编码、排序规则、大小写敏感、innodb_page_size等参数项一致。
  - 确保主备集群中实例数量一一对应。
  - 确保在主备集群所有分布式实例（Groupshrad）中实例的分片（Set）数量都有对应关系。 
例如，在IDC1主机房中，添加IDC2备机房部署的TDSQL集群，并建立DCN同步关系。

## 操作步骤
1. 将IDC2（备）机房部署的TDSQL集群添加到IDC1（主）机房中。
2. 在赤兔管理台主界面，点击【集群管理】>【集群设置】>【接入新集群+】，系统弹出【接入新集群】对话框。
3. 输入IDC2备机房集群相关信息。
 - 【集群名称】：输入集群名称。
 - 【集群Key】：为系统自动分配。
 - 【集群操作接口】：为集群OSS组件部署地址。
 - 【集群类型】：选择集群部署架构方式，选择Proxy和DB合并部署在一台物理机中，或分别部署在不同物理机中。
 - 【监控数据库源配置】：填写实际安装信息。
 - 【监控数据库存储DB配置】：填写实际安装信息。
4. 信息填写完成后，点击【保存】，系统进入接入新集群详情页面，可以查看集群接入进度和结果。
5. 在集群中创建实例。
实例创建方法详见“4.1创建实例”。
6. 主备实例建立DCN同步关系。 将IDC1（主）机房、IDC2（备）机房集群中，对应的主、备实例创建DCN同步关系。
 1. 在赤兔管理台主界面，点击【数据同步】>【DCN同步】>【创建DCN同步】，系统弹出【创建DCN同步】对话框。
 1. 选择需建立DCN同步关系的主、备集群和主、备实例。
 1. 点击【确定】退出对话框，进入任务流程页面，查看DCN同步进度和结果。
    -  故障切换
当IDC1（主）机房故障后，需要业务层更改连接到IDC2（备）机房中的备集群，或者自行维护更改DNS映射关系。
